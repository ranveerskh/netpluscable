<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Net + Cable • Admin</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121831;--ink:#e7ecff;
      --muted:#9aa7d9;--accent:#6a8cff;--accent2:#8a5bff;
      --danger:#ff647c;--ok:#35d0a7;--border:#23305b;--warn:#ffc857;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink);}
    h2{margin:20px 0 10px}
    .topbar{display:flex;gap:10px;padding:10px;flex-wrap:wrap;background:#121831;position:sticky;top:0;z-index:1000}
    .topbar a{padding:8px 14px;border-radius:6px;text-decoration:none;font-weight:600;color:#fff;background:var(--accent);}
    .container{padding:20px;max-width:1100px;margin:auto}
    .section{background:var(--card);padding:15px 20px;border-radius:8px;margin-bottom:20px}
    .section h2{margin-top:0}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
    .kpi{background:#0f1530;padding:15px;border-radius:8px}
    .kpi .val{font-size:22px;font-weight:600}
    .kpi .sub{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    thead{background:#0f1530}
    input,select,textarea,button{background:#0f1530;color:#fff;border:1px solid var(--border);border-radius:6px;padding:8px}
    button{cursor:pointer;background:var(--accent);border:none}
    button.danger{background:var(--danger)}
    .form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .form-row input{flex:1}
  </style>
</head>
<body>
  <!-- Quick Links -->
  <div class="topbar">
    <a href="https://beta.gpanel.me/login" target="_blank">Glow TV</a>
    <a href="https://fast4k.cc/login" target="_blank">Smart4k TV</a>
    <a href="data.html" target="_blank">User Data</a>
  </div>

  <div class="container">

    <!-- KPI + Visitors -->
    <div class="section">
      <h2>Visitors</h2>
      <div class="form-row">
        <select id="range">
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="1y">Last 1 Year</option>
          <option value="all">Lifetime</option>
        </select>
        <input id="visSearch" placeholder="Search visitors…"/>
        <button id="visRefresh">Refresh</button>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="sub">Unique Viewer-Days</div><div class="val" id="kpiVisitors">—</div></div>
        <div class="kpi"><div class="sub">New Visitors (latest 10)</div><div class="val" id="kpiLatest">—</div></div>
        <div class="kpi"><div class="sub">Top Interest</div><div class="val" id="kpiInterest">—</div></div>
        <div class="kpi"><div class="sub">Timezone Mix</div><div class="val" id="kpiTZ">—</div></div>
      </div>
      <table id="visitorsTable">
        <thead><tr>
          <th>Time</th><th>VID</th><th>Date</th><th>First Path</th><th>Referrer</th><th>UA</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Banners -->
    <div class="section">
      <h2>Banners</h2>
      <div class="form-row">
        <input id="bannerImg" placeholder="Image URL"/>
        <input id="bannerLink" placeholder="Click Link"/>
        <button id="bannerAdd">Add Banner</button>
      </div>
      <table id="bannerTable"><thead><tr><th>Image</th><th>Link</th><th></th></tr></thead><tbody></tbody></table>
    </div>

    <!-- Gallery -->
    <div class="section">
      <h2>Gallery</h2>
      <div class="form-row">
        <input id="galImg" placeholder="Image URL"/>
        <input id="galName" placeholder="Name"/>
        <button id="galAdd">Add</button>
      </div>
      <table id="galTable"><thead><tr><th>Image</th><th>Name</th><th></th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
      authDomain: "netplustv-90b29.firebaseapp.com",
      projectId: "netplustv-90b29",
      storageBucket: "netplustv-90b29.firebasestorage.app",
      messagingSenderId: "639722274355",
      appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = s=>document.querySelector(s);

    /* ===== Visitors ===== */
    let visCache = [];

    function rangeToStart(range){
      const now = new Date();
      if(range==='7d') return new Date(now.getTime()-7*24*3600*1000);
      if(range==='30d') return new Date(now.getTime()-30*24*3600*1000);
      if(range==='1y') return new Date(now.getTime()-365*24*3600*1000);
      return null;
    }

    async function loadVisitors(){
      const rg = $('#range').value;
      const start = rangeToStart(rg);
      const snap = await getDocs(query(collection(db,'visitors_daily'), orderBy('createdAt','desc'), limit(200)));
      visCache = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .filter(r=>{
          const t = r.createdAt?.toDate?.() || null;
          return !start || (t && t>=start);
        });
    }

    function renderKPIs(){
      $('#kpiVisitors').textContent = String(visCache.length);
      $('#kpiLatest').textContent = String(Math.min(10, visCache.length));
      $('#kpiInterest').textContent = '—';
      $('#kpiTZ').textContent = (() => {
        const tzs = {};
        visCache.forEach(v=>{ if(v.tz){ tzs[v.tz]=(tzs[v.tz]||0)+1; }});
        const top = Object.entries(tzs).sort((a,b)=>b[1]-a[1])[0];
        return top ? `${top[0]} (${top[1]})` : '—';
      })();
    }

    function renderVisitors(){
      const term = ($('#visSearch').value||'').toLowerCase();
      const rows = visCache.filter(r=>{
        const text = [r.vid, r.firstPath, r.firstReferrer].map(v=>String(v||'').toLowerCase()).join(' ');
        return !term || text.includes(term);
      });
      const latest10 = rows.slice(0,10);
      const tb = $('#visitorsTable tbody'); tb.innerHTML='';
      latest10.forEach(r=>{
        const ts = r.createdAt?.toDate?.() || null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ts?ts.toLocaleString():''}</td>
          <td class="sub">${r.vid||''}</td>
          <td>${r.date||''}</td>
          <td class="sub">${(r.firstPath||'').slice(0,40)}${(r.firstPath||'').length>40?'…':''}</td>
          <td class="sub">${(r.firstReferrer||'').slice(0,40)}${(r.firstReferrer||'').length>40?'…':''}</td>
          <td class="sub">${(r.ua||'').slice(0,60)}${(r.ua||'').length>60?'…':''}</td>
        `;
        tb.appendChild(tr);
      });
    }

    $('#visRefresh').addEventListener('click', async ()=>{ await loadVisitors(); renderKPIs(); renderVisitors(); });
    $('#visSearch').addEventListener('input', renderVisitors);
    $('#range').addEventListener('change', async ()=>{ await loadVisitors(); renderKPIs(); renderVisitors(); });

    /* ===== Banners ===== */
    async function loadBanners(){
      const snap = await getDocs(query(collection(db,'banners'), orderBy('createdAt','desc')));
      const tb = $('#bannerTable tbody'); tb.innerHTML='';
      snap.forEach(docSnap=>{
        const r=docSnap.data();
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><img src="${r.img}" style="max-height:40px"></td>
                      <td class="sub">${r.link||''}</td>
                      <td><button class="danger" data-id="${docSnap.id}">Delete</button></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button').forEach(btn=>btn.onclick=async()=>{
        await deleteDoc(doc(db,'banners',btn.dataset.id));
        loadBanners();
      });
    }
    $('#bannerAdd').onclick=async()=>{
      await addDoc(collection(db,'banners'),{img:$('#bannerImg').value,link:$('#bannerLink').value,createdAt:serverTimestamp()});
      $('#bannerImg').value='';$('#bannerLink').value='';
      loadBanners();
    };

    /* ===== Gallery ===== */
    async function loadGallery(){
      const snap = await getDocs(query(collection(db,'gallery'), orderBy('createdAt','desc')));
      const tb=$('#galTable tbody'); tb.innerHTML='';
      snap.forEach(docSnap=>{
        const r=docSnap.data();
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><img src="${r.img}" style="max-height:40px"></td>
                      <td class="sub">${r.name||''}</td>
                      <td><button class="danger" data-id="${docSnap.id}">Delete</button></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button').forEach(btn=>btn.onclick=async()=>{
        await deleteDoc(doc(db,'gallery',btn.dataset.id));
        loadGallery();
      });
    }
    $('#galAdd').onclick=async()=>{
      await addDoc(collection(db,'gallery'),{img:$('#galImg').value,name:$('#galName').value,createdAt:serverTimestamp()});
      $('#galImg').value='';$('#galName').value='';
      loadGallery();
    };

    /* ===== Init ===== */
    async function refreshAll(){ await Promise.all([loadVisitors(), loadBanners(), loadGallery()]); renderKPIs(); renderVisitors(); }
    refreshAll();
  </script>
</body>
</html>