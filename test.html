<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1" />
<title>net+TV — Admin</title>
<meta name="theme-color" content="#0b1020" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Net + Cable • Admin</title>
<style>
  :root{--bg:#0b1020;--ink:#e9edff;--muted:#a9b5e6;--card:#121831;--line:#23305b;--g1:#6a11cb;--g2:#2575fc;--ok:#31d296;--bad:#ff7b7b;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink)}
  a{color:inherit}
  .top{position:sticky;top:0;z-index:30;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(11,16,32,.95),rgba(11,16,32,.7));backdrop-filter:blur(8px)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:9px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.06);cursor:pointer}
  .btn.primary{background:linear-gradient(135deg, rgba(106,17,203,.45), rgba(37,117,252,.45));border-color:#3b4f8f}
  .btn.link{background:linear-gradient(135deg, rgba(106,17,203,.25), rgba(37,117,252,.25))}
  .muted{color:var(--muted);font-size:12px}
  .success{color:var(--ok)} .danger{color:var(--bad)}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:1fr 1fr 1fr}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{width:100%;padding:11px;border-radius:12px;border:1px solid var(--line);background:#0f1430;color:#fff}
  textarea{min-height:86px}
  .card{border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.04);padding:16px;box-shadow:var(--shadow)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.06);cursor:pointer}
  .tab.active{background:linear-gradient(135deg,rgba(106,17,203,.18),rgba(37,117,252,.18))}
  .list{display:grid;gap:10px}
  .item{border:1px dashed var(--line);border-radius:12px;padding:10px}
  .split{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .right{display:flex;gap:6px;align-items:center}
  .mini{font-size:12px}
  .tag{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:linear-gradient(135deg,var(--g1),var(--g2))}
  .imgRow{display:flex;gap:8px;flex-wrap:wrap}
  .thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#000}
  .authCard{position:absolute;right:0;top:42px;width:300px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:none;z-index:40}
  .authCard.open{display:block}
  .hidden{display:none}
  :root{
    --bg:#0b1020;--card:#121831;--ink:#e7ecff;--muted:#9aa7d9;--accent:#6a8cff;--accent2:#8a5ff;--danger:#ff647c;--ok:#35d0a7;--border:#23305b;--warn:#ffc857;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --space:14px;
    --radius:14px;
    --tap:44px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: rgba(255,255,255,0); }
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:
      radial-gradient(1300px 800px at 80% -10%,rgba(138,91,255,.15),transparent 60%),
      radial-gradient(900px 700px at 0% 0%,rgba(106,140,255,.18),transparent 55%),
      linear-gradient(180deg,#0b1020,#0b1020 30%,#0b1020);
    color:var(--ink);
    padding-bottom: calc(var(--safe-bottom) + 6px);
    overscroll-behavior-y: none;
  }
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
  .row{display:flex;gap:var(--space);flex-wrap:wrap}
  .col{flex:1 1 280px; min-width:260px}
  .btn{
    appearance:none;border:1px solid var(--border);
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#fff;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer;
    min-height:var(--tap);
    touch-action: manipulation;
  }
  .btn.secondary{background:#182041}
  .btn.ghost{background:transparent;border-color:var(--border);color:var(--ink)}
  .btn.warn{background:linear-gradient(135deg,#ff9d00,#ff6800)}
  .btn.danger{background:linear-gradient(135deg,#ff5b73,#ff1f49)}
  .btn.ok{background:linear-gradient(135deg,#3cd6b5,#15a37f)}
  .btn:active{transform:translateY(1px); opacity:.95}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#1a2244;border:1px solid #2a3670;color:#cfe2ff;font-size:12px}
  .topbar{
    position:sticky;top:0;z-index:50;background:rgba(11,16,32,.86);
    -webkit-backdrop-filter: blur(10px);backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
    padding-top: calc(var(--safe-top) * 1);
  }
  .topbar .wrap{display:flex;align-items:center;gap:14px;justify-content:space-between;padding-top:8px;padding-bottom:6px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#121831; min-height:var(--tap); display:flex; align-items:center}
  .tab.active{background:linear-gradient(135deg,#1b2350,#1a244f)}
  .table-scroll{ overflow:auto; -webkit-overflow-scrolling:touch; }
  .grid{width:100%;border-collapse:collapse; min-width:720px}
  .grid th,.grid td{padding:10px;border-bottom:1px solid #1d274e;font-size:14px}
  .grid th{
    text-align:left;color:#c7d3ff;background:#121a3a;
    position:sticky; top:calc(var(--safe-top) + var(--sticky-offset,56px));
    z-index:2;
  }
  .table-scroll .grid th { top: 0; }
  .muted{color:var(--muted)}
  .hidden{display:none!important}
  input,select,textarea{
    width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
    background:#0f1530;color:var(--ink); font-size:16px;
    min-height:44px;
  }
  label{display:block;margin-top:10px;margin-bottom:6px;color:#ccd6ff;font-size:13px}
  .kpi{padding:12px;border-radius:12px;border:1px solid var(--border);background:#121a3a}
  .kpi .big{font-size:24px;font-weight:800}
  .pill{border:1px solid var(--border);padding:8px 10px;border-radius:999px; min-height:var(--tap)}
  .right{float:right}
  .center{text-align:center}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grow{flex:1}
  .danger-text{color:#ff8ca0}
  .ok-text{color:#5ee0c1}
  .warn-text{color:#ffd479}
  .modal{
    position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center;
    background:rgba(0,0,0,.55); z-index:200; padding:16px; overflow:auto;
    padding-top: calc(16px + var(--safe-top));
    padding-bottom: calc(16px + var(--safe-bottom));
  }
  .modal.open{ display:flex; }
  .modal .body{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:16px; width:96%; max-width:720px; max-height:90vh; overflow:auto; -webkit-overflow-scrolling:touch;
  }
  .modal .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px; position:sticky; top:0; background:var(--card); z-index:5; padding-bottom:6px}
  .modal .foot{
    display:flex;gap:10px;justify-content:flex-end;margin-top:12px;
    position:sticky; bottom:0; background:linear-gradient(180deg, transparent, rgba(18,24,49,.9) 24px, rgba(18,24,49,1) 48px);
    padding-top:12px; padding-bottom:6px;
  }
  .auth{max-width:420px;margin:60px auto; padding-left: max(16px, var(--safe-left)); padding-right: max(16px, var(--safe-right));}
  .logo{font-weight:900;letter-spacing:.5px}
  .subtle{opacity:.66}
  .badge-exp{background:#2a1a1a;color:#ffb3c0;border:1px solid #624}
  .badge-ok{background:#14231b;color:#b9ffe9;border:1px solid #264}
  .badge-warn{background:#2a2416;color:#ffe7a8;border:1px solid #684}
  @media (max-width: 420px){
    .wrap{padding:16px}
    .col{min-width:100%}
    .kpi .big{font-size:22px}
    .tabs .tab{padding:10px 10px}
    .topbar .wrap{padding-left: max(14px, var(--safe-left)); padding-right: max(14px, var(--safe-right));}
    .card{padding:14px}
  }
  @media (prefers-reduced-motion: reduce){
    *{scroll-behavior:auto}
  }
</style>
</head>
<body>
  <div class="top">
    <div class="row">
      <strong>net+TV Admin</strong>
      <span class="muted mini">| Anyone signed in can edit</span>

<!-- AUTH VIEW -->
<div id="authView" class="wrap auth">
  <div class="card">
    <h2 class="logo">Net + Cable <span class="subtle">• Admin Sign In</span></h2>
    <p class="muted" style="margin-top:6px">Use your admin email & password from Firebase Auth.</p>
    <label>Email</label>
    <input id="authEmail" type="email" placeholder="you@company.com" />
    <label>Password</label>
    <input id="authPass" type="password" placeholder="********" />
    <div class="flex" style="margin-top:12px">
      <button class="btn ok" id="btnLogin" type="button">Sign In</button>
      <button class="btn ghost" id="btnDemo" type="button">Use Demo (read-only)</button>
    </div>
    <div class="row">
      <a class="btn link" href="https://beta.gpanel.me/login" target="_blank" rel="noopener">Glo TV</a>
      <a class="btn link" href="https://bill.spicetv.cc/login" target="_blank" rel="noopener">Spice4K</a>
      <a class="btn link" href="https://fast4k.cc/login" target="_blank" rel="noopener">Smart 4K</a>
      <a class="btn link" href="data.html" target="_blank" rel="noopener">Users Data</a>
      <a class="btn link" href="https://postimages.org" target="_blank" rel="noopener">Upload Images</a>

      <div style="position:relative">
        <button id="authToggle" class="btn">Sign in</button>
        <div id="authCard" class="authCard">
          <div class="grid">
            <div class="muted mini">Firebase Email/Password</div>
            <input id="authEmail" placeholder="you@example.com" type="email">
            <input id="authPass" placeholder="password" type="password">
            <div class="row">
              <button id="emailSignIn" class="btn primary">Sign in</button>
              <button id="emailRegister" class="btn">Register</button>
            </div>
            <button id="googleSignIn" class="btn">Sign in with Google</button>
            <div id="authMsg" class="muted"></div>
          </div>
        </div>
      </div>
    <p id="authMsg" class="muted" style="margin-top:10px"></p>
    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
    <p class="muted">Tip: Create your own admin user in <strong>Firebase Console → Authentication</strong>. You can disable the demo user in Firestore rules.</p>
  </div>
</div>

      <span id="userInfo" class="muted mini">Not signed in</span>
      <button id="signOutBtn" class="btn hidden">Sign out</button>
<!-- APP VIEW -->
<div id="appView" class="hidden">
  <div class="topbar">
    <div class="wrap">
      <div class="flex">
        <div class="logo">Net + Cable <span class="muted">• Admin</span></div>
        <div id="envInfo" class="chip">Connected</div>
      </div>
      <div class="flex">
        <div id="nearExpCount" class="pill muted">Near expiry: 0</div>
        <button id="signOutBtn" class="btn secondary" type="button">Sign Out</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="editor" class="hidden">
      <div class="tabs">
        <button class="tab active" data-tab="settings">Settings & Text</button>
        <button class="tab" data-tab="plans">Plans</button>
        <button class="tab" data-tab="boxes">Boxes</button>
        <button class="tab" data-tab="banners">Banners</button>
        <button class="tab" data-tab="posters">Posters</button>
    <div class="tabs" style="margin-bottom:12px">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="customers">Customers</div>
      <div class="tab" data-tab="plans">Plans</div>
      <div class="tab" data-tab="reports">Reports</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>

    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="card">
      <div class="row">
        <div class="col kpi">
          <div class="muted">Total Customers</div>
          <div id="kpiCustomers" class="big">0</div>
        </div>
        <div class="col kpi">
          <div class="muted">Turnover (All-time)</div>
          <div id="kpiTurnover" class="big">$0.00</div>
        </div>
        <div class="col kpi">
          <div class="muted">Expense (All-time)</div>
          <div id="kpiExpense" class="big">$0.00</div>
        </div>
        <div class="col kpi">
          <div class="muted">Profit (All-time)</div>
          <div id="kpiProfit" class="big">$0.00</div>
        </div>
      </div>

      <!-- SETTINGS & TEXT -->
      <section id="tab-settings" class="grid" style="margin-top:12px">
        <div class="card">
          <div class="split"><h3 style="margin:0">Homepage Text</h3><button id="seedBtn" class="btn">Seed sample data</button></div>
          <div class="grid three" style="margin-top:8px">
            <div><label>Hero Subtitle</label><input id="set-hero-subtitle" placeholder="Quick Activation"></div>
            <div><label>Hero Title</label><input id="set-hero-title" placeholder="20,000+ Live Channels, All Shows, Movies & PPV"></div>
            <div><label>Hero Subline</label><input id="set-hero-subline" placeholder="Latest + classic Movies & Series • Full HD & SD Channels • Anti-Freeze Tech"></div>
          </div>
          <div class="grid two">
            <div><label>CTA Buttons (comma separated, 4)</label><input id="set-ctas" placeholder="Our Plans, New Boxes, Renew Plan, Contact Support"></div>
            <div><label>Feature Ticker (comma separated)</label><input id="set-features" placeholder="🇨🇦 Proudly Canadian, Zero Latency Streams, 24/7 Support, Multi-Device"></div>
          </div>
      <h3 style="margin-top:18px">Near Expiry</h3>
      <div class="flex" style="margin-bottom:8px">
        <div class="muted">Show customers expiring within</div>
        <select id="nearDays" class="pill">
          <option value="7">7 days</option>
          <option value="14">14 days</option>
          <option value="30" selected>30 days</option>
          <option value="60">60 days</option>
        </select>
      </div>
      <div class="card table-scroll" style="padding:0">
        <table class="grid" id="nearGrid">
          <thead><tr>
            <th>Name</th><th>Phone</th><th>Plan</th><th>Expiry</th><th>Days Left</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section id="tab-customers" class="card hidden">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="flex grow">
          <input id="searchCustomers" placeholder="Search by name, phone, email, MAC, user ID..." />
        </div>
        <div class="flex">
          <button id="btnAddCustomer" class="btn ok" type="button">+ Add Customer</button>
        </div>
      </div>

        <div class="card">
          <h3>Site Settings</h3>
          <div class="grid three">
            <div>
              <label>Default Theme</label>
              <select id="set-theme"><option>dark</option><option>light</option></select>
            </div>
            <div>
              <label>WhatsApp Number (no +)</label>
              <input id="set-wa" placeholder="16476961656" />
            </div>
            <div>
              <label>Notes</label>
              <input id="set-notes" placeholder="Internal note (optional)">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="saveSettings" class="btn primary">Save Settings</button>
            <div id="settingsMsg" class="muted"></div>
          </div>
          <div class="muted" style="margin-top:8px">Tip: After saving, refresh your homepage tab. If you seeded, you should instantly see banners, posters, plans and a sample box.</div>
      <div class="flex" style="gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <select id="timeFilter" class="pill" style="background:#121831;color:#fff;border:1px solid var(--border)">
          <option value="7" selected>Last 7 Days</option>
          <option value="30">Monthly</option>
          <option value="365">Yearly</option>
          <option value="lifetime">Lifetime</option>
        </select>
        <select id="statusFilter" class="pill" style="background:#121831;color:#fff;border:1px solid var(--border)">
          <option value="all" selected>All</option>
          <option value="paid">Paid</option>
          <option value="unpaid">Unpaid</option>
        </select>
      </div>

      <div class="card table-scroll" style="padding:0">
        <table class="grid" id="custGrid">
          <thead><tr>
            <th>Name</th><th>Phone</th><th>Email</th><th>Plan</th><th>Paid</th>
            <th>Start</th><th>Expiry</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PLANS -->
    <section id="tab-plans" class="card hidden">
      <div class="flex" style="justify-content:space-between;margin-bottom:8px">
        <h3>Plans</h3>
        <div class="flex">
          <button id="btnSeedPlans" class="btn ghost" type="button">Seed sample plans</button>
          <button id="btnAddPlan" class="btn ok" type="button">+ Add Plan</button>
        </div>
      </section>

      <!-- PLANS -->
      <section id="tab-plans" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Plan</h3>
          <div class="grid three">
            <div><label>Name</label><input id="p-name"></div>
            <div><label>Price (e.g., CA$100)</label><input id="p-price"></div>
            <div><label>Months</label><input id="p-months" type="number" min="1"></div>
          </div>
          <div class="grid three">
            <div><label>Benefit</label><input id="p-benefit" placeholder="+1 month free"></div>
            <div><label>Tag</label><input id="p-tag" placeholder="Popular / Best Value"></div>
            <div><label>Sort</label><input id="p-sort" type="number" value="10"></div>
          </div>
          <div class="grid two">
            <div><label>Description</label><input id="p-desc" placeholder="Short description"></div>
            <div><label>Active</label><select id="p-active"><option>true</option><option>false</option></select></div>
          </div>
          <div class="row">
            <button id="planSave" class="btn primary">Save</button>
            <button id="planNew" class="btn">New</button>
            <button id="planDelete" class="btn">Delete</button>
            <div id="planMsg" class="muted"></div>
          </div>
          <input id="p-id" type="hidden">
      </div>
      <div class="card table-scroll" style="padding:0">
        <table class="grid" id="plansGrid">
          <thead><tr>
            <th>ID</th><th>Name</th><th>Duration (months)</th>
            <th>Retail $</th><th>Wholesale $</th><th>Description</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="tab-reports" class="card hidden">
      <div class="row">
        <div class="col">
          <label>Report Type</label>
          <select id="repType">
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="col" id="repMonthCol">
          <label>Month</label>
          <input id="repMonth" type="month">
        </div>
        <div class="col" id="repYearCol">
          <label>Year</label>
          <input id="repYear" type="number" min="2000" max="2100" value="">
        </div>
        <div class="col hidden" id="repFromCol">
          <label>From (start date)</label>
          <input id="repFrom" type="date">
        </div>
        <div class="col hidden" id="repToCol">
          <label>To (end date)</label>
          <input id="repTo" type="date">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button id="btnRunReport" class="btn" type="button">Run Report</button>
        <button id="btnCsv" class="btn ghost" type="button">Export CSV</button>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="col kpi"><div class="muted">Turnover</div><div id="repTurnover" class="big">$0.00</div></div>
        <div class="col kpi"><div class="muted">Expense</div><div id="repExpense" class="big">$0.00</div></div>
        <div class="col kpi"><div class="muted">Profit</div><div id="repProfit" class="big">$0.00</div></div>
      </div>

        <div class="card">
          <div class="split"><h3>Plans</h3><button id="plansReload" class="btn">Reload</button></div>
          <div id="plansList" class="list"></div>
      <h3 style="margin-top:18px">Included Plans in Period</h3>
      <div class="card table-scroll" style="padding:0">
        <table class="grid" id="repGrid">
          <thead><tr>
            <th>Date</th><th>Customer</th><th>Plan</th><th>Turnover $</th><th>Expense $</th><th>Profit $</th><th>Paid</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="card hidden">
      <h3>Settings</h3>
      <label>Near-expiry threshold (days)</label>
      <input id="settingNearDays" type="number">
      <p class="muted" style="margin-top:6px"></p>
      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">
      <div class="flex">
        <button id="btnCleanupOrphans" class="btn danger" type="button">🗑 Delete Orphan Renewals</button>
        <span id="cleanupMsg" class="muted"></span>
      </div>
    </section>

    <!-- MODALS (Customer, Renew, Plan) — unchanged UI -->
    <div id="modalCustomer" class="modal">
      <div class="body">
        <div class="head">
          <h3 id="custModalTitle">Add Customer</h3>
          <button class="btn ghost" id="xCust" type="button">✕</button>
        </div>
      </section>

      <!-- BOXES -->
      <section id="tab-boxes" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Box</h3>
          <div class="grid three">
            <div><label>Tier badge</label><input id="b-tier" placeholder="Basic Box / Good Box"></div>
            <div><label>Model name</label><input id="b-name" placeholder="X-100"></div>
            <div><label>Sort</label><input id="b-sort" type="number" value="10"></div>
        <div class="row">
          <div class="col">
            <label>Name</label><input id="c_name">
            <label>Phone</label><input id="c_phone">
            <label>Email</label><input id="c_email" type="email">
            <label>User ID (internal)</label><input id="c_userId" placeholder="e.g., CUST-001">
            <label>MAC Address</label><input id="c_mac" placeholder="AA:BB:CC:DD:EE:FF">
          </div>
          <div class="grid two">
            <div><label>Box Price</label><input id="b-boxPrice" placeholder="CA$120"></div>
            <div><label>Active</label><select id="b-active"><option>true</option><option>false</option></select></div>
          </div>
          <div class="grid three">
            <div><label>Combo Price</label><input id="b-c-price" placeholder="CA$199"></div>
            <div><label>Combo Months</label><input id="b-c-months" type="number" value="12"></div>
            <div><label>Combo Extra</label><input id="b-c-extra" placeholder="+1 month free"></div>
          </div>
          <div><label>Description</label><input id="b-desc" placeholder="Short description"></div>

          <div class="grid">
            <label>Image URLs (1–3, one per line)</label>
            <textarea id="b-img-urls" placeholder="https://.../1280x720-1.jpg
https://.../1280x720-2.jpg"></textarea>
            <div id="b-images" class="imgRow"></div>
          <div class="col">
            <label>Plan</label><select id="c_plan"></select>
            <div class="muted" style="margin-top:6px">You can override price/wholesale below.</div>
            <label>Plan Actual Price</label><input id="c_actual" type="number" step="0.01" placeholder="e.g., 20.00">
            <label>Selling Price (what customer pays)</label><input id="c_cost" type="number" step="0.01">
            <label>Wholesale Rate (your cost)</label><input id="c_wholesale" type="number" step="0.01">
            <label>Discount Name (optional)</label><input id="c_discName" placeholder="e.g., Diwali Offer, Combo Deal">
            <label>Includes STB?</label>
            <select id="c_stb"><option value="no" selected>No</option><option value="yes">Yes</option></select>
            <div id="stbBox" class="hidden">
              <label>STB Actual Price</label><input id="c_stbActual" type="number" step="0.01" placeholder="e.g., 49.00">
              <label>STB Selling Price</label><input id="c_stbCost" type="number" step="0.01">
              <label>STB Wholesale</label><input id="c_stbWholesale" type="number" step="0.01">
            </div>
          </div>

          <div class="row">
            <button id="boxSave" class="btn primary">Save</button>
            <button id="boxNew" class="btn">New</button>
            <button id="boxDelete" class="btn">Delete</button>
            <div id="boxMsg" class="muted"></div>
          <div class="col">
            <label>Plan Start Date</label><input id="c_start" type="date">
            <label>Plan Expiry Date</label><input id="c_expiry" type="date">
            <label>Payment Received?</label>
            <select id="c_paid"><option value="yes" selected>Yes</option><option value="no">No</option></select>
            <div class="card" style="margin-top:10px">
              <div class="muted">Totals Preview</div>
              <div id="c_preview" class="muted">—</div>
            </div>
          </div>
          <input id="b-id" type="hidden">
        </div>
        <div class="foot">
          <label class="flex" style="gap:8px;align-items:center;margin-right:auto">
            <input id="c_invoice" type="checkbox" checked> Open slip after save
          </label>
          <button type="button" class="btn secondary" id="btnSaveCustomer">Save</button>
        </div>
      </div>
    </div>

        <div class="card">
          <div class="split"><h3>Boxes</h3><button id="boxesReload" class="btn">Reload</button></div>
          <div id="boxesList" class="list"></div>
    <div id="modalRenew" class="modal">
      <div class="body">
        <div class="head">
          <h3 id="renewTitle">Renew Plan</h3>
          <button class="btn ghost" id="xRenew" type="button">✕</button>
        </div>
      </section>

      <!-- BANNERS -->
      <section id="tab-banners" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Banner</h3>
          <div class="grid two">
            <div><label>Title</label><input id="bn-title" placeholder="Promo title"></div>
            <div><label>Sort</label><input id="bn-sort" type="number" value="10"></div>
          </div>
          <div class="grid two">
            <div><label>Active</label><select id="bn-active"><option>true</option><option>false</option></select></div>
            <div><label>Image URLs (one per line, 1280×720)</label></div>
        <div class="row">
          <div class="col">
            <label>Plan</label><select id="r_plan"></select>
            <label>Plan Actual Price</label><input id="r_actual" type="number" step="0.01">
            <label>Plan Selling Price</label><input id="r_cost" type="number" step="0.01">
            <label>Wholesale</label><input id="r_wholesale" type="number" step="0.01">
            <label>Discount Name (optional)</label><input id="r_discName">
          </div>
          <textarea id="bn-img-urls" placeholder="https://.../banner-1-1280x720.jpg
https://.../banner-2-1280x720.jpg"></textarea>
          <div id="bn-images" class="imgRow" style="margin-top:6px"></div>
          <div class="row">
            <button id="bnSave" class="btn primary">Save</button>
            <button id="bnNew" class="btn">New</button>
            <button id="bnDelete" class="btn">Delete</button>
            <div id="bnMsg" class="muted"></div>
          <div class="col">
            <label>Includes STB?</label>
            <select id="r_stb"><option value="no" selected>No</option><option value="yes">Yes</option></select>
            <div id="r_stbBox" class="hidden">
              <label>STB Actual Price</label><input id="r_stbActual" type="number" step="0.01">
              <label>STB Selling Price</label><input id="r_stbCost" type="number" step="0.01">
              <label>STB Wholesale</label><input id="r_stbWholesale" type="number" step="0.01">
            </div>
            <label>Start Date</label><input id="r_start" type="date">
            <label>Expiry Date</label><input id="r_expiry" type="date">
            <label>Payment Received?</label>
            <select id="r_paid"><option value="yes" selected>Yes</option><option value="no">No</option></select>
          </div>
          <input id="bn-id" type="hidden">
        </div>
        <div class="foot">
          <label class="flex" style="gap:8px;align-items:center;margin-right:auto">
            <input id="r_invoice" type="checkbox" checked> Open slip after renewal
          </label>
          <button id="btnDoRenew" class="btn ok" type="button">Confirm Renewal</button>
        </div>
      </div>
    </div>

        <div class="card">
          <div class="split"><h3>Banners</h3><button id="bnReload" class="btn">Reload</button></div>
          <div id="bannersList" class="list"></div>
    <div id="modalPlan" class="modal">
      <div class="body">
        <div class="head">
          <h3 id="planTitle">Add Plan</h3>
          <button class="btn ghost" id="xPlan" type="button">✕</button>
        </div>
      </section>

      <!-- POSTERS -->
      <section id="tab-posters" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Poster</h3>
          <div class="grid three">
            <div><label>Title</label><input id="ps-title" placeholder="Movie / Series title"></div>
            <div><label>Aspect ratio</label><select id="ps-ratio"><option>2:3</option><option>16:9</option></select></div>
            <div><label>Sort</label><input id="ps-sort" type="number" value="10"></div>
        <div class="row">
          <div class="col">
            <label>Plan ID</label><input id="p_id" placeholder="PLN-1MO">
            <label>Name</label><input id="p_name" placeholder="1 month">
            <label>Duration (months)</label><input id="p_months" type="number" min="0" step="1" value="1">
          </div>
          <div class="grid two">
            <div><label>Active</label><select id="ps-active"><option>true</option><option>false</option></select></div>
            <div><label>Image URL</label><input id="ps-url" placeholder="https://.../poster.jpg"></div>
          <div class="col">
            <label>Retail Price</label><input id="p_retail" type="number" step="0.01">
            <label>Wholesale Cost</label><input id="p_wholesale" type="number" step="0.01">
            <label>Description</label><input id="p_desc" placeholder="Most popular">
          </div>
          <div class="row"><img id="ps-thumb" class="thumb hidden" alt=""></div>
          <div class="row">
            <button id="psSave" class="btn primary">Save</button>
            <button id="psNew" class="btn">New</button>
            <button id="psDelete" class="btn">Delete</button>
            <div id="psMsg" class="muted"></div>
          </div>
          <input id="ps-id" type="hidden">
        </div>

        <div class="card">
          <div class="split"><h3>Posters</h3><button id="psReload" class="btn">Reload</button></div>
          <div id="postersList" class="list"></div>
        <div class="foot">
          <button id="btnSavePlan" class="btn secondary" type="button">Save Plan</button>
        </div>
      </section>
      </div>
    </div>

    <div id="locked" class="card">
      <h3>Sign in to edit</h3>
      <p class="muted">Anyone who can sign in can edit. Try not to hand out the login like festival flyers.</p>
    </div>
  </div>
  </div> <!-- /wrap -->
</div> <!-- /appView -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut,
           createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCboIOCfsY1Zvx-cyKPMbAMGYdg27rnP0Y",
    authDomain: "netplus-site-4ff04.firebaseapp.com",
    projectId: "netplus-site-4ff04",
    storageBucket: "netplus-site-4ff04.firebasestorage.app",
    messagingSenderId: "49095160110",
    appId: "1:49095160110:web:5431d5c9f8ca45c4d70abf",
    measurementId: "G-PYWFFDZ0RR"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const splitUrls = raw => (raw||"").split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
  function msg(el, text, ok=true){ el.textContent = text; el.className = ok ? "muted success" : "muted danger"; setTimeout(()=>{el.textContent=""; el.className="muted";}, 3000); }
  function ensure(v,f){ return (v===undefined||v===null)?f:v; }
  function renderThumbs(hostSel, urls){ const host=$(hostSel); host.innerHTML=''; urls.forEach(u=>{ host.insertAdjacentHTML('beforeend', `<img src="${u}" class="thumb">`); }); }

  // Auth UI
  const userInfo = $('#userInfo'), signOutBtn = $('#signOutBtn');
  const authToggle = $('#authToggle'), authCard = $('#authCard');
  const emailIn = $('#authEmail'), passIn = $('#authPass'), authMsg = $('#authMsg');

  authToggle.onclick = ()=> authCard.classList.toggle('open');
  document.addEventListener('click', e=>{ if (!authCard.contains(e.target) && !authToggle.contains(e.target)) authCard.classList.remove('open'); });

  $('#googleSignIn').onclick = async()=>{ try{ await signInWithPopup(auth, provider); authCard.classList.remove('open'); }catch(e){ msg(authMsg,e.message,false); } };
  $('#emailSignIn').onclick = async()=>{ try{ await signInWithEmailAndPassword(auth, emailIn.value.trim(), passIn.value); authCard.classList.remove('open'); }catch(e){ msg(authMsg,e.message,false); } };
  $('#emailRegister').onclick = async()=>{ try{ const cred=await createUserWithEmailAndPassword(auth, emailIn.value.trim(), passIn.value); msg(authMsg,'Registered: '+cred.user.email,true); }catch(e){ msg(authMsg,e.message,false); } };
  signOutBtn.onclick = async()=>{ await signOut(auth); };

  // Anyone signed in can edit
  onAuthStateChanged(auth, async user=>{
    const editor = $('#editor'), locked = $('#locked');
    if(!user){
      userInfo.textContent = "Not signed in";
      signOutBtn.classList.add('hidden');
      editor.classList.add('hidden');
      locked.classList.remove('hidden');
      return;
    }
    userInfo.textContent = user.displayName || user.email || user.uid;
    signOutBtn.classList.remove('hidden');
    editor.classList.remove('hidden');
    locked.classList.add('hidden');

    // load data
    await loadSettings();
    await loadPlans();
    await loadBoxes();
    await loadBanners();
    await loadPosters();
  });
/* =========================
   Firebase Setup (ESM CDN)
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc,
  query, orderBy, serverTimestamp, collectionGroup, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Tabs
  $$('.tab').forEach(t=>{
    t.onclick = ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['settings','plans','boxes','banners','posters'].forEach(key=>{
        $('#tab-'+key).classList.toggle('hidden', key!==t.dataset.tab);
      });
    };
  });
/* ---- Firebase Config ---- */
const firebaseConfig = {
  apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
  authDomain: "netplustv-90b29.firebaseapp.com",
  projectId: "netplustv-90b29",
  storageBucket: "netplustv-90b29.firebasestorage.app",
  messagingSenderId: "639722274355",
  appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

  /* SETTINGS */
  async function loadSettings(){
    const sDoc = await getDoc(doc(db,'settings','main'));
    if(sDoc.exists()){
      const s = sDoc.data();
      $('#set-theme').value = ensure(s.themeDefault,'dark');
      $('#set-wa').value = ensure(s.whatsappNumber,'16476961656');
      $('#set-features').value = ensure((s.features||[]).join(', '),'🇨🇦 Proudly Canadian, Zero Latency Streams, 24/7 Support, Multi-Device');
      $('#set-hero-subtitle').value = ensure(s.heroSubtitle,'Quick Activation');
      $('#set-hero-title').value = ensure(s.heroTitle,'20,000+ Live Channels, All Shows, Movies & PPV');
      $('#set-hero-subline').value = ensure(s.heroSubline,'Latest + classic Movies & Series • Full HD & SD Channels • Anti-Freeze Tech');
      $('#set-ctas').value = ensure((s.ctaLabels||['Our Plans','New Boxes','Renew Plan','Contact Support']).join(', '),'Our Plans, New Boxes, Renew Plan, Contact Support');
      $('#set-notes').value = ensure(s.notes,'');
    }
/* =========================
   Error reporting helpers
   ========================= */
function showErr(label, err){
  console.error(label, err);
  const chip = document.getElementById('envInfo');
  if (chip){
    chip.textContent = (err?.code || 'error') + ' • ' + (err?.message || label);
    chip.style.background = '#3a1220';
  }
  $('#saveSettings').onclick = async()=>{
    const body = {
      themeDefault: $('#set-theme').value || 'dark',
      whatsappNumber: $('#set-wa').value || '16476961656',
      features: ($('#set-features').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      heroSubtitle: $('#set-hero-subtitle').value.trim(),
      heroTitle: $('#set-hero-title').value.trim(),
      heroSubline: $('#set-hero-subline').value.trim(),
      ctaLabels: ($('#set-ctas').value||'').split(',').map(s=>s.trim()).slice(0,4),
      notes: $('#set-notes').value.trim(),
      updatedAt: serverTimestamp()
}
window.addEventListener('error', e => showErr('[window.error]', e.error || e.message));
window.addEventListener('unhandledrejection', e => showErr('[promise]', e.reason));

async function safeGetDocs(qry, label){ try{ return await getDocs(qry); } catch(e){ showErr(label, e); throw e; } }
async function safeAddDoc(ref, data, label){ try{ return await addDoc(ref, data); } catch(e){ showErr(label, e); throw e; } }
async function safeSetDoc(ref, data, opts, label){ try{ return await setDoc(ref, data, opts); } catch(e){ showErr(label, e); throw e; } }
async function safeUpdateDoc(ref, data, label){ try{ return await updateDoc(ref, data); } catch(e){ showErr(label, e); throw e; } }
async function safeDeleteDoc(ref, label){ try{ return await deleteDoc(ref); } catch(e){ showErr(label, e); throw e; } }

/* =========================
   Helpers (dates, money)
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const fmt = n => (isNaN(+n)? '$0.00' : '$' + (+n).toFixed(2));
const todayISO = () => new Date().toISOString().slice(0,10);
function addMonthsISO(startISO, months){
  if (!startISO) return "";
  const d = new Date(startISO + "T00:00:00");
  if (isNaN(d.getTime())) return "";
  const day = d.getDate();
  d.setMonth(d.getMonth()+Number(months||0));
  if (d.getDate() !== day) d.setDate(0);
  return d.toISOString().slice(0,10);
}
function daysLeft(expISO){
  const end = new Date((expISO||'')+"T23:59:59");
  const now = new Date();
  return Math.ceil((end - now) / (1000*60*60*24));
}
function calcFigures({ cost, wholesale, actual, stbIncluded, stbCost, stbWholesale, stbActual }){
  const sellPlan = +cost||0, whPlan = +wholesale||0, msrpPlan=+actual||0;
  const sellSTB  = +stbCost||0, whSTB = +stbWholesale||0, msrpSTB=+stbActual||0;
  const turnover = sellPlan + (stbIncluded==='yes' ? sellSTB : 0);
  const expense  = whPlan   + (stbIncluded==='yes' ? whSTB   : 0);
  const profit   = turnover - expense;
  const discountSaved = Math.max(msrpPlan - sellPlan, 0) + (stbIncluded==='yes' ? Math.max(msrpSTB - sellSTB, 0) : 0);
  return {turnover, expense, profit, discountSaved};
}

/* =========================
   iOS niceties
   ========================= */
(function iosTweaks(){
  const topbar = document.querySelector('.topbar');
  function setStickyOffset(){
    const topH = topbar ? topbar.getBoundingClientRect().height : 0;
    document.documentElement.style.setProperty('--sticky-offset', topH + 'px');
  }
  setStickyOffset(); window.addEventListener('resize', setStickyOffset);
  const useVV = window.visualViewport;
  if (useVV) {
    const onVVChange = () => {
      document.body.style.paddingBottom = `calc(${useVV.height < window.innerHeight ? '20vh' : '0px'} + var(--safe-bottom))`;
    };
    await setDoc(doc(db,'settings','main'), body, {merge:true});
    msg($('#settingsMsg'),'Saved.');
  };
    useVV.addEventListener('resize', onVVChange);
    useVV.addEventListener('scroll', onVVChange);
  }
  document.addEventListener('focusin', (e)=>{
    const el = e.target;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT')) {
      setTimeout(()=> el.scrollIntoView({ block:'center', behavior:'smooth' }), 100);
    }
  }, {passive:true});
})();

/* =========================
   UI state / tabs
   ========================= */
const authView = $("#authView");
const appView  = $("#appView");
const tabs = $$(".tab");
const sections = {
  dashboard: $("#tab-dashboard"),
  customers: $("#tab-customers"),
  plans: $("#tab-plans"),
  reports: $("#tab-reports"),
  settings: $("#tab-settings"),
};
tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(sections).forEach(s=>s.classList.add('hidden'));
    sections[t.dataset.tab].classList.remove('hidden');
  }, {passive:true});
});

/* =========================
   AUTH
   ========================= */
const authEmail = $("#authEmail");
const authPass  = $("#authPass");
const authMsg   = $("#authMsg");
$("#btnLogin").onclick = async ()=>{
  authMsg.textContent = "Signing in...";
  try{
    await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPass.value.trim());
    authMsg.textContent = "Signed in.";
  }catch(e){
    showErr('[auth/login]', e);
    authMsg.textContent = (e.code||'auth/error') + " — " + e.message;
  }
};
$("#btnDemo").onclick = ()=>{
  authView.classList.add('hidden');
  appView.classList.remove('hidden');
  loadApp();
};
$("#signOutBtn").onclick = ()=> signOut(auth);

  // Seed sample content fast so homepage shows data immediately
  $('#seedBtn').onclick = async()=>{
    if(!confirm('Seed demo content? This will add sample banners, posters, a box and 2 plans.')) return;
    // settings
    await setDoc(doc(db,'settings','main'), {
      themeDefault:'dark',
      whatsappNumber:'16476961656',
      features:['🇨🇦 Proudly Canadian','Zero Latency Streams','24/7 Support','Multi-Device'],
      heroSubtitle:'Quick Activation',
      heroTitle:'20,000+ Live Channels, All Shows, Movies & PPV',
      heroSubline:'Latest + classic Movies & Series • Full HD & SD Channels • Anti-Freeze Tech',
      ctaLabels:['Our Plans','New Boxes','Renew Plan','Contact Support'],
onAuthStateChanged(auth, (user)=>{
  if(user){
    authView.classList.add('hidden');
    appView.classList.remove('hidden');
    loadApp(user);
    setTimeout(()=> window.dispatchEvent(new Event('resize')), 0);
  }else{
    appView.classList.add('hidden');
    authView.classList.remove('hidden');
  }
});

/* =========================
   Data caches
   ========================= */
let plans = {};
let customers = [];
let renewals = [];
let settingNear = 30;

/* =========================
   Load initial app data
   ========================= */
async function loadApp(user){
  $("#envInfo").textContent = "Connected";
  $("#settingNearDays").value = settingNear;
  $("#settingNearDays").addEventListener('change', ()=>{
    settingNear = Math.max(1, +$("#settingNearDays").value||30);
    $("#nearDays").value = String(settingNear);
    renderAll();
  }, {passive:true});
  $("#nearDays").value = String(settingNear);
  $("#nearDays").addEventListener('change', ()=>{
    settingNear = +$("#nearDays").value;
    $("#settingNearDays").value = settingNear;
    renderAll();
  }, {passive:true});

  $("#btnAddCustomer").onclick = () => openCustomerModal(null);
  $("#btnSeedPlans").onclick = seedPlans;
  $("#btnAddPlan").onclick = ()=>openPlanModal();

  $("#btnRunReport")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); runReport(); });
  $("#btnCsv")?.addEventListener("click",  (e) => { e.preventDefault(); e.stopPropagation(); exportCSV(); });

  $("#btnCleanupOrphans").onclick = cleanupOrphanRenewals;
  $("#searchCustomers").addEventListener('input', renderCustomers);
  $("#timeFilter").addEventListener('change', renderCustomers);
  $("#statusFilter").addEventListener('change', renderCustomers);

  await Promise.all([loadPlans(), loadCustomers()]);
  await loadRenewals();

  const now = new Date();
  $("#repMonth").value = now.toISOString().slice(0,7);
  $("#repYear").value  = String(now.getFullYear());
  runReport();
  $("#repType").addEventListener('change', onRepTypeChange, {passive:true});
  onRepTypeChange();

  renderAll();
}

/* =========================
   Firestore load/save (safe wrappers)
   ========================= */
async function loadPlans(){
  plans = {};
  const snap = await safeGetDocs(query(collection(db, "plans"), orderBy("id")), '[plans] getDocs');
  snap.forEach(d=>{ plans[d.id] = d.data(); });
  renderPlans();
}
async function savePlan(p){
  const ref = doc(db, "plans", String(p.id));
  await safeSetDoc(ref, p, {merge:true}, '[plans] setDoc');
  plans[p.id] = p;
  renderPlans();
  refreshPlanSelects();
}
async function deletePlan(id){
  await safeDeleteDoc(doc(db, "plans", String(id)), '[plans] deleteDoc');
  delete plans[id];
  renderPlans();
  refreshPlanSelects();
}

async function loadCustomers(){
  customers = [];
  const snap = await safeGetDocs(query(collection(db,"customers"), orderBy("name")), '[customers] getDocs');
  snap.forEach(d=> customers.push({id:d.id, ...d.data()}) );
  renderCustomers();
}

async function saveCustomer(payload, existingId=null){
  if (existingId) {
    const idStr = String(existingId);
    const ref = doc(db,"customers", idStr);
    payload.updatedAt = serverTimestamp();
    await safeUpdateDoc(ref, payload, '[customers] updateDoc');
    await loadCustomers();
    return idStr;
  } else {
    const ref = await safeAddDoc(collection(db,"customers"), {
      ...payload,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }, {merge:true});
    // banners
    await addDoc(collection(db,'banners'), { title:'Welcome', sort:10, active:true, images:[
      'https://via.placeholder.com/1280x720?text=net%2BTV+Banner+1',
      'https://via.placeholder.com/1280x720?text=net%2BTV+Banner+2'
    ], updatedAt:serverTimestamp()});
    // posters
    await addDoc(collection(db,'posters'), { title:'Sample Poster 1', ratio:'2:3', sort:10, active:true, image:'https://via.placeholder.com/300x450?text=Poster+1', updatedAt:serverTimestamp()});
    await addDoc(collection(db,'posters'), { title:'Sample Poster 2', ratio:'2:3', sort:20, active:true, image:'https://via.placeholder.com/300x450?text=Poster+2', updatedAt:serverTimestamp()});
    // plans
    await addDoc(collection(db,'plans'), { name:'Starter HD', price:'CA$60', months:6, benefit:'+1 month free', tag:'Popular', desc:'HD focus • Core channels', sort:10, active:true, updatedAt:serverTimestamp()});
    await addDoc(collection(db,'plans'), { name:'Family FHD', price:'CA$100', months:12, benefit:'+2 months free', tag:'Best Value', desc:'Full HD • Family packs', sort:20, active:true, updatedAt:serverTimestamp()});
    // box
    await addDoc(collection(db,'boxes'), {
      tier:'Basic Box', name:'X-100', sort:10, boxPrice:'CA$120', active:true,
      combo:{price:'CA$199', planMonths:12, extra:'+1 month free'},
      desc:'Fast setup. Supports our portal.',
      images:['https://via.placeholder.com/1280x720?text=Box+Front','https://via.placeholder.com/1280x720?text=Box+UI'],
      updatedAt:serverTimestamp()
    });
    alert('Seeded. Open your homepage and refresh.');
  };
    }, '[customers] addDoc');
    await loadCustomers();
    return String(ref.id);
  }
}

  /* PLANS */
  let plansCache=[];
  async function loadPlans(){
    const snap = await getDocs(collection(db,'plans'));
    plansCache=[]; snap.forEach(d=> plansCache.push({id:d.id,...d.data()}));
    plansCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderPlansList();
async function addRenewal(customerId, ren){
  const ref = await safeAddDoc(collection(db, "customers", String(customerId), "renewals"), { ...ren, createdAt: serverTimestamp() }, '[renewals] addDoc');
  await loadRenewals();
  return String(ref.id);
}

async function loadRenewals(){
  renewals = [];
  try{
    const snap = await safeGetDocs(collectionGroup(db, "renewals"), '[renewals] collectionGroup');
    snap.forEach(d=> renewals.push({id:d.id, ...d.data(), _path: d.ref.path}) );
  }catch(e){
    // Fallback: per-customer read (still requires read access to each subcollection)
    for (const c of customers){
      try{
        const rs = await safeGetDocs(collection(db, "customers", String(c.id), "renewals"), `[renewals] fallback ${c.id}`);
        rs.forEach(d=> renewals.push({id:d.id, ...d.data(), _path: d.ref.path}) );
      }catch(e2){
        // already reported by safeGetDocs
      }
    }
  }
  function renderPlansList(){
    const list=$('#plansList'); list.innerHTML='';
    plansCache.forEach(p=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><span class="tag mini">${p.tag||''}</span> <strong>${p.name||''}</strong> <span class="muted">(${p.months||''} mo)</span></div>
          <div class="right"><strong>${p.price||''}</strong> <span class="muted">sort:${p.sort||0}</span> <span class="muted">${p.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${p.id}">Edit</button>
          </div>
        </div>`;
      list.appendChild(div);
}

async function setCustomerCurrentPlan(customerId, planFields){
  const ref = doc(db, "customers", String(customerId));
  await safeUpdateDoc(ref, { currentPlan: planFields, updatedAt: serverTimestamp() }, '[customers] set currentPlan');
}

async function deleteCustomerAndRenewals(customerId) {
  const idStr = String(customerId);
  const renSnap = await safeGetDocs(collection(db, "customers", idStr, "renewals"), '[renewals] list before delete');
  const batch = writeBatch(db);
  renSnap.forEach(d => batch.delete(doc(db, "customers", idStr, "renewals", d.id)));
  batch.delete(doc(db, "customers", idStr));
  await batch.commit();
  await loadCustomers();
  await loadRenewals();
  renderAll();
}

/* =========================
   Rendering
   ========================= */
function renderAll(){ renderCustomers(); renderKPIs(); renderNearExpiry(); }

function renderPlans(){
  const tbody = $("#plansGrid tbody");
  tbody.innerHTML = "";
  const ids = Object.keys(plans).sort();
  ids.forEach(id=>{
    const p = plans[id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name||''}</td>
      <td>${p.duration_months||0}</td>
      <td>${(+p.retail_price||0).toFixed(2)}</td>
      <td>${(+p.wholesale_cost||0).toFixed(2)}</td>
      <td>${p.description||''}</td>
      <td class="flex">
        <button class="btn ghost" data-edit="${p.id}">Edit</button>
        <button class="btn danger" data-del="${p.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=> openPlanModal(plans[btn.getAttribute('data-edit')]);
  });
  tbody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = async ()=>{
      const pid = btn.getAttribute('data-del');
      if(confirm("Delete plan "+pid+" ?")) await deletePlan(pid);
    };
  });
  refreshPlanSelects();
}

function renderCustomers(){
  const q = ($("#searchCustomers").value||"").toLowerCase().trim();
  const tVal = ($("#timeFilter")?.value)||"7";
  const sVal = ($("#statusFilter")?.value)||"all";

  const now = new Date();
  const dayLimit = (tVal === 'lifetime') ? Infinity : parseInt(tVal, 10);

  const tbody = $("#custGrid tbody");
  tbody.innerHTML = "";

  customers.forEach(c=>{
    const plan = c.currentPlan || {};
    const inText = `${c.name||''} ${c.phone||''} ${c.email||''} ${c.userId||''} ${c.mac||''}`.toLowerCase();
    if(q && !inText.includes(q)) return;

    const startISO = plan.startDate || c.originalStartDate || "";
    let withinTime = true;
    if (dayLimit !== Infinity && startISO){
      const start = new Date(startISO + "T00:00:00");
      const diffDays = Math.floor((now - start) / (1000*60*60*24));
      withinTime = diffDays <= dayLimit;
    } else if (dayLimit !== Infinity && !startISO){
      withinTime = false;
    }
    if(!withinTime) return;

    const paidStr = (plan.paymentReceived==='yes') ? 'paid' : 'unpaid';
    if (sVal !== 'all' && paidStr !== sVal) return;

    const paidBadge = (plan.paymentReceived==='yes')
      ? '<span class="badge-ok pill">Yes</span>'
      : '<span class="badge-warn pill">No</span>';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.name||''}</td>
      <td>${c.phone||''}</td>
      <td>${c.email||''}</td>
      <td>${plan.planName||''}</td>
      <td>${paidBadge}</td>
      <td>${plan.startDate||''}</td>
      <td>${plan.expiryDate||''} ${daysLeftBadge(plan.expiryDate)}</td>
      <td class="flex" style="gap:6px;flex-wrap:wrap">
        <button class="btn ghost" data-view="${c.id}">View</button>
        <button class="btn secondary" data-edit="${c.id}">Edit</button>
        <button class="btn ok" data-renew="${c.id}">Renew</button>
        <button class="btn" data-invoice="${c.id}">Slip</button>
        <button class="btn danger" data-del="${c.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  $("#kpiCustomers").textContent = String(customers.length);

  tbody.querySelectorAll("[data-edit]").forEach(btn=> btn.onclick = ()=> openCustomerModal(btn.getAttribute('data-edit')));
  tbody.querySelectorAll("[data-del]").forEach(btn=> btn.onclick = async()=>{ const id = btn.getAttribute('data-del'); if(confirm("Delete this customer and all their renewals?")) await deleteCustomerAndRenewals(id); });
  tbody.querySelectorAll("[data-renew]").forEach(btn=> btn.onclick = ()=> openRenewModal(btn.getAttribute('data-renew')));
  tbody.querySelectorAll("[data-view]").forEach(btn=> btn.onclick = ()=> viewCustomer(btn.getAttribute('data-view')));
  tbody.querySelectorAll("[data-invoice]").forEach(btn=> btn.onclick = ()=> printInvoice(btn.getAttribute('data-invoice')));
}

function daysLeftBadge(exp){
  if(!exp) return '';
  const d = daysLeft(exp);
  if(d<0) return ` <span class="pill badge-exp">expired ${Math.abs(d)}d</span>`;
  if(d<=settingNear) return ` <span class="pill badge-warn">${d}d</span>`;
  return ` <span class="pill badge-ok">${d}d</span>`;
}

function renderNearExpiry(){
  const days = +$("#nearDays").value;
  const tbody = $("#nearGrid tbody"); tbody.innerHTML = "";
  const list = customers
    .map(c=> ({ c, plan: c.currentPlan||{} }))
    .filter(x => x.plan.expiryDate)
    .map(x => ({...x, left: daysLeft(x.plan.expiryDate)}))
    .filter(x => x.left >= 0 && x.left <= days)
    .sort((a,b)=> a.left - b.left);
  $("#nearExpCount").textContent = `Near expiry: ${list.length}`;
  list.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.c.name||''}</td>
      <td>${x.c.phone||''}</td>
      <td>${x.plan.planName||''}</td>
      <td>${x.plan.expiryDate||''}</td>
      <td>${x.left}d</td>
      <td><button class="btn ok" data-renew="${x.c.id}">Renew</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("[data-renew]").forEach(btn=> btn.onclick = ()=> openRenewModal(btn.getAttribute('data-renew')));
}

function renderKPIs(){
  let turnover=0, expense=0, profit=0;
  renewals.forEach(r=>{
    const f = calcFigures({
      cost:r.cost, wholesale:r.wholesale,
      stbIncluded:r.stbIncluded, stbCost:r.stbCost, stbWholesale:r.stbWholesale
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const p=plansCache.find(x=>x.id===b.dataset.edit);
        $('#p-id').value=p.id; $('#p-name').value=p.name||''; $('#p-price').value=p.price||'';
        $('#p-months').value=p.months||''; $('#p-benefit').value=p.benefit||''; $('#p-tag').value=p.tag||'';
        $('#p-desc').value=p.desc||''; $('#p-sort').value=p.sort||0; $('#p-active').value=String(p.active!==false);
      };
    turnover+=f.turnover; expense+=f.expense; profit+=f.profit;
  });
  $("#kpiTurnover").textContent = fmt(turnover);
  $("#kpiExpense").textContent  = fmt(expense);
  $("#kpiProfit").textContent   = fmt(profit);
}

/* =========================
   Customers: Add/Edit
   ========================= */
const custModal = $("#modalCustomer");
const custTitle = $("#custModalTitle");
$("#xCust").onclick = ()=>{ editCustomerId = null; custModal.classList.remove('open'); };
$("#c_stb").addEventListener('change', ()=>{ $("#stbBox").classList.toggle('hidden', $("#c_stb").value!=='yes'); previewTotals(); });
["#c_cost","#c_wholesale","#c_stbCost","#c_stbWholesale","#c_stb","#c_plan"].forEach(sel=> $(sel).addEventListener('input', previewTotals));
["#c_actual","#c_discName","#c_stbActual"].forEach(sel=> $(sel).addEventListener('input', previewTotals));
$("#c_start").addEventListener('change', ()=>{ const pid = $("#c_plan").value; const dur = plans[pid]?.duration_months ?? 0; $("#c_expiry").value = addMonthsISO($("#c_start").value, dur); });

const saveBtn = document.getElementById('btnSaveCustomer');
saveBtn.addEventListener('click', async (e) => {
  e.preventDefault(); e.stopPropagation();
  if (saveBtn.dataset.busy === '1') return;
  saveBtn.dataset.busy = '1';
  const old = saveBtn.textContent;
  saveBtn.textContent = 'Saving…';
  saveBtn.disabled = true;
  try { await saveCustomerFromModal(); }
  catch (err) { showErr('[save customer]', err); alert(err?.code ? `${err.code} — ${err.message}` : (err?.message||'Failed to save')); }
  finally { saveBtn.disabled = false; saveBtn.textContent = old; saveBtn.dataset.busy = '0'; }
});

let editCustomerId = null;

function refreshPlanSelects(){
  const selList = [$("#c_plan"), $("#r_plan")];
  selList.forEach(sel=>{
    if(!sel) return;
    const curr = sel.value;
    sel.innerHTML = "";
    const ids = Object.keys(plans).sort();
    ids.forEach(id=>{
      const p = plans[id];
      const opt = document.createElement('option');
      opt.value=id; opt.textContent=`${p.name} (${p.duration_months} mo)`;
      sel.appendChild(opt);
    });
    if(curr && plans[curr]) sel.value = curr;
  });
}
function previewTotals(){
  const stbIncluded = $("#c_stb").value;
  const f = calcFigures({
    cost:$("#c_cost").value, wholesale:$("#c_wholesale").value, actual:$("#c_actual").value,
    stbIncluded, stbCost:$("#c_stbCost").value, stbWholesale:$("#c_stbWholesale").value, stbActual:$("#c_stbActual").value
  });
  const discName = ($("#c_discName").value || "").trim();
  $("#c_preview").innerHTML = `
    Turnover: <strong>${fmt(f.turnover)}</strong><br>
    Expense: <strong>${fmt(f.expense)}</strong><br>
    Profit: <strong>${fmt(f.profit)}</strong><br>
    ${f.discountSaved > 0 ? `Customer discount: <strong>${fmt(f.discountSaved)}</strong>${discName ? ` <span class="chip">${discName}</span>`:''}` : `<span class="muted">No discount</span>`}
  `;
}

function openCustomerModal(id=null){
  editCustomerId = (typeof id === 'string') ? id : null;
  custTitle.textContent = id ? "Edit Customer" : "Add Customer";
  refreshPlanSelects();
  const firstPlanId = Object.keys(plans)[0];
  const defaults = firstPlanId ? plans[firstPlanId] : null;

  $("#c_name").value = ""; $("#c_phone").value= ""; $("#c_email").value= ""; $("#c_userId").value= ""; $("#c_mac").value= "";
  $("#c_plan").value = firstPlanId||"";
  $("#c_actual").value = defaults? (defaults.retail_price||"") : "";
  $("#c_cost").value = defaults? (defaults.retail_price||"") : "";
  $("#c_wholesale").value = defaults? (defaults.wholesale_cost||"") : "";
  $("#c_discName").value = "";
  $("#c_stb").value="no"; $("#stbBox").classList.add('hidden');
  $("#c_stbActual").value=""; $("#c_stbCost").value=""; $("#c_stbWholesale").value="";
  $("#c_start").value = todayISO();
  $("#c_expiry").value = defaults ? addMonthsISO($("#c_start").value, defaults.duration_months||0) : $("#c_start").value;
  $("#c_paid").value="yes";
  $("#c_preview").textContent="—";

  if(id){
    const c = customers.find(x=>x.id===id);
    if(c){
      $("#c_name").value=c.name||""; $("#c_phone").value=c.phone||""; $("#c_email").value=c.email||"";
      $("#c_userId").value=c.userId||""; $("#c_mac").value=c.mac||"";
      if(c.currentPlan){
        $("#c_plan").value=c.currentPlan.planId||firstPlanId||"";
        $("#c_actual").value=c.currentPlan.actual||"";
        $("#c_cost").value=c.currentPlan.cost||"";
        $("#c_wholesale").value=c.currentPlan.wholesale||"";
        $("#c_discName").value=c.currentPlan.discountName||"";
        $("#c_stb").value=c.currentPlan.stbIncluded||"no";
        $("#stbBox").classList.toggle('hidden', $("#c_stb").value!=='yes');
        $("#c_stbActual").value=c.currentPlan.stbActual||"";
        $("#c_stbCost").value=c.currentPlan.stbCost||"";
        $("#c_stbWholesale").value=c.currentPlan.stbWholesale||"";
        $("#c_start").value=c.currentPlan.startDate||todayISO();
        $("#c_expiry").value=c.currentPlan.expiryDate||addMonthsISO($("#c_start").value, plans[$("#c_plan").value]?.duration_months||0);
        $("#c_paid").value=c.currentPlan.paymentReceived||"yes";
      }
    }
  }
  $('#planNew').onclick=()=>{ ['p-id','p-name','p-price','p-months','p-benefit','p-tag','p-desc','p-sort'].forEach(id=>$('#'+id).value=''); $('#p-active').value='true'; };
  $('#planSave').onclick=async()=>{
    const id=$('#p-id').value.trim();
    const body={ name:$('#p-name').value.trim(), price:$('#p-price').value.trim(), months:Number($('#p-months').value||0),
      benefit:$('#p-benefit').value.trim(), tag:$('#p-tag').value.trim(), desc:$('#p-desc').value.trim(),
      sort:Number($('#p-sort').value||0), active:$('#p-active').value==='true', updatedAt:serverTimestamp() };
    if(!body.name||!body.price){ msg($('#planMsg'),'Name and Price required',false); return; }
    if(id){ await setDoc(doc(db,'plans',id),body,{merge:true}); } else { await addDoc(collection(db,'plans'),body); }
    await loadPlans(); msg($('#planMsg'),'Saved.');
  previewTotals();
  custModal.classList.add('open');
}

async function getLatestRenewalRef(customerId){
  const snap = await safeGetDocs(collection(db, "customers", String(customerId), "renewals"), '[renewals] list latest');
  let latest = null;
  snap.forEach(d => {
    const r = d.data() || {};
    const key = r.startDate || r.expiryDate || "";
    if (!latest || key > latest.key) latest = { key, ref: d.ref, id: d.id, data: r };
  });
  return latest?.ref || null;
}

async function saveCustomerFromModal(){
  const name=$("#c_name").value.trim();
  if(!name){ throw new Error("Name is required"); }
  const planId=$("#c_plan").value;
  const p=plans[planId]||{};
  const planName=p.name||"Custom";
  const durationMonths = +p.duration_months||0;

  const start=$("#c_start").value;
  let expiry=$("#c_expiry").value || addMonthsISO(start, durationMonths);
  if (!start || !expiry) throw new Error('Start and expiry dates are required');

  const currentPlan = {
    planId, planName, durationMonths,
    actual:+$("#c_actual").value||0, cost:+$("#c_cost").value||0, wholesale:+$("#c_wholesale").value||0,
    discountName: ($("#c_discName").value || "").trim(),
    stbIncluded:$("#c_stb").value,
    stbActual:+$("#c_stbActual").value||0, stbCost:+$("#c_stbCost").value||0, stbWholesale:+$("#c_stbWholesale").value||0,
    startDate:start, expiryDate:expiry, paymentReceived:$("#c_paid").value
  };
  $('#planDelete').onclick=async()=>{
    const id=$('#p-id').value.trim(); if(!id) return;
    if(confirm('Delete this plan?')){ await deleteDoc(doc(db,'plans',id)); await loadPlans(); msg($('#planMsg'),'Deleted.'); }

  const payload = {
    name, phone:$("#c_phone").value.trim(), email:$("#c_email").value.trim(),
    userId:$("#c_userId").value.trim(), mac:$("#c_mac").value.trim(),
    originalStartDate: (editCustomerId? (customers.find(x=>x.id===editCustomerId)?.originalStartDate || start) : start),
    currentPlan
  };
  $('#plansReload').onclick=loadPlans;

  /* BOXES */
  let boxesCache=[];
  async function loadBoxes(){
    const snap=await getDocs(collection(db,'boxes'));
    boxesCache=[]; snap.forEach(d=> boxesCache.push({id:d.id,...d.data()}));
    boxesCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderBoxesList();
  }
  function renderBoxesList(){
    const list=$('#boxesList'); list.innerHTML='';
    boxesCache.forEach(bx=>{
      const imgs=(bx.images||[]).map(u=>`<img class="thumb" src="${u}">`).join('');
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><span class="tag mini">${bx.tier||''}</span> <strong>${bx.name||''}</strong> <span class="muted">(${(bx.images||[]).length} img)</span></div>
          <div class="right"><strong>${bx.boxPrice||''}</strong> <span class="muted">sort:${bx.sort||0}</span> <span class="muted">${bx.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${bx.id}">Edit</button>
          </div>
        </div>
        <div class="imgRow" style="margin-top:6px">${imgs}</div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const x=boxesCache.find(z=>z.id===b.dataset.edit);
        $('#b-id').value=x.id; $('#b-tier').value=x.tier||''; $('#b-name').value=x.name||'';
        $('#b-sort').value=x.sort||0; $('#b-boxPrice').value=x.boxPrice||''; $('#b-active').value=String(x.active!==false);
        $('#b-c-price').value=x.combo?.price||''; $('#b-c-months').value=x.combo?.planMonths||12; $('#b-c-extra').value=x.combo?.extra||'';
        $('#b-desc').value=x.desc||''; $('#b-img-urls').value=(x.images||[]).join('\\n'); renderThumbs('#b-images', x.images||[]);
      };

  const cid = await saveCustomer(payload, editCustomerId ? String(editCustomerId) : null);

  if(!editCustomerId){
    await addRenewal(cid, {
      customerId: cid, customerName: name,
      planId, planName, durationMonths,
      actual: currentPlan.actual, cost: currentPlan.cost, wholesale: currentPlan.wholesale,
      stbIncluded: currentPlan.stbIncluded, stbActual: currentPlan.stbActual,
      stbCost: currentPlan.stbCost, stbWholesale: currentPlan.stbWholesale,
      discountName: currentPlan.discountName,
      startDate: start, expiryDate: expiry,
      paymentReceived: currentPlan.paymentReceived
    });
  }
  $('#b-img-urls').addEventListener('input', ()=> renderThumbs('#b-images', splitUrls($('#b-img-urls').value).slice(0,3)) );
  $('#boxNew').onclick=()=>{ ['b-id','b-tier','b-name','b-sort','b-boxPrice','b-c-price','b-c-months','b-c-extra','b-desc','b-img-urls'].forEach(i=>$('#'+i).value=''); $('#b-active').value='true'; $('#b-images').innerHTML=''; };
  $('#boxSave').onclick=async()=>{
    const id=$('#b-id').value.trim();
    const images=splitUrls($('#b-img-urls').value).slice(0,3);
    const body={ tier:$('#b-tier').value.trim(), name:$('#b-name').value.trim(), sort:Number($('#b-sort').value||0),
      boxPrice:$('#b-boxPrice').value.trim(), active:$('#b-active').value==='true',
      combo:{ price:$('#b-c-price').value.trim(), planMonths:Number($('#b-c-months').value||12), extra:$('#b-c-extra').value.trim() },
      desc:$('#b-desc').value.trim(), images, updatedAt:serverTimestamp() };
    if(!body.name){ msg($('#boxMsg'),'Model name required',false); return; }
    if(images.length===0){ msg($('#boxMsg'),'At least 1 image URL',false); return; }
    if(id){ await setDoc(doc(db,'boxes',id), body, {merge:true}); } else { await addDoc(collection(db,'boxes'), body); }
    await loadBoxes(); msg($('#boxMsg'),'Saved.');
  custModal.classList.remove('open');
  await loadCustomers();
  await loadRenewals();
  renderAll();

  if (editCustomerId) {
    const latestRef = await getLatestRenewalRef(editCustomerId);
    if (latestRef) {
      await safeUpdateDoc(latestRef, {
        planId, planName, durationMonths,
        cost: currentPlan.cost, wholesale: currentPlan.wholesale,
        stbIncluded: currentPlan.stbIncluded, stbCost: currentPlan.stbCost, stbWholesale: currentPlan.stbWholesale,
        startDate: currentPlan.startDate, expiryDate: currentPlan.expiryDate,
        paymentReceived: currentPlan.paymentReceived,
        customerId: editCustomerId, customerName: name, updatedAt: serverTimestamp()
      }, '[renewals] update latest');
    } else {
      await addRenewal(editCustomerId, {
        customerId: editCustomerId, customerName: name,
        planId, planName, durationMonths,
        cost: currentPlan.cost, wholesale: currentPlan.wholesale,
        stbIncluded: currentPlan.stbIncluded, stbCost: currentPlan.stbCost, stbWholesale: currentPlan.stbWholesale,
        startDate: currentPlan.startDate, expiryDate: currentPlan.expiryDate,
        paymentReceived: currentPlan.paymentReceived
      });
    }
  }

  runReport();
  if (document.querySelector("#c_invoice")?.checked) setTimeout(()=> printInvoice(cid), 200);
}

function viewCustomer(id){
  const c = customers.find(x=>x.id===id);
  if(!c){ alert("Customer not found"); return; }
  const cp = c.currentPlan||{};
  const figs = calcFigures({
    cost:cp.cost, wholesale:cp.wholesale, actual:cp.actual,
    stbIncluded:cp.stbIncluded, stbCost:cp.stbCost, stbWholesale:cp.stbWholesale, stbActual:cp.stbActual
  });
  alert(
`Customer: ${c.name}
Phone: ${c.phone||'-'}  Email: ${c.email||'-'}
User ID: ${c.userId||'-'}  MAC: ${c.mac||'-'}

Original Start: ${c.originalStartDate||'-'}
Current Plan: ${cp.planName||'-'} (${cp.durationMonths||0} mo)
This Plan Start: ${cp.startDate||'-'}  Expiry: ${cp.expiryDate||'-'}

This Plan:
  Turnover: ${fmt(figs.turnover)}
  Expense:  ${fmt(figs.expense)}
  Profit:   ${fmt(figs.profit)}
  Discount: ${fmt(figs.discountSaved)}${cp.discountName ? ' — '+cp.discountName : ''}

Tip: Use "Reports" tab for totals across all renewals.`)
}

/* =========================
   Renewals
   ========================= */
const renewModal = $("#modalRenew");
$("#xRenew").onclick = ()=> renewModal.classList.remove('open');
$("#r_stb").addEventListener('change', ()=>{ $("#r_stbBox").classList.toggle('hidden', $("#r_stb").value!=='yes'); });
let renewCustomerId = null;

function openRenewModal(id){
  renewCustomerId = id;
  refreshPlanSelects();
  const c = customers.find(x=>x.id===id);
  $("#renewTitle").textContent = `Renew: ${c?.name||id}`;
  const cp = c?.currentPlan||{};
  $("#r_plan").value = cp.planId||Object.keys(plans)[0]||"";
  const p = plans[$("#r_plan").value]||{};
  $("#r_actual").value = cp.actual || p.retail_price || "";
  $("#r_cost").value = cp.cost || p.retail_price || "";
  $("#r_wholesale").value = cp.wholesale || p.wholesale_cost || "";
  $("#r_discName").value = cp.discountName || "";
  $("#r_stb").value = "no"; $("#r_stbBox").classList.add('hidden');
  $("#r_stbActual").value = ""; $("#r_stbCost").value = ""; $("#r_stbWholesale").value="";
  const defStart = cp.expiryDate ? addMonthsISO(cp.expiryDate, 0) : todayISO();
  $("#r_start").value = defStart;
  $("#r_expiry").value = addMonthsISO(defStart, p.duration_months||0);
  $("#r_paid").value = "yes";

  $("#r_plan").onchange = ()=>{
    const p2 = plans[$("#r_plan").value]||{};
    $("#r_expiry").value = addMonthsISO($("#r_start").value, p2.duration_months||0);
    if(!cp.actual){ $("#r_actual").value = p2.retail_price||""; }
    if(!cp.cost){ $("#r_cost").value = p2.retail_price||""; }
    if(!cp.wholesale){ $("#r_wholesale").value = p2.wholesale_cost||""; }
  };
  $('#boxDelete').onclick=async()=>{
    const id=$('#b-id').value.trim(); if(!id) return;
    if(confirm('Delete this box?')){ await deleteDoc(doc(db,'boxes',id)); await loadBoxes(); msg($('#boxMsg'),'Deleted.'); }
  $("#r_start").onchange = ()=>{
    const p2 = plans[$("#r_plan").value]||{};
    $("#r_expiry").value = addMonthsISO($("#r_start").value, p2.duration_months||0);
  };
  $('#boxesReload').onclick=loadBoxes;

  /* BANNERS */
  let bannersCache=[];
  async function loadBanners(){
    const snap=await getDocs(collection(db,'banners'));
    bannersCache=[]; snap.forEach(d=> bannersCache.push({id:d.id,...d.data()}));
    bannersCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderBannersList();

  renewModal.classList.add('open');
}
$("#btnDoRenew").onclick = async ()=>{
  const c = customers.find(x=>x.id===renewCustomerId);
  if(!c){ alert("Missing customer"); return; }
  const planId = $("#r_plan").value;
  const p = plans[planId]||{};
  const planName = p.name||'Custom';
  const durationMonths = +p.duration_months||0;
  const start = $("#r_start").value;
  const expiry= $("#r_expiry").value || addMonthsISO(start, durationMonths);

  const ren = {
    customerId: String(renewCustomerId), customerName: c.name||'',
    planId, planName, durationMonths,
    actual:+$("#r_actual").value||0, cost:+$("#r_cost").value||0, wholesale:+$("#r_wholesale").value||0,
    stbIncluded:$("#r_stb").value,
    stbActual:+$("#r_stbActual").value||0, stbCost:+$("#r_stbCost").value||0, stbWholesale:+$("#r_stbWholesale").value||0,
    discountName: ($("#r_discName").value || "").trim(),
    startDate:start, expiryDate:expiry,
    paymentReceived: $("#r_paid").value
  };
  await addRenewal(String(renewCustomerId), ren);
  await setCustomerCurrentPlan(String(renewCustomerId), ren);
  renewModal.classList.remove('open');
  await loadCustomers();
  await loadRenewals();
  renderAll();
  runReport();
  if (document.querySelector("#r_invoice")?.checked) setTimeout(()=> printInvoice(renewCustomerId), 200);
};

/* =========================
   Plans modal
   ========================= */
const planModal = $("#modalPlan");
$("#xPlan").onclick = ()=> planModal.classList.remove('open');
function openPlanModal(p=null){
  $("#planTitle").textContent = p? "Edit Plan":"Add Plan";
  $("#p_id").value = p?.id||"";
  $("#p_name").value = p?.name||"";
  $("#p_months").value = p?.duration_months||1;
  $("#p_retail").value = p?.retail_price||"";
  $("#p_wholesale").value = p?.wholesale_cost||"";
  $("#p_desc").value = p?.description||"";
  planModal.classList.add('open');
}
$("#btnSavePlan").onclick = async ()=>{
  const pid = $("#p_id").value.trim();
  if(!pid){ alert("Plan ID required"); return; }
  await savePlan({
    id: pid,
    name: $("#p_name").value.trim(),
    duration_months: +$("#p_months").value||0,
    retail_price: +$("#p_retail").value||0,
    wholesale_cost: +$("#p_wholesale").value||0,
    description: $("#p_desc").value.trim()
  });
  planModal.classList.remove('open');
};

/* =========================
   Seed sample plans
   ========================= */
async function seedPlans(){
  const samples = [
    {id:"PLN-1MO", name:"1 month", duration_months:1, retail_price:15, wholesale_cost:4.5, description:"Entry plan"},
    {id:"PLN-3MO", name:"3 months", duration_months:3, retail_price:35, wholesale_cost:13.5, description:"Most popular"},
    {id:"PLN-6MO", name:"6 months", duration_months:6, retail_price:60, wholesale_cost:25, description:"Value saver"}
  ];
  for(const p of samples){ await savePlan(p); }
  alert("Sample plans added.");
}

/* =========================
   Reports
   ========================= */
function onRepTypeChange(){
  const t = $("#repType").value;
  $("#repMonthCol").classList.toggle('hidden', t!=="monthly");
  $("#repYearCol").classList.toggle('hidden', t==="monthly" ? true : (t!=="yearly"));
  $("#repFromCol").classList.toggle('hidden', t!=="custom");
  $("#repToCol").classList.toggle('hidden', t!=="custom");
  if(t==="monthly"){ $("#repYearCol").classList.add('hidden'); }
}
function filterRenewalsByPeriod(){
  const t = $("#repType").value;
  let from, to;
  if (t === "monthly") {
    let ym = $("#repMonth").value || new Date().toISOString().slice(0,7);
    $("#repMonth").value = ym;
    from = ym + "-01";
    const [y, m] = ym.split("-").map(Number);
    const last = new Date(y, m, 0).getDate();
    to = ym + "-" + String(last).padStart(2, "0");
  } else if (t === "yearly") {
    const y = +$("#repYear").value;
    if (!y) return {arr: [], from: undefined, to: undefined};
    from = y + "-01-01"; to = y + "-12-31";
  } else {
    from = $("#repFrom").value; to = $("#repTo").value;
    if (!from || !to) return {arr: [], from: undefined, to: undefined};
  }
  function renderBannersList(){
    const list=$('#bannersList'); list.innerHTML='';
    bannersCache.forEach(bn=>{
      const imgs=(bn.images||[]).map(u=>`<img class="thumb" src="${u}">`).join('');
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><strong>${bn.title||''}</strong> <span class="muted">(${(bn.images||[]).length} img)</span></div>
          <div class="right"><span class="muted">sort:${bn.sort||0}</span> <span class="muted">${bn.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${bn.id}">Edit</button>
          </div>
        </div>
        <div class="imgRow" style="margin-top:6px">${imgs}</div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const x=bannersCache.find(z=>z.id===b.dataset.edit);
        $('#bn-id').value=x.id; $('#bn-title').value=x.title||''; $('#bn-sort').value=x.sort||0; $('#bn-active').value=String(x.active!==false);
        $('#bn-img-urls').value=(x.images||[]).join('\\n'); renderThumbs('#bn-images', x.images||[]);
      };
    });
  const arr = renewals.filter(r => r.startDate >= from && r.startDate <= to);
  return {arr, from, to};
}
function runReport(){
  const out = filterRenewalsByPeriod();
  if(!out || !out.arr){ alert("Select a valid period."); return; }
  const rows = out.arr.sort((a,b)=> a.startDate.localeCompare(b.startDate));
  const tbody = $("#repGrid tbody"); tbody.innerHTML="";
  let T=0,E=0,P=0;
  rows.forEach(r=>{
    const f = calcFigures({ cost:r.cost, wholesale:r.wholesale, stbIncluded:r.stbIncluded, stbCost:r.stbCost, stbWholesale:r.stbWholesale });
    T+=f.turnover; E+=f.expense; P+=f.profit;
    const payload = {
      id: r.id, customerId: r.customerId, customerName: r.customerName,
      planId: r.planId, planName: r.planName, durationMonths: r.durationMonths,
      actual: r.actual, cost: r.cost, wholesale: r.wholesale,
      stbIncluded: r.stbIncluded, stbActual: r.stbActual, stbCost: r.stbCost, stbWholesale: r.stbWholesale,
      discountName: r.discountName, startDate: r.startDate, expiryDate: r.expiryDate, paymentReceived: r.paymentReceived
    };
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.startDate}</td>
      <td>${r.customerName||r.customerId}</td>
      <td>${r.planName||r.planId} (${r.durationMonths||0}mo)</td>
      <td>${f.turnover.toFixed(2)}</td>
      <td>${f.expense.toFixed(2)}</td>
      <td>${f.profit.toFixed(2)}</td>
      <td>${r.paymentReceived==='yes'?'Yes':'No'}</td>
      <td><button class="btn" data-inv-ren="${encoded}">Slip</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("[data-inv-ren]").forEach(btn=> btn.onclick = ()=> printInvoiceFromRenewalData(btn.getAttribute("data-inv-ren")));
  $("#repTurnover").textContent = fmt(T);
  $("#repExpense").textContent  = fmt(E);
  $("#repProfit").textContent   = fmt(P);
}
function exportCSV(){
  const rows = [["Date","Customer","Plan","Turnover","Expense","Profit","Paid"]];
  document.querySelectorAll("#repGrid tbody tr").forEach(tr=>{
    const cols = [...tr.children].slice(0,7).map(td => td.textContent);
    rows.push(cols);
  });
  const csvStr = "\uFEFF" + rows.map(r => r.map(x => `"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csvStr], { type: "text/csv;charset=utf-8;" });
  const canDownloadAttr = "download" in HTMLAnchorElement.prototype;
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (canDownloadAttr && !isIOS) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "report.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } else {
    const dataUrl = "data:text/csv;charset=utf-8," + encodeURIComponent(csvStr);
    window.open(dataUrl, "_blank");
  }
  $('#bnNew').onclick=()=>{ ['bn-id','bn-title','bn-sort','bn-img-urls'].forEach(i=>$('#'+i).value=''); $('#bn-active').value='true'; $('#bn-images').innerHTML=''; };
  $('#bn-img-urls').addEventListener('input', ()=> renderThumbs('#bn-images', splitUrls($('#bn-img-urls').value)) );
  $('#bnSave').onclick=async()=>{
    const id=$('#bn-id').value.trim();
    const images=splitUrls($('#bn-img-urls').value);
    const body={ title:$('#bn-title').value.trim(), sort:Number($('#bn-sort').value||0), active:$('#bn-active').value==='true', images, updatedAt:serverTimestamp() };
    if(!images.length){ msg($('#bnMsg'),'At least one image URL',false); return; }
    if(id){ await setDoc(doc(db,'banners',id), body, {merge:true}); } else { await addDoc(collection(db,'banners'), body); }
    await loadBanners(); msg($('#bnMsg'),'Saved.');
  };
  $('#bnDelete').onclick=async()=>{
    const id=$('#bn-id').value.trim(); if(!id) return;
    if(confirm('Delete this banner?')){ await deleteDoc(doc(db,'banners',id)); await loadBanners(); msg($('#bnMsg'),'Deleted.'); }
  };
  $('#bnReload').onclick=loadBanners;

  /* POSTERS */
  let postersCache=[];
  async function loadPosters(){
    const snap=await getDocs(collection(db,'posters'));
    postersCache=[]; snap.forEach(d=> postersCache.push({id:d.id,...d.data()}));
    postersCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderPostersList();
}

/* =========================
   Slip generation
   ========================= */
const LOGO_SVG = `
<svg xmlns='http://www.w3.org/2000/svg' width='180' height='36' viewBox='0 0 430 86'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
    <stop offset='0' stop-color='#6a8cff'/><stop offset='1' stop-color='#8a5fff'/></linearGradient></defs>
  <rect rx='12' ry='12' width='86' height='86' fill='url(#g)'/>
  <circle cx='43' cy='43' r='24' fill='none' stroke='white' stroke-width='8'/>
  <path d='M108 62 h34 v-38 h-34 v38 M149 24 h14 v38 h-14 z' fill='url(#g)'/>
  <text x='170' y='60' font-family='Segoe UI, Roboto, Arial' font-size='44' font-weight='800' fill='white' letter-spacing='.5'>Net + TV</text>
</svg>`;
const LOGO_URL = "data:image/svg+xml;utf8," + encodeURIComponent(LOGO_SVG);

function buildSlipHTML({invNo, today, billTo, contactLine, metaLine, plan, lines, total, paidBadge, discountBlock}){
  return `
<!doctype html><html><head><meta charset="utf-8"><title>${invNo}</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
  :root{ --ink:#111; --muted:#666; --line:#e5e7eb; --bg:#fff; --pill:#f3f4f6; --ok:#16a34a; --warn:#b91c1c; --safe-bottom: env(safe-area-inset-bottom,0px); }
  *{ box-sizing:border-box } body{ font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ink); background:#fff; margin:24px; padding-bottom: calc(24px + var(--safe-bottom)); }
  .hdr{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap }
  .brand{ display:flex; gap:12px; align-items:center } .brand img{ height:42px } .brand h2{ margin:0; font-size:22px }
  .muted{ color:var(--muted) } .box{ border:1px solid var(--line); border-radius:10px; padding:14px; margin-top:14px }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 16px; }
  .grid .lbl{ color:var(--muted) } table{ width:100%; border-collapse:collapse; margin-top:12px }
  th,td{ padding:10px; border-bottom:1px solid var(--line); text-align:left; font-size:14px } th{ background:#fafafa }
  .right{ text-align:right } .totals td{ font-weight:700 } .badge{ display:inline-block; background:var(--pill); padding:4px 8px; border-radius:999px; font-size:12px }
  .paid{ color:var(--ok) } .unpaid{ color:var(--warn) } .strike{ text-decoration: line-through; opacity:.7; margin-right:6px }
  @media print{ button{ display:none } body{ margin:0; } }
</style></head><body>
  <div class="hdr">
    <div class="brand">
      <img src="${LOGO_URL}" alt="Net + TV">
      <div><h2 style="margin:0">Sale Slip</h2><div class="muted">Net + TV</div></div>
    </div>
    <div class="right"><div><strong>${invNo}</strong></div><div>Date: ${today}</div></div>
  </div>

  <div class="box"><strong>Bill To</strong><br>${billTo}<br>${contactLine}${metaLine ? `<div class="muted">${metaLine}</div>` : ""}</div>

  <div class="box">
    <strong>Plan Details</strong>
    <div class="grid" style="margin-top:8px">
      <div class="lbl">Plan</div><div>${plan?.name || '-'}</div>
      <div class="lbl">Duration</div><div>${(plan?.months ?? 0)} months</div>
      <div class="lbl">Parental Pin</div><div>7274</div>
      <div class="lbl">Start Date</div><div>${plan?.start || '-'}</div>
      <div class="lbl">Expiry Date</div><div>${plan?.expiry || '-'}</div>
      <div class="lbl">Payment</div><div>${plan?.paidText || '-'}</div>
    </div>
  </div>

  <table>
    <thead><tr><th>Description</th><th class="right">Amount (CAD)</th></tr></thead>
    <tbody>
      ${lines.map(l=>`<tr><td>${l[0]}</td><td class="right">${(+l[1]||0).toFixed(2)}</td></tr>`).join("")}
      ${discountBlock || ""}
      <tr class="totals"><td>Total</td><td class="right">${(+total||0).toFixed(2)}</td></tr>
    </tbody>
  </table>

  <div class="badge ${plan?.paidText==='Paid'?'paid':'unpaid'}" style="margin-top:8px">${paidBadge}</div>
  <p class="muted">Thank you.</p>
  <button onclick="window.print()">Print / Save as PDF</button>
</body></html>`;
}
function openPrintWindow(html){
  const w = window.open("", "_blank");
  if(!w){ alert("Pop-up blocked. Please allow pop-ups for this site."); return; }
  w.document.open(); w.document.write(html); w.document.close(); w.onload = ()=> w.print();
}
function printInvoice(customerId){
  const c = customers.find(x=> String(x.id) === String(customerId));
  if(!c){ alert("Customer not found"); return; }
  const p = c.currentPlan || {};
  const f = calcFigures({ cost:p.cost, wholesale:p.wholesale, actual:p.actual, stbIncluded:p.stbIncluded, stbCost:p.stbCost, stbWholesale:p.stbWholesale, stbActual:p.stbActual });
  const today = new Date().toISOString().slice(0,10);
  const invNo = `SLIP-${String(customerId).slice(-6).toUpperCase()}-${today.replaceAll('-','')}`;
  const planBlock = { name: `${p.planName || 'Plan'}`, months: +p.durationMonths || 0, start: p.startDate || '-', expiry: p.expiryDate || '-', paidText: (p.paymentReceived==='yes' ? 'Paid' : 'Unpaid') };
  const lines = [];
  const planLineLabel = `Plan — ${p.planName||'Plan'} (${p.durationMonths||0} mo)`;
  if (+p.actual > 0) { lines.push([`${planLineLabel} <span class="muted"><span class="strike">${fmt(+p.actual)}</span> now</span>`, +p.cost||0]); }
  else { lines.push([planLineLabel, +p.cost||0]); }
  if (p.stbIncluded==='yes') {
    if (+p.stbActual > 0) { lines.push([`STB <span class="muted"><span class="strike">${fmt(+p.stbActual)}</span> now</span>`, +p.stbCost||0]); }
    else { lines.push([`STB`, +p.stbCost||0]); }
  }
  function renderPostersList(){
    const list=$('#postersList'); list.innerHTML='';
    postersCache.forEach(ps=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><strong>${ps.title||''}</strong> <span class="muted">${ps.ratio||''}</span></div>
          <div class="right"><span class="muted">sort:${ps.sort||0}</span> <span class="muted">${ps.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${ps.id}">Edit</button>
          </div>
        </div>
        ${ps.image?`<img class="thumb" src="${ps.image}" style="margin-top:6px">`:''}`;
      list.appendChild(div);
  const discountName = (p.discountName || "").trim();
  const discountBlock = (f.discountSaved > 0) ? `<tr><td>${discountName ? `Discount — ${discountName}` : 'Discount'}</td><td class="right">-${f.discountSaved.toFixed(2)}</td></tr>` : "";
  const html = buildSlipHTML({
    invNo, today, billTo: c.name || "-", contactLine: [c.phone, c.email].filter(Boolean).join(" • ") || "",
    metaLine: [c.userId && `User ID: ${c.userId}`, c.mac && `MAC: ${c.mac}`].filter(Boolean).join(" • "),
    plan: planBlock, lines, total: f.turnover, paidBadge: (p.paymentReceived==='yes' ? 'Paid' : 'Unpaid'), discountBlock
  });
  openPrintWindow(html);
}
function printInvoiceFromRenewalData(encoded){
  try{
    const ren = JSON.parse(decodeURIComponent(escape(atob(encoded))));
    const c = customers.find(x=> String(x.id) === String(ren.customerId)) || {};
    const f = calcFigures({ cost:ren.cost, wholesale:ren.wholesale, actual:ren.actual, stbIncluded:ren.stbIncluded, stbCost:ren.stbCost, stbWholesale:ren.stbWholesale, stbActual:ren.stbActual });
    const today = new Date().toISOString().slice(0,10);
    const suffix = ren.id ? ren.id.slice(-6).toUpperCase() : (ren.startDate?.replaceAll('-','')||today.replaceAll('-',''));
    const invNo = `SLIP-${String(ren.customerId).slice(-6).toUpperCase()}-${suffix}`;
    const planBlock = { name: `${ren.planName || 'Plan'}`, months: +ren.durationMonths || 0, start: ren.startDate || '-', expiry: ren.expiryDate || '-', paidText: (ren.paymentReceived==='yes' ? 'Paid' : 'Unpaid') };
    const lines = [];
    const planLineLabel = `Plan — ${ren.planName||ren.planId||'Plan'} (${ren.durationMonths||0} mo)`;
    if (+ren.actual > 0) { lines.push([`${planLineLabel} <span class="muted"><span class="strike">${fmt(+ren.actual)}</span> now</span>`, +ren.cost||0]); }
    else { lines.push([planLineLabel, +ren.cost||0]); }
    if (ren.stbIncluded==='yes') {
      if (+ren.stbActual > 0) { lines.push([`STB <span class="muted"><span class="strike">${fmt(+ren.stbActual)}</span> now</span>`, +ren.stbCost||0]); }
      else { lines.push([`STB`, +ren.stbCost||0]); }
    }
    const discountName = (ren.discountName || "").trim();
    const discountBlock = (f.discountSaved > 0) ? `<tr><td>${discountName ? `Discount — ${discountName}` : 'Discount'}</td><td class="right">-${f.discountSaved.toFixed(2)}</td></tr>` : "";
    const html = buildSlipHTML({
      invNo, today, billTo: ren.customerName || c.name || "-", contactLine: [c.phone, c.email].filter(Boolean).join(" • "),
      metaLine: [c.userId && `User ID: ${c.userId}`, c.mac && `MAC: ${c.mac}`].filter(Boolean).join(" • "),
      plan: planBlock, lines, total: f.turnover, paidBadge: (ren.paymentReceived==='yes' ? 'Paid' : 'Unpaid'), discountBlock
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const x=postersCache.find(z=>z.id===b.dataset.edit);
        $('#ps-id').value=x.id; $('#ps-title').value=x.title||''; $('#ps-ratio').value=x.ratio||'2:3'; $('#ps-sort').value=x.sort||0;
        $('#ps-active').value=String(x.active!==false); $('#ps-url').value=x.image||'';
        const th=$('#ps-thumb'); if(x.image){ th.src=x.image; th.classList.remove('hidden'); } else { th.classList.add('hidden'); }
      };
    openPrintWindow(html);
  }catch(e){ showErr('[print from renewal]', e); alert("Could not open slip for this row."); }
}

/* =========================
   Cleanup Orphan Renewals
   ========================= */
async function cleanupOrphanRenewals(){
  const msg = $("#cleanupMsg");
  const btn = $("#btnCleanupOrphans");
  try{
    btn.disabled = true;
    msg.textContent = "Scanning…";

    // Ensure we have a fresh customers list
    await loadCustomers();

    // Build a set of valid customer IDs
    const existing = new Set(customers.map(c => String(c.id)));

    // Fetch all renewals via collectionGroup (rules must allow)
    const snap = await safeGetDocs(collectionGroup(db, "renewals"), "[cleanup] collectionGroup renewals");
    const orphans = [];
    snap.forEach(d => {
      const data = d.data() || {};
      const cid  = String(data.customerId || "");
      if (!existing.has(cid)) {
        orphans.push(d.ref);
      }
    });

    if (orphans.length === 0){
      msg.textContent = "No orphan renewals found.";
      return;
    }

    msg.textContent = `Deleting ${orphans.length} orphan renewals…`;

    // Delete in chunks to avoid batch limits
    const CHUNK = 400;
    for (let i = 0; i < orphans.length; i += CHUNK){
      const batch = writeBatch(db);
      for (let j = i; j < Math.min(i + CHUNK, orphans.length); j++){
        batch.delete(orphans[j]);
      }
      await batch.commit();
    }

    await loadRenewals();
    renderKPIs();
    runReport();
    msg.textContent = `Deleted ${orphans.length} orphan renewals.`;
  }catch(err){
    showErr("[cleanup orphans]", err);
    alert(err?.message || "Failed to clean up orphan renewals");
    msg.textContent = "Error during cleanup.";
  }finally{
    btn.disabled = false;
  }
  $('#psNew').onclick=()=>{ ['ps-id','ps-title','ps-sort','ps-url'].forEach(i=>$('#'+i).value=''); $('#ps-active').value='true'; $('#ps-ratio').value='2:3'; $('#ps-thumb').classList.add('hidden'); };
  $('#psSave').onclick=async()=>{
    const id=$('#ps-id').value.trim();
    const body={ title:$('#ps-title').value.trim(), ratio:$('#ps-ratio').value, sort:Number($('#ps-sort').value||0), active:$('#ps-active').value==='true', image:$('#ps-url').value||'', updatedAt:serverTimestamp() };
    if(!body.title || !body.image){ msg($('#psMsg'),'Title and image URL required',false); return; }
    if(id){ await setDoc(doc(db,'posters',id), body, {merge:true}); } else { await addDoc(collection(db,'posters'), body); }
    await loadPosters(); msg($('#psMsg'),'Saved.');
  };
  $('#psDelete').onclick=async()=>{
    const id=$('#ps-id').value.trim(); if(!id) return;
    if(confirm('Delete this poster?')){ await deleteDoc(doc(db,'posters',id)); await loadPosters(); msg($('#psMsg'),'Deleted.'); }
  };
  $('#psReload').onclick=loadPosters;
}

/* =========================
   END
   ========================= */
</script>

</body>
</html>
</script>

</body>
</html>
