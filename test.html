<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1" />
<title>net+TV â€” Admin</title>
<meta name="theme-color" content="#0b1020" />
<style>
  :root{--bg:#0b1020;--ink:#e9edff;--muted:#a9b5e6;--card:#121831;--line:#23305b;--g1:#6a11cb;--g2:#2575fc;--ok:#31d296;--bad:#ff7b7b}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink)}
  a{color:inherit}
  .top{position:sticky;top:0;z-index:30;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(11,16,32,.95),rgba(11,16,32,.7));backdrop-filter:blur(8px)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.05);cursor:pointer}
  .btn.primary{background:linear-gradient(135deg, rgba(106,17,203,.45), rgba(37,117,252,.45));border-color:#3b4f8f}
  .btn.link{background:linear-gradient(135deg, rgba(106,17,203,.25), rgba(37,117,252,.25))}
  .muted{color:var(--muted);font-size:12px}
  .success{color:var(--ok)} .danger{color:var(--bad)}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:1fr 1fr 1fr}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1430;color:#fff}
  textarea{min-height:86px}
  .card{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:14px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.04);cursor:pointer}
  .tab.active{background:linear-gradient(135deg,rgba(106,17,203,.18),rgba(37,117,252,.18))}
  .list{display:grid;gap:10px}
  .item{border:1px dashed var(--line);border-radius:12px;padding:10px}
  .split{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .right{display:flex;gap:6px;align-items:center}
  .mini{font-size:12px}
  .tag{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:linear-gradient(135deg,var(--g1),var(--g2))}
  .imgRow{display:flex;gap:8px;flex-wrap:wrap}
  .thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#000}
  .authCard{position:absolute;right:0;top:42px;width:300px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);display:none;z-index:40}
  .authCard.open{display:block}
</style>
</head>
<body>
  <div class="top">
    <div class="row">
      <strong>net+TV Admin</strong>
      <span class="muted mini">| Firestore (URL images) â€¢ Anyone signed in can edit</span>
    </div>
    <div class="row">
      <a class="btn link" href="https://beta.gpanel.me/login" target="_blank" rel="noopener">Glo TV</a>
      <a class="btn link" href="https://bill.spicetv.cc/login" target="_blank" rel="noopener">Spice4K</a>
      <a class="btn link" href="https://fast4k.cc/login" target="_blank" rel="noopener">Smart 4K</a>
      <a class="btn link" href="data.html" target="_blank" rel="noopener">Users Data</a>
      <a class="btn link" href="https://postimages.org" target="_blank" rel="noopener">Upload Images</a>

      <div style="position:relative">
        <button id="authToggle" class="btn">Sign in</button>
        <div id="authCard" class="authCard">
          <div class="grid">
            <div class="muted mini">Firebase Email/Password</div>
            <input id="authEmail" placeholder="you@example.com" type="email">
            <input id="authPass" placeholder="password" type="password">
            <div class="row">
              <button id="emailSignIn" class="btn primary">Sign in</button>
              <button id="emailRegister" class="btn">Register</button>
            </div>
            <button id="googleSignIn" class="btn">Sign in with Google</button>
            <div id="authMsg" class="muted"></div>
          </div>
        </div>
      </div>

      <span id="userInfo" class="muted mini">Not signed in</span>
      <button id="signOutBtn" class="btn" style="display:none">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <div id="editor" class="hidden">
      <div class="tabs">
        <button class="tab active" data-tab="settings">Settings & Text</button>
        <button class="tab" data-tab="plans">Plans</button>
        <button class="tab" data-tab="boxes">Boxes</button>
        <button class="tab" data-tab="banners">Banners</button>
        <button class="tab" data-tab="posters">Posters</button>
      </div>

      <!-- SETTINGS & TEXT -->
      <section id="tab-settings" class="grid" style="margin-top:12px">
        <div class="card">
          <h3>Homepage Text</h3>
          <div class="grid three">
            <div><label>Hero Subtitle</label><input id="set-hero-subtitle" placeholder="Quick Activation"></div>
            <div><label>Hero Title</label><input id="set-hero-title" placeholder="20,000+ Live Channels, All Shows, Movies & PPV"></div>
            <div><label>Hero Subline</label><input id="set-hero-subline" placeholder="Latest + classic Movies & Series â€¢ Full HD & SD Channels â€¢ Anti-Freeze Tech"></div>
          </div>
          <div class="grid two">
            <div><label>CTA Buttons (comma separated, 4)</label><input id="set-ctas" placeholder="Our Plans, New Boxes, Renew Plan, Contact Support"></div>
            <div><label>Feature Ticker (comma separated)</label><input id="set-features" placeholder="ðŸ‡¨ðŸ‡¦ Proudly Canadian, Zero Latency Streams, 24/7 Support, Multi-Device"></div>
          </div>
        </div>

        <div class="card">
          <h3>Site Settings</h3>
          <div class="grid three">
            <div>
              <label>Default Theme</label>
              <select id="set-theme"><option>dark</option><option>light</option></select>
            </div>
            <div>
              <label>WhatsApp Number (no +)</label>
              <input id="set-wa" placeholder="16476961656" />
            </div>
            <div>
              <label>Notes</label>
              <input id="set-notes" placeholder="Internal note (optional)">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="saveSettings" class="btn primary">Save Settings</button>
            <div id="settingsMsg" class="muted"></div>
          </div>
        </div>

        <div class="card">
          <h3>Help</h3>
          <div class="muted">All images are URLs. Banners must be 1280Ã—720. Box images 16:9. Posters 2:3 or 16:9. If you paste potato-quality images, customers will see potato-quality images.</div>
        </div>
      </section>

      <!-- PLANS -->
      <section id="tab-plans" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Plan</h3>
          <div class="grid three">
            <div><label>Name</label><input id="p-name"></div>
            <div><label>Price (e.g., CA$100)</label><input id="p-price"></div>
            <div><label>Months</label><input id="p-months" type="number" min="1"></div>
          </div>
          <div class="grid three">
            <div><label>Benefit</label><input id="p-benefit" placeholder="+1 month free"></div>
            <div><label>Tag</label><input id="p-tag" placeholder="Popular / Best Value"></div>
            <div><label>Sort</label><input id="p-sort" type="number" value="10"></div>
          </div>
          <div class="grid two">
            <div><label>Description</label><input id="p-desc" placeholder="Short description"></div>
            <div><label>Active</label><select id="p-active"><option>true</option><option>false</option></select></div>
          </div>
          <div class="row">
            <button id="planSave" class="btn primary">Save</button>
            <button id="planNew" class="btn">New</button>
            <button id="planDelete" class="btn">Delete</button>
            <div id="planMsg" class="muted"></div>
          </div>
          <input id="p-id" type="hidden">
        </div>

        <div class="card">
          <div class="split"><h3>Plans</h3><button id="plansReload" class="btn">Reload</button></div>
          <div id="plansList" class="list"></div>
        </div>
      </section>

      <!-- BOXES -->
      <section id="tab-boxes" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Box</h3>
          <div class="grid three">
            <div><label>Tier badge</label><input id="b-tier" placeholder="Basic Box / Good Box"></div>
            <div><label>Model name</label><input id="b-name" placeholder="X-100"></div>
            <div><label>Sort</label><input id="b-sort" type="number" value="10"></div>
          </div>
          <div class="grid two">
            <div><label>Box Price</label><input id="b-boxPrice" placeholder="CA$120"></div>
            <div><label>Active</label><select id="b-active"><option>true</option><option>false</option></select></div>
          </div>
          <div class="grid three">
            <div><label>Combo Price</label><input id="b-c-price" placeholder="CA$199"></div>
            <div><label>Combo Months</label><input id="b-c-months" type="number" value="12"></div>
            <div><label>Combo Extra</label><input id="b-c-extra" placeholder="+1 month free"></div>
          </div>
          <div><label>Description</label><input id="b-desc" placeholder="Short description"></div>

          <div class="grid">
            <label>Image URLs (1â€“3, one per line)</label>
            <textarea id="b-img-urls" placeholder="https://.../1280x720-1.jpg
https://.../1280x720-2.jpg"></textarea>
            <div id="b-images" class="imgRow"></div>
          </div>

          <div class="row">
            <button id="boxSave" class="btn primary">Save</button>
            <button id="boxNew" class="btn">New</button>
            <button id="boxDelete" class="btn">Delete</button>
            <div id="boxMsg" class="muted"></div>
          </div>
          <input id="b-id" type="hidden">
        </div>

        <div class="card">
          <div class="split"><h3>Boxes</h3><button id="boxesReload" class="btn">Reload</button></div>
          <div id="boxesList" class="list"></div>
        </div>
      </section>

      <!-- BANNERS -->
      <section id="tab-banners" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Banner</h3>
          <div class="grid two">
            <div><label>Title</label><input id="bn-title" placeholder="Promo title"></div>
            <div><label>Sort</label><input id="bn-sort" type="number" value="10"></div>
          </div>
          <div class="grid two">
            <div><label>Active</label><select id="bn-active"><option>true</option><option>false</option></select></div>
            <div><label>Image URLs (one per line, 1280Ã—720)</label></div>
          </div>
          <textarea id="bn-img-urls" placeholder="https://.../banner-1-1280x720.jpg
https://.../banner-2-1280x720.jpg"></textarea>
          <div id="bn-images" class="imgRow" style="margin-top:6px"></div>
          <div class="row">
            <button id="bnSave" class="btn primary">Save</button>
            <button id="bnNew" class="btn">New</button>
            <button id="bnDelete" class="btn">Delete</button>
            <div id="bnMsg" class="muted"></div>
          </div>
          <input id="bn-id" type="hidden">
        </div>

        <div class="card">
          <div class="split"><h3>Banners</h3><button id="bnReload" class="btn">Reload</button></div>
          <div id="bannersList" class="list"></div>
        </div>
      </section>

      <!-- POSTERS -->
      <section id="tab-posters" class="grid hidden" style="margin-top:12px">
        <div class="card">
          <h3>New / Edit Poster</h3>
          <div class="grid three">
            <div><label>Title</label><input id="ps-title" placeholder="Movie / Series title"></div>
            <div><label>Aspect ratio</label><select id="ps-ratio"><option>2:3</option><option>16:9</option></select></div>
            <div><label>Sort</label><input id="ps-sort" type="number" value="10"></div>
          </div>
          <div class="grid two">
            <div><label>Active</label><select id="ps-active"><option>true</option><option>false</option></select></div>
            <div><label>Image URL</label><input id="ps-url" placeholder="https://.../poster.jpg"></div>
          </div>
          <div class="row"><img id="ps-thumb" class="thumb hidden" alt=""></div>
          <div class="row">
            <button id="psSave" class="btn primary">Save</button>
            <button id="psNew" class="btn">New</button>
            <button id="psDelete" class="btn">Delete</button>
            <div id="psMsg" class="muted"></div>
          </div>
          <input id="ps-id" type="hidden">
        </div>

        <div class="card">
          <div class="split"><h3>Posters</h3><button id="psReload" class="btn">Reload</button></div>
          <div id="postersList" class="list"></div>
        </div>
      </section>
    </div>

    <div id="locked" class="card">
      <h3>Sign in to edit</h3>
      <p class="muted">Anyone who can sign in can edit. Yes, really. Try not to share the login with your chatty cousin.</p>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut,
           createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCboIOCfsY1Zvx-cyKPMbAMGYdg27rnP0Y",
    authDomain: "netplus-site-4ff04.firebaseapp.com",
    projectId: "netplus-site-4ff04",
    storageBucket: "netplus-site-4ff04.firebasestorage.app",
    messagingSenderId: "49095160110",
    appId: "1:49095160110:web:5431d5c9f8ca45c4d70abf",
    measurementId: "G-PYWFFDZ0RR"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const splitUrls = raw => (raw||"").split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
  function msg(el, text, ok=true){ el.textContent = text; el.className = ok ? "muted success" : "muted danger"; setTimeout(()=>{el.textContent=""; el.className="muted";}, 3000); }
  function ensure(v,f){ return (v===undefined||v===null)?f:v; }
  function renderThumbs(hostSel, urls){ const host=$(hostSel); host.innerHTML=''; urls.forEach(u=>{ host.insertAdjacentHTML('beforeend', `<img src="${u}" class="thumb">`); }); }

  // Auth UI
  const userInfo = $('#userInfo'), signOutBtn = $('#signOutBtn');
  const authToggle = $('#authToggle'), authCard = $('#authCard');
  const emailIn = $('#authEmail'), passIn = $('#authPass'), authMsg = $('#authMsg');

  authToggle.onclick = ()=> authCard.classList.toggle('open');
  document.addEventListener('click', e=>{ if (!authCard.contains(e.target) && !authToggle.contains(e.target)) authCard.classList.remove('open'); });

  $('#googleSignIn').onclick = async()=>{ try{ await signInWithPopup(auth, provider); authCard.classList.remove('open'); }catch(e){ msg(authMsg,e.message,false); } };
  $('#emailSignIn').onclick = async()=>{ try{ await signInWithEmailAndPassword(auth, emailIn.value.trim(), passIn.value); authCard.classList.remove('open'); }catch(e){ msg(authMsg,e.message,false); } };
  $('#emailRegister').onclick = async()=>{ try{ const cred=await createUserWithEmailAndPassword(auth, emailIn.value.trim(), passIn.value); msg(authMsg,'Registered: '+cred.user.email,true); }catch(e){ msg(authMsg,e.message,false); } };
  signOutBtn.onclick = async()=>{ await signOut(auth); };

  // Anyone signed in can edit
  onAuthStateChanged(auth, async user=>{
    const editor = $('#editor'), locked = $('#locked');
    if(!user){
      userInfo.textContent = "Not signed in";
      signOutBtn.style.display = 'none';
      editor.classList.add('hidden');
      locked.classList.remove('hidden');
      return;
    }
    userInfo.textContent = user.displayName || user.email || user.uid;
    signOutBtn.style.display = 'inline-flex';
    editor.classList.remove('hidden');
    locked.classList.add('hidden');

    // load data
    await loadSettings();
    await loadPlans();
    await loadBoxes();
    await loadBanners();
    await loadPosters();
  });

  // Tabs
  $$('.tab').forEach(t=>{
    t.onclick = ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['settings','plans','boxes','banners','posters'].forEach(key=>{
        $('#tab-'+key).classList.toggle('hidden', key!==t.dataset.tab);
      });
    };
  });

  /* SETTINGS */
  async function loadSettings(){
    const sDoc = await getDoc(doc(db,'settings','main'));
    if(sDoc.exists()){
      const s = sDoc.data();
      $('#set-theme').value = ensure(s.themeDefault,'dark');
      $('#set-wa').value = ensure(s.whatsappNumber,'16476961656');
      $('#set-features').value = ensure((s.features||[]).join(', '),'ðŸ‡¨ðŸ‡¦ Proudly Canadian, Zero Latency Streams, 24/7 Support, Multi-Device');
      $('#set-hero-subtitle').value = ensure(s.heroSubtitle,'Quick Activation');
      $('#set-hero-title').value = ensure(s.heroTitle,'20,000+ Live Channels, All Shows, Movies & PPV');
      $('#set-hero-subline').value = ensure(s.heroSubline,'Latest + classic Movies & Series â€¢ Full HD & SD Channels â€¢ Anti-Freeze Tech');
      $('#set-ctas').value = ensure((s.ctaLabels||['Our Plans','New Boxes','Renew Plan','Contact Support']).join(', '),'Our Plans, New Boxes, Renew Plan, Contact Support');
      $('#set-notes').value = ensure(s.notes,'');
    }
  }
  $('#saveSettings').onclick = async()=>{
    const body = {
      themeDefault: $('#set-theme').value || 'dark',
      whatsappNumber: $('#set-wa').value || '16476961656',
      features: ($('#set-features').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      heroSubtitle: $('#set-hero-subtitle').value.trim(),
      heroTitle: $('#set-hero-title').value.trim(),
      heroSubline: $('#set-hero-subline').value.trim(),
      ctaLabels: ($('#set-ctas').value||'').split(',').map(s=>s.trim()).slice(0,4),
      notes: $('#set-notes').value.trim(),
      updatedAt: serverTimestamp()
    };
    await setDoc(doc(db,'settings','main'), body, {merge:true});
    msg($('#settingsMsg'),'Saved.');
  };

  /* PLANS */
  let plansCache=[];
  async function loadPlans(){
    const snap = await getDocs(collection(db,'plans'));
    plansCache=[]; snap.forEach(d=> plansCache.push({id:d.id,...d.data()}));
    plansCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderPlansList();
  }
  function renderPlansList(){
    const list=$('#plansList'); list.innerHTML='';
    plansCache.forEach(p=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><span class="tag mini">${p.tag||''}</span> <strong>${p.name||''}</strong> <span class="muted">(${p.months||''} mo)</span></div>
          <div class="right"><strong>${p.price||''}</strong> <span class="muted">sort:${p.sort||0}</span> <span class="muted">${p.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${p.id}">Edit</button>
          </div>
        </div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const p=plansCache.find(x=>x.id===b.dataset.edit);
        $('#p-id').value=p.id; $('#p-name').value=p.name||''; $('#p-price').value=p.price||'';
        $('#p-months').value=p.months||''; $('#p-benefit').value=p.benefit||''; $('#p-tag').value=p.tag||'';
        $('#p-desc').value=p.desc||''; $('#p-sort').value=p.sort||0; $('#p-active').value=String(p.active!==false);
      };
    });
  }
  $('#planNew').onclick=()=>{ ['p-id','p-name','p-price','p-months','p-benefit','p-tag','p-desc','p-sort'].forEach(id=>$('#'+id).value=''); $('#p-active').value='true'; };
  $('#planSave').onclick=async()=>{
    const id=$('#p-id').value.trim();
    const body={ name:$('#p-name').value.trim(), price:$('#p-price').value.trim(), months:Number($('#p-months').value||0),
      benefit:$('#p-benefit').value.trim(), tag:$('#p-tag').value.trim(), desc:$('#p-desc').value.trim(),
      sort:Number($('#p-sort').value||0), active:$('#p-active').value==='true', updatedAt:serverTimestamp() };
    if(!body.name||!body.price){ msg($('#planMsg'),'Name and Price required',false); return; }
    if(id){ await setDoc(doc(db,'plans',id),body,{merge:true}); } else { await addDoc(collection(db,'plans'),body); }
    await loadPlans(); msg($('#planMsg'),'Saved.');
  };
  $('#planDelete').onclick=async()=>{
    const id=$('#p-id').value.trim(); if(!id) return;
    if(confirm('Delete this plan?')){ await deleteDoc(doc(db,'plans',id)); await loadPlans(); msg($('#planMsg'),'Deleted.'); }
  };
  $('#plansReload').onclick=loadPlans;

  /* BOXES */
  let boxesCache=[];
  async function loadBoxes(){
    const snap=await getDocs(collection(db,'boxes'));
    boxesCache=[]; snap.forEach(d=> boxesCache.push({id:d.id,...d.data()}));
    boxesCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderBoxesList();
  }
  function renderBoxesList(){
    const list=$('#boxesList'); list.innerHTML='';
    boxesCache.forEach(bx=>{
      const imgs=(bx.images||[]).map(u=>`<img class="thumb" src="${u}">`).join('');
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><span class="tag mini">${bx.tier||''}</span> <strong>${bx.name||''}</strong> <span class="muted">(${(bx.images||[]).length} img)</span></div>
          <div class="right"><strong>${bx.boxPrice||''}</strong> <span class="muted">sort:${bx.sort||0}</span> <span class="muted">${bx.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${bx.id}">Edit</button>
          </div>
        </div>
        <div class="imgRow" style="margin-top:6px">${imgs}</div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const x=boxesCache.find(z=>z.id===b.dataset.edit);
        $('#b-id').value=x.id; $('#b-tier').value=x.tier||''; $('#b-name').value=x.name||'';
        $('#b-sort').value=x.sort||0; $('#b-boxPrice').value=x.boxPrice||''; $('#b-active').value=String(x.active!==false);
        $('#b-c-price').value=x.combo?.price||''; $('#b-c-months').value=x.combo?.planMonths||12; $('#b-c-extra').value=x.combo?.extra||'';
        $('#b-desc').value=x.desc||''; $('#b-img-urls').value=(x.images||[]).join('\n'); renderThumbs('#b-images', x.images||[]);
      };
    });
  }
  $('#b-img-urls').addEventListener('input', ()=> renderThumbs('#b-images', splitUrls($('#b-img-urls').value).slice(0,3)) );
  $('#boxNew').onclick=()=>{ ['b-id','b-tier','b-name','b-sort','b-boxPrice','b-c-price','b-c-months','b-c-extra','b-desc','b-img-urls'].forEach(i=>$('#'+i).value=''); $('#b-active').value='true'; $('#b-images').innerHTML=''; };
  $('#boxSave').onclick=async()=>{
    const id=$('#b-id').value.trim();
    const images=splitUrls($('#b-img-urls').value).slice(0,3);
    const body={ tier:$('#b-tier').value.trim(), name:$('#b-name').value.trim(), sort:Number($('#b-sort').value||0),
      boxPrice:$('#b-boxPrice').value.trim(), active:$('#b-active').value==='true',
      combo:{ price:$('#b-c-price').value.trim(), planMonths:Number($('#b-c-months').value||12), extra:$('#b-c-extra').value.trim() },
      desc:$('#b-desc').value.trim(), images, updatedAt:serverTimestamp() };
    if(!body.name){ msg($('#boxMsg'),'Model name required',false); return; }
    if(images.length===0){ msg($('#boxMsg'),'At least 1 image URL',false); return; }
    if(id){ await setDoc(doc(db,'boxes',id), body, {merge:true}); } else { await addDoc(collection(db,'boxes'), body); }
    await loadBoxes(); msg($('#boxMsg'),'Saved.');
  };
  $('#boxDelete').onclick=async()=>{
    const id=$('#b-id').value.trim(); if(!id) return;
    if(confirm('Delete this box?')){ await deleteDoc(doc(db,'boxes',id)); await loadBoxes(); msg($('#boxMsg'),'Deleted.'); }
  };
  $('#boxesReload').onclick=loadBoxes;

  /* BANNERS */
  let bannersCache=[];
  async function loadBanners(){
    const snap=await getDocs(collection(db,'banners'));
    bannersCache=[]; snap.forEach(d=> bannersCache.push({id:d.id,...d.data()}));
    bannersCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderBannersList();
  }
  function renderBannersList(){
    const list=$('#bannersList'); list.innerHTML='';
    bannersCache.forEach(bn=>{
      const imgs=(bn.images||[]).map(u=>`<img class="thumb" src="${u}">`).join('');
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><strong>${bn.title||''}</strong> <span class="muted">(${(bn.images||[]).length} img)</span></div>
          <div class="right"><span class="muted">sort:${bn.sort||0}</span> <span class="muted">${bn.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${bn.id}">Edit</button>
          </div>
        </div>
        <div class="imgRow" style="margin-top:6px">${imgs}</div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const x=bannersCache.find(z=>z.id===b.dataset.edit);
        $('#bn-id').value=x.id; $('#bn-title').value=x.title||''; $('#bn-sort').value=x.sort||0; $('#bn-active').value=String(x.active!==false);
        $('#bn-img-urls').value=(x.images||[]).join('\n'); renderThumbs('#bn-images', x.images||[]);
      };
    });
  }
  $('#bnNew').onclick=()=>{ ['bn-id','bn-title','bn-sort','bn-img-urls'].forEach(i=>$('#'+i).value=''); $('#bn-active').value='true'; $('#bn-images').innerHTML=''; };
  $('#bn-img-urls').addEventListener('input', ()=> renderThumbs('#bn-images', splitUrls($('#bn-img-urls').value)) );
  $('#bnSave').onclick=async()=>{
    const id=$('#bn-id').value.trim();
    const images=splitUrls($('#bn-img-urls').value);
    const body={ title:$('#bn-title').value.trim(), sort:Number($('#bn-sort').value||0), active:$('#bn-active').value==='true', images, updatedAt:serverTimestamp() };
    if(!images.length){ msg($('#bnMsg'),'At least one image URL',false); return; }
    if(id){ await setDoc(doc(db,'banners',id), body, {merge:true}); } else { await addDoc(collection(db,'banners'), body); }
    await loadBanners(); msg($('#bnMsg'),'Saved.');
  };
  $('#bnDelete').onclick=async()=>{
    const id=$('#bn-id').value.trim(); if(!id) return;
    if(confirm('Delete this banner?')){ await deleteDoc(doc(db,'banners',id)); await loadBanners(); msg($('#bnMsg'),'Deleted.'); }
  };
  $('#bnReload').onclick=loadBanners;

  /* POSTERS */
  let postersCache=[];
  async function loadPosters(){
    const snap=await getDocs(collection(db,'posters'));
    postersCache=[]; snap.forEach(d=> postersCache.push({id:d.id,...d.data()}));
    postersCache.sort((a,b)=> (a.sort||0)-(b.sort||0));
    renderPostersList();
  }
  function renderPostersList(){
    const list=$('#postersList'); list.innerHTML='';
    postersCache.forEach(ps=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="split">
          <div><strong>${ps.title||''}</strong> <span class="muted">${ps.ratio||''}</span></div>
          <div class="right"><span class="muted">sort:${ps.sort||0}</span> <span class="muted">${ps.active===false?'inactive':'active'}</span>
            <button class="btn mini" data-edit="${ps.id}">Edit</button>
          </div>
        </div>
        ${ps.image?`<img class="thumb" src="${ps.image}" style="margin-top:6px">`:''}`;
      list.appendChild(div);
    });
    list.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick=()=>{
        const x=postersCache.find(z=>z.id===b.dataset.edit);
        $('#ps-id').value=x.id; $('#ps-title').value=x.title||''; $('#ps-ratio').value=x.ratio||'2:3'; $('#ps-sort').value=x.sort||0;
        $('#ps-active').value=String(x.active!==false); $('#ps-url').value=x.image||'';
        const th=$('#ps-thumb'); if(x.image){ th.src=x.image; th.classList.remove('hidden'); } else { th.classList.add('hidden'); }
      };
    });
  }
  $('#psNew').onclick=()=>{ ['ps-id','ps-title','ps-sort','ps-url'].forEach(i=>$('#'+i).value=''); $('#ps-active').value='true'; $('#ps-ratio').value='2:3'; $('#ps-thumb').classList.add('hidden'); };
  $('#psSave').onclick=async()=>{
    const id=$('#ps-id').value.trim();
    const body={ title:$('#ps-title').value.trim(), ratio:$('#ps-ratio').value, sort:Number($('#ps-sort').value||0), active:$('#ps-active').value==='true', image:$('#ps-url').value||'', updatedAt:serverTimestamp() };
    if(!body.title || !body.image){ msg($('#psMsg'),'Title and image URL required',false); return; }
    if(id){ await setDoc(doc(db,'posters',id), body, {merge:true}); } else { await addDoc(collection(db,'posters'), body); }
    await loadPosters(); msg($('#psMsg'),'Saved.');
  };
  $('#psDelete').onclick=async()=>{
    const id=$('#ps-id').value.trim(); if(!id) return;
    if(confirm('Delete this poster?')){ await deleteDoc(doc(db,'posters',id)); await loadPosters(); msg($('#psMsg'),'Deleted.'); }
  };
  $('#psReload').onclick=loadPosters;
</script>
</body>
</html>
