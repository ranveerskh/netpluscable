<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1">
<title>net+TV Admin</title>
<meta name="theme-color" content="#0b1020">
<style>
  :root{
    --bg:#0b1020;--ink:#e9edff;--muted:#a9b5e6;--card:#121831;--line:#23305b;
    --g1:#6a11cb;--g2:#2575fc;--tap:44px;--safe-top: env(safe-area-inset-top,0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#0b1020;color:var(--ink);-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:100;background:rgba(11,16,32,.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.08)}
  .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:10px 16px;padding-top:calc(10px + var(--safe-top))}
  .brand{display:flex;gap:10px;align-items:center;font-weight:900}
  .badge{background:linear-gradient(135deg,var(--g1),var(--g2));padding:6px 10px;border-radius:10px;font-weight:900}
  .auth{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .chip{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#0f1732}
  .btn{border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:12px 14px;font-weight:800;background:#0f1732;color:var(--ink);cursor:pointer;min-height:var(--tap)}
  .btn.primary{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent;color:#fff}
  .btn.warn{background:#2d1d00;border-color:#5f3f00}
  .input{background:#0b122a;border:1px solid #22305a;border-radius:12px;padding:12px 14px;color:#e9edff;min-height:var(--tap);width:100%}
  textarea.input{min-height:120px}

  /* Quick links */
  .ql-wrap{padding:10px 16px;border-top:1px solid rgba(255,255,255,.08)}
  .ql-grid{display:grid;gap:10px;grid-template-columns:repeat(2, minmax(0,1fr))}
  .qbtn{display:flex;align-items:center;justify-content:center;text-align:center;font-weight:900;padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:#0f1732}
  .qbtn.primary{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent}

  /* Panel nav */
  .tools{display:flex;gap:10px;flex-wrap:wrap;margin:10px 16px}
  .tbtn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1732;font-weight:800}
  .tbtn.active{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent;color:#fff}
  .pill{display:inline-block;margin:6px 8px 0 0;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0f1732;font-size:13px}

  /* Sections */
  .section{padding:16px}
  .sub{color:#a9b5e6;font-size:13px}
  .cards{display:grid;gap:12px}
  @media(min-width:900px){.cards{grid-template-columns:repeat(4,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .kpi-val{font-size:28px;font-weight:900;line-height:1.1;margin-top:6px}

  /* Panels */
  .panel{display:none}
  .panel.active{display:block}

  /* Grids */
  .grid2{display:grid;gap:10px}
  @media(min-width:900px){.grid2{grid-template-columns:1fr 1fr}}
  .grid3{display:grid;gap:10px}
  @media(min-width:900px){.grid3{grid-template-columns:repeat(3,1fr)}}

  /* Rows */
  .rows{display:grid;gap:8px;margin-top:10px}
  .row{display:grid;gap:8px;background:#0f1732;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  @media(min-width:800px){.row{grid-template-columns:2fr 1fr 1fr auto}}

  .badge2{display:inline-block;background:#0f1732;border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="bar">
    <div class="brand"><span class="badge">net+TV</span> <span>Admin</span></div>

    <div class="auth" id="authArea">
      <input id="email" class="input" placeholder="Admin email" autocomplete="username" inputmode="email" style="width:220px">
      <input id="password" class="input" placeholder="Password" type="password" autocomplete="current-password" style="width:180px">
      <button class="btn primary" id="btnSignIn">Sign In</button>
    </div>
    <div class="auth" id="whoami" style="display:none">
      <span id="whoamiText" class="chip"></span>
      <button class="btn" id="btnSignOut">Sign Out</button>
    </div>
  </div>

  <!-- Quick links -->
  <div class="ql-wrap">
    <div class="ql-grid">
      <a class="qbtn primary" href="https://beta.gpanel.me/login" target="_blank" rel="noopener">Glow TV</a>
      <a class="qbtn" href="https://bill.spicetv.cc/login" target="_blank" rel="noopener">Spice TV</a>
      <a class="qbtn" href="https://fast4k.cc/login" target="_blank" rel="noopener">Smart4K TV</a>
      <a class="qbtn" href="data.html" target="_blank" rel="noopener">Users Data</a>
    </div>
  </div>

  <!-- Panel nav -->
  <div class="tools" id="navTabs">
    <button class="tbtn active" data-panel="home">Home</button>
    <button class="tbtn" data-panel="hosts">Hosts</button>
    <button class="tbtn" data-panel="banners">Banners</button>
    <span class="pill">Site Settings</span>
    <button class="tbtn" data-panel="general">General</button>
    <button class="tbtn" data-panel="plans">Plans</button>
    <button class="tbtn" data-panel="boxes">Boxes</button>
    <button class="tbtn" data-panel="galleryLocal">Gallery (Site)</button>
    <button class="tbtn" data-panel="importExport">Import/Export</button>
  </div>
</div>

<!-- PANELS -->
<div class="wrap">

  <!-- HOME -->
  <section id="panel-home" class="panel active section">
    <div class="sub" style="margin-bottom:10px">Analytics track steps only (no location)</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
      <label class="sub" for="range">Range</label>
      <select id="range" class="input" style="width:auto">
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
        <option value="1y">Last 1 year</option>
        <option value="all">Lifetime</option>
      </select>
      <button class="btn" id="refreshKPI">Refresh</button>
    </div>

    <div class="cards">
      <div class="card"><div class="sub">Unique Viewer-Days</div><div class="kpi-val" id="kpiVisitors">—</div></div>
      <div class="card"><div class="sub">Pings in Range</div><div class="kpi-val" id="kpiPings">—</div></div>
      <div class="card"><div class="sub">Avg Steps (today)</div><div class="kpi-val" id="kpiAvgStepsToday">—</div></div>
      <div class="card"><div class="sub">Avg Steps (session)</div><div class="kpi-val" id="kpiAvgStepsSession">—</div></div>
    </div>
  </section>

  <!-- HOSTS -->
  <section id="panel-hosts" class="panel section">
    <h3 style="margin:0 0 8px 0">Hosts</h3>
    <div class="sub" style="margin-bottom:8px">Tap to open; long-press to copy.</div>
    <a class="pill" href="http://glotv.me" target="_blank" rel="noopener">Glow TV: glotv.me</a>
    <a class="pill" href="http://4k.spicetv.cc" target="_blank" rel="noopener">Spice TV: 4k.spicetv.cc</a>
    <a class="pill" href="http://smart4k.me" target="_blank" rel="noopener">Smart4K TV: smart4k.me</a>
  </section>

  <!-- BANNERS (Firestore) -->
  <section id="panel-banners" class="panel section">
    <h3 style="margin:0 0 8px 0">Swipe Banners (Firestore)</h3>
    <div class="sub">Only enabled banners within date window are displayed on site.</div>
    <div class="grid2" style="margin-top:12px">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bnEnabled" checked> <span class="sub">Enabled</span></label>
      <input class="input" id="bnTitle" placeholder="Title (e.g., Canada Day Offer)">
      <input class="input" id="bnText" placeholder="Text (e.g., Get 1 month extra with 1-year)">
      <input class="input" id="bnCtaLabel" placeholder="CTA label (e.g., Get 13 months)">
      <input class="input" id="bnCtaHref" placeholder="CTA href (https:// or #)">
      <input class="input" id="bnImageUrl" placeholder="Image URL (optional)">
      <input class="input" id="bnValidFrom" type="date" placeholder="Valid from">
      <input class="input" id="bnValidTo" type="date" placeholder="Valid to">
      <input class="input" id="bnOrder" type="number" placeholder="Order (0..N)">
      <button class="btn primary" id="bnSave">Save New Banner</button>
    </div>
    <div class="sub" id="bnStatus" style="margin-top:6px"></div>
    <div id="bannerList"></div>
  </section>

  <!-- ===== SITE SETTINGS (LocalStorage for index.html) ===== -->

  <!-- GENERAL -->
  <section id="panel-general" class="panel section">
    <h3 style="margin:0 0 8px 0">Site Settings — General</h3>
    <div class="sub">Stored in <span class="badge2">localStorage</span> at <code>netplus.settings.v1.public</code>. Index reads this.</div>
    <div class="grid3" style="margin-top:12px">
      <div class="card">
        <div class="sub">Currency</div>
        <div class="grid2" style="margin-top:8px">
          <input class="input" id="curSymbol" placeholder="Symbol (e.g., $)">
          <select class="input" id="curPos">
            <option value="prefix">Prefix ($100)</option>
            <option value="suffix">Suffix (100$)</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="sub">WhatsApp</div>
        <input class="input" id="waNumber" placeholder="WhatsApp number (digits only)" style="margin-top:8px">
      </div>
      <div class="card">
        <div class="sub">Housekeeping</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="btnLoadLocal">Load current</button>
          <button class="btn primary" id="btnSaveLocal">Save</button>
          <button class="btn warn" id="btnResetLocal">Reset (defaults)</button>
        </div>
        <div class="sub" id="genStatus" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- PLANS -->
  <section id="panel-plans" class="panel section">
    <h3 style="margin:0 0 8px 0">Site Settings — Plans</h3>
    <div class="sub">Cards, table, and recharge dropdown on index are generated from here.</div>

    <div class="grid3" style="margin-top:12px">
      <input class="input" id="plName" placeholder="Name (e.g., 6 Months)">
      <input class="input" id="plMonths" type="number" placeholder="Months (e.g., 6)">
      <input class="input" id="plPrice" type="number" placeholder="Price (number)">
      <input class="input" id="plBadge" placeholder="Badge (e.g., Most Picked)">
      <input class="input" id="plNote" placeholder="Note (e.g., +1 month free)">
      <input class="input" id="plOrder" type="number" placeholder="Order (0..N)">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="plVisible" checked> <span class="sub">Visible</span></label>
      <button class="btn primary" id="plAdd">Add / Save</button>
      <button class="btn" id="plClear">Clear form</button>
    </div>
    <div class="rows" id="planRows"></div>
  </section>

  <!-- BOXES -->
  <section id="panel-boxes" class="panel section">
    <h3 style="margin:0 0 8px 0">Site Settings — Boxes</h3>
    <div class="sub">Supports per-box photos (swipe on index) + specs list.</div>

    <div class="grid3" style="margin-top:12px">
      <input class="input" id="bxName" placeholder="Name (e.g., Formular Z11 PRO)">
      <input class="input" id="bxPrice" type="number" placeholder="Price">
      <input class="input" id="bxBundle" type="number" placeholder="Bundle price (Box + 1-Year)">
      <input class="input" id="bxBadge" placeholder="Badge (e.g., Recommended)">
      <input class="input" id="bxOrder" type="number" placeholder="Order (0..N)">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxVisible" checked> <span class="sub">Visible</span></label>
      <textarea class="input" id="bxSpecs" placeholder="Specs: one per line"></textarea>
      <textarea class="input" id="bxPhotos" placeholder="Photo URLs: one per line (optional captions with |, e.g. https://…jpg|Front)"></textarea>
      <button class="btn primary" id="bxAdd">Add / Save</button>
      <button class="btn" id="bxClear">Clear form</button>
    </div>
    <div class="rows" id="boxRows"></div>
  </section>

  <!-- GALLERY (LOCAL) -->
  <section id="panel-galleryLocal" class="panel section">
    <h3 style="margin:0 0 8px 0">Site Settings — Gallery (Site)</h3>
    <div class="sub">Shown in the Gallery tab on index. Purely local; no Firestore.</div>

    <div class="grid3" style="margin-top:12px">
      <input class="input" id="glLocCaption" placeholder="Caption">
      <input class="input" id="glLocUrl" placeholder="Image URL">
      <input class="input" id="glLocOrder" type="number" placeholder="Order (0..N)">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="glLocVisible" checked> <span class="sub">Visible</span></label>
      <button class="btn primary" id="glLocAdd">Add / Save</button>
      <button class="btn" id="glLocClear">Clear form</button>
    </div>
    <div class="rows" id="galLocalRows"></div>
  </section>

  <!-- IMPORT / EXPORT -->
  <section id="panel-importExport" class="panel section">
    <h3 style="margin:0 0 8px 0">Site Settings — Import / Export</h3>
    <div class="sub">Backup or move settings between browsers/origins.</div>
    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <div class="sub">Export JSON</div>
        <button class="btn" id="btnExport">Download settings.json</button>
      </div>
      <div class="card">
        <div class="sub">Import JSON</div>
        <input type="file" id="fileImport" accept="application/json" class="input">
        <button class="btn primary" id="btnImport">Import</button>
      </div>
    </div>
    <div class="sub" id="ieStatus" style="margin-top:8px"></div>
  </section>

</div>

<script type="module">
/* ================= Firebase (KPIs + Banners only) ================= */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, limit, getDocs,
  doc, addDoc, setDoc, getDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
  authDomain: "netplustv-90b29.firebaseapp.com",
  projectId: "netplustv-90b29",
  storageBucket: "netplustv-90b29.firebasestorage.app",
  messagingSenderId: "639722274355",
  appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
};
const app = getApps().length? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================= Small helpers ================= */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const fmt = v => Number(v||0);
function toast(sel,msg){ const el=$(sel); if(!el) return; el.textContent=msg; setTimeout(()=>el.textContent='',1800); }

/* ================= NAV ================= */
function showPanel(name){
  $$('#navTabs .tbtn').forEach(b=>b.classList.toggle('active', b.dataset.panel===name));
  ['home','hosts','banners','general','plans','boxes','galleryLocal','importExport']
    .forEach(n=>$('#panel-'+n).classList.toggle('active', n===name));
  window.scrollTo({top:0,behavior:'smooth'});
}
$('#navTabs').addEventListener('click', e=>{
  const b=e.target.closest('button[data-panel]'); if(!b) return;
  showPanel(b.dataset.panel);
});
window.showPanel = showPanel;

/* ================= AUTH ================= */
$('#btnSignIn').addEventListener('click', async ()=>{
  const email=$('#email').value.trim(), pass=$('#password').value;
  if(!email||!pass) return alert('Enter email and password');
  try{ await signInWithEmailAndPassword(auth,email,pass); }catch(e){ alert('Sign in failed: '+(e?.message||e)); }
});
$('#btnSignOut').addEventListener('click',()=>signOut(auth));

onAuthStateChanged(auth, async (user)=>{
  if(user){
    $('#authArea').style.display='none';
    $('#whoami').style.display='flex';
    $('#whoamiText').textContent = user.email || '';
    await refreshAll();
  }else{
    $('#authArea').style.display='flex';
    $('#whoami').style.display='none';
    $('#bannerList').innerHTML='';
    ['kpiVisitors','kpiPings','kpiAvgStepsToday','kpiAvgStepsSession'].forEach(id=>$('#'+id).textContent='—');
  }
});

/* ================= KPIs ================= */
function rangeToStart(v){ const n=new Date(); if(v==='7d')return new Date(n-7*864e5); if(v==='30d')return new Date(n-30*864e5); if(v==='1y')return new Date(n-365*864e5); return null; }
let visCache=[];
async function loadAnalytics(){
  const start = rangeToStart($('#range').value);
  const snap = await getDocs(query(collection(db,'analytics_visitors'), orderBy('createdAt','desc'), limit(300)));
  visCache = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(r=>{
    const t = r.createdAt?.toDate?.() || (r.ts? new Date(r.ts) : null);
    return !start || (t && t>=start);
  });
}
function renderKPIs(){
  const unique=new Set(); let pings=0,sumT=0,sumS=0,nT=0,nS=0;
  visCache.forEach(r=>{
    const t=r.createdAt?.toDate?.() || (r.ts?new Date(r.ts):null);
    if(t && r.vid){ unique.add(t.toISOString().slice(0,10)+'|'+r.vid); }
    pings++; if(typeof r.steps_today==='number'){ sumT+=r.steps_today; nT++; }
    if(typeof r.steps_session==='number'){ sumS+=r.steps_session; nS++; }
  });
  $('#kpiVisitors').textContent=String(unique.size);
  $('#kpiPings').textContent=String(pings);
  $('#kpiAvgStepsToday').textContent=nT? (sumT/nT).toFixed(1):'0.0';
  $('#kpiAvgStepsSession').textContent=nS? (sumS/nS).toFixed(1):'0.0';
}
async function refreshKPIs(){ await loadAnalytics(); renderKPIs(); }
$('#range').addEventListener('change', refreshKPIs);
$('#refreshKPI').addEventListener('click', refreshKPIs);

/* ================= Firestore BANNERS ================= */
async function loadBanners(){
  const snap = await getDocs(query(collection(db,'site_settings','banners','items'), orderBy('order','asc')));
  const list = $('#bannerList'); list.innerHTML='';
  snap.forEach(docSnap=>{
    const b = { id: docSnap.id, ...docSnap.data() };
    const row = document.createElement('div'); row.className='row'; row.innerHTML = `
      <div>
        <div class="h"><strong>${b.title||'(no title)'}</strong> ${b.enabled? '' : '<span class="sub">[disabled]</span>'}</div>
        <div class="sub">${b.text||''}</div>
        <div class="sub">CTA: ${b.ctaLabel||''} → ${(b.ctaHref||'').slice(0,80)}</div>
        <div class="sub">Order: ${b.order??0} | Valid: ${(b.validFrom||'')||'—'} → ${(b.validTo||'')||'—'}</div>
        <div class="sub">${b.imageUrl? 'Image: '+b.imageUrl : ''}</div>
      </div>
      <div class="actions" style="display:flex;gap:8px;align-items:center">
        <button class="btn" data-act="toggle" data-id="${b.id}">${b.enabled? 'Disable' : 'Enable'}</button>
        <button class="btn" data-act="edit" data-id="${b.id}">Edit</button>
        <button class="btn" data-act="del" data-id="${b.id}">Delete</button>
      </div>`;
    list.appendChild(row);
  });
  list.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.id, act = btn.dataset.act;
      const ref = doc(db,'site_settings','banners','items',id);
      if(act==='toggle'){
        const snap = await getDoc(ref); const cur = snap.data();
        await setDoc(ref,{enabled:!cur.enabled, updatedAt:serverTimestamp()},{merge:true});
      }else if(act==='edit'){
        const snap = await getDoc(ref); const b = snap.data();
        $('#bnEnabled').checked = !!b.enabled;
        $('#bnTitle').value = b.title||''; $('#bnText').value=b.text||'';
        $('#bnCtaLabel').value=b.ctaLabel||''; $('#bnCtaHref').value=b.ctaHref||'';
        $('#bnImageUrl').value=b.imageUrl||''; $('#bnValidFrom').value=b.validFrom||''; $('#bnValidTo').value=b.validTo||'';
        $('#bnOrder').value=b.order??0;
        $('#bnSave').dataset.editId = id; $('#bnSave').textContent='Save Changes';
        toast('#bnStatus','Loaded for editing'); window.scrollTo({top:0,behavior:'smooth'});
      }else if(act==='del'){
        if(confirm('Delete this banner?')) await deleteDoc(ref);
      }
      await loadBanners();
    });
  });
}
$('#bnSave').addEventListener('click', async ()=>{
  const payload = {
    enabled: $('#bnEnabled').checked,
    title: $('#bnTitle').value.trim(),
    text: $('#bnText').value.trim(),
    ctaLabel: $('#bnCtaLabel').value.trim(),
    ctaHref: $('#bnCtaHref').value.trim(),
    imageUrl: $('#bnImageUrl').value.trim() || null,
    validFrom: $('#bnValidFrom').value || null,
    validTo: $('#bnValidTo').value || null,
    order: Number($('#bnOrder').value||0),
    updatedAt: serverTimestamp()
  };
  const editId = $('#bnSave').dataset.editId;
  if(editId){
    await setDoc(doc(db,'site_settings','banners','items',editId), payload, {merge:true});
    $('#bnSave').textContent='Save New Banner'; delete $('#bnSave').dataset.editId; toast('#bnStatus','Saved ✔');
  }else{
    payload.createdAt = serverTimestamp();
    await addDoc(collection(db,'site_settings','banners','items'), payload);
    toast('#bnStatus','Created ✔');
  }
  ['bnTitle','bnText','bnCtaLabel','bnCtaHref','bnImageUrl','bnOrder'].forEach(id=>$('#'+id).value='');
  await loadBanners();
});

/* ================= LocalStorage Site Settings ================= */
const KEY_CANON = 'netplus.settings.v1.public';
const KEY_OLD   = ['netplus.settings.v1','netplus.settings']; // migrate if present

// MIGRATION to canonical key (one-time)
(function migrate(){
  if(localStorage.getItem(KEY_CANON)) return;
  for(const k of KEY_OLD){
    const raw = localStorage.getItem(k);
    if(raw){ try{ const o=JSON.parse(raw); localStorage.setItem(KEY_CANON, JSON.stringify(o)); break; }catch(_){ } }
  }
})();

function defaults(){
  return {
    currency:{symbol:'$', position:'prefix'},
    whatsapp:{number:'16476961656'},
    plans:[
      {id:crypto.randomUUID(), name:'1 Month', months:1, price:15, badge:'Starter', order:0, visible:true, note:'Full features'},
      {id:crypto.randomUUID(), name:'3 Months', months:3, price:40, badge:'Popular', order:1, visible:true, note:'Save vs monthly'},
      {id:crypto.randomUUID(), name:'6 Months', months:6, price:65, badge:'Most Picked', order:2, visible:true},
      {id:crypto.randomUUID(), name:'12 Months (+1 free)', months:12, price:100, badge:'Best Value', order:3, visible:true, note:'+1 month free'}
    ],
    boxes:[],
    gallery:[]
  };
}
function getSite(){ try{ return JSON.parse(localStorage.getItem(KEY_CANON) || 'null'); }catch(_){ return null; } }
function setSite(obj){ localStorage.setItem(KEY_CANON, JSON.stringify(obj)); }
function ensure(){ let s=getSite(); if(!s){ s=defaults(); setSite(s); } return s; }

// keep other tabs (including index.html) in sync
window.addEventListener('storage', e=>{
  if(e.key===KEY_CANON){ loadAllLocal(); }
});

/* ===== General ===== */
function loadGeneral(){
  const s = ensure();
  $('#curSymbol').value = s.currency?.symbol || '$';
  $('#curPos').value = s.currency?.position || 'prefix';
  $('#waNumber').value = s.whatsapp?.number || '';
}
$('#btnLoadLocal').addEventListener('click', loadGeneral);
$('#btnSaveLocal').addEventListener('click', ()=>{
  const s = ensure();
  s.currency = {symbol: $('#curSymbol').value || '$', position: $('#curPos').value || 'prefix'};
  s.whatsapp = {number: ($('#waNumber').value||'').replace(/[^\d]/g,'')};
  setSite(s); toast('#genStatus','Saved ✔');
});
$('#btnResetLocal').addEventListener('click', ()=>{
  if(!confirm('Reset to defaults?')) return;
  setSite(defaults()); loadAllLocal(); toast('#genStatus','Reset ✔');
});

/* ===== Plans CRUD ===== */
let editingPlanId=null;
function renderPlans(){
  const s = ensure(); const rows = $('#planRows'); rows.innerHTML='';
  const list = [...(s.plans||[])].sort((a,b)=>(a.order||0)-(b.order||0));
  const sym=s.currency?.symbol||'$'; const suf=s.currency?.position==='suffix';
  list.forEach(p=>{
    const priceTxt = suf? `${Number(p.price)}${sym}`:`${sym}${Number(p.price)}`;
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `
      <div><strong>${p.name||''}</strong> <span class="sub">(${p.months||''} months)</span> ${p.badge? `<span class="badge2">${p.badge}</span>`:''} ${p.note? `<span class="sub">• ${p.note}</span>`:''}</div>
      <div>${priceTxt}</div>
      <div class="sub">Order: ${p.order??0} • ${p.visible===false? 'Hidden':'Visible'}</div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-ed="${p.id}">Edit</button>
        <button class="btn" data-del="${p.id}">Delete</button>
      </div>`;
    rows.appendChild(row);
  });
  rows.querySelectorAll('button[data-ed]').forEach(b=>{
    b.onclick = ()=>{
      const s=ensure(); const p=s.plans.find(x=>x.id===b.dataset.ed); if(!p) return;
      editingPlanId=p.id;
      $('#plName').value=p.name||''; $('#plMonths').value=p.months||''; $('#plPrice').value=p.price||'';
      $('#plBadge').value=p.badge||''; $('#plNote').value=p.note||''; $('#plOrder').value=p.order||0;
      $('#plVisible').checked=p.visible!==false;
      $('#plAdd').textContent='Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  rows.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      if(!confirm('Delete this plan?')) return;
      const s=ensure(); s.plans=s.plans.filter(x=>x.id!==b.dataset.del); setSite(s); renderPlans();
    };
  });
}
$('#plAdd').addEventListener('click', ()=>{
  const s=ensure();
  const payload = {
    id: editingPlanId || crypto.randomUUID(),
    name: $('#plName').value.trim() || 'Plan',
    months: fmt($('#plMonths').value) || null,
    price: fmt($('#plPrice').value) || 0,
    badge: $('#plBadge').value.trim() || null,
    note: $('#plNote').value.trim() || null,
    order: fmt($('#plOrder').value) || 0,
    visible: $('#plVisible').checked
  };
  if(editingPlanId){
    const i=s.plans.findIndex(x=>x.id===editingPlanId);
    if(i>-1) s.plans[i]=payload;
    editingPlanId=null; $('#plAdd').textContent='Add / Save';
  }else{
    s.plans.push(payload);
  }
  setSite(s); renderPlans(); $('#plClear').click();
});
$('#plClear').addEventListener('click', ()=>{
  editingPlanId=null; $('#plAdd').textContent='Add / Save';
  ['plName','plMonths','plPrice','plBadge','plNote','plOrder'].forEach(id=>$('#'+id).value='');
  $('#plVisible').checked=true;
});

/* ===== Boxes CRUD ===== */
let editingBoxId=null;
function parseLines(v){ return v.split('\n').map(s=>s.trim()).filter(Boolean); }
function renderBoxes(){
  const s = ensure(); const rows = $('#boxRows'); rows.innerHTML='';
  const list = [...(s.boxes||[])].sort((a,b)=>(a.order||0)-(b.order||0));
  const sym = s.currency?.symbol || '$', suffix = s.currency?.position === 'suffix';
  list.forEach(bx=>{
    const priceTxt = suffix ? `${Number(bx.price)}${sym}` : `${sym}${Number(bx.price)}`;
    const photosCount = Array.isArray(bx.images)? bx.images.length : 0;
    const specsCount = Array.isArray(bx.specs)? bx.specs.length : 0;
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `
      <div><strong>${bx.name||''}</strong> ${bx.badge? `<span class="badge2">${bx.badge}</span>`:''} <span class="sub">photos:${photosCount} • specs:${specsCount}</span></div>
      <div>${priceTxt}${bx.bundle? ` <span class="sub">/ bundle: ${suffix? `${bx.bundle}${sym}` : `${sym}${bx.bundle}`}</span>`:''}</div>
      <div class="sub">Order: ${bx.order??0} • ${bx.visible===false?'Hidden':'Visible'}</div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-ed="${bx.id}">Edit</button>
        <button class="btn" data-del="${bx.id}">Delete</button>
      </div>`;
    rows.appendChild(row);
  });
  rows.querySelectorAll('button[data-ed]').forEach(b=>{
    b.onclick=()=>{
      const s=ensure(); const bx=s.boxes.find(x=>x.id===b.dataset.ed); if(!bx) return;
      editingBoxId=bx.id;
      $('#bxName').value=bx.name||''; $('#bxPrice').value=bx.price||''; $('#bxBundle').value=bx.bundle||'';
      $('#bxBadge').value=bx.badge||''; $('#bxOrder').value=bx.order||0; $('#bxVisible').checked=bx.visible!==false;
      $('#bxSpecs').value=(bx.specs||[]).join('\n');
      $('#bxPhotos').value=(bx.images||[]).map(i=>i.url + (i.alt? `|${i.alt}`:'')).join('\n');
      $('#bxAdd').textContent='Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  rows.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      if(!confirm('Delete this box?')) return;
      const s=ensure(); s.boxes=s.boxes.filter(x=>x.id!==b.dataset.del); setSite(s); renderBoxes();
    };
  });
}
$('#bxAdd').addEventListener('click', ()=>{
  const s=ensure();
  const imgs = parseLines($('#bxPhotos').value).map(line=>{
    const [url, alt] = line.split('|'); return {url:url?.trim(), alt:(alt||'').trim()};
  }).filter(i=>i.url);
  const specs = parseLines($('#bxSpecs').value);
  const payload = {
    id: editingBoxId || crypto.randomUUID(),
    name: $('#bxName').value.trim() || 'Box',
    price: fmt($('#bxPrice').value)||0,
    bundle: $('#bxBundle').value? fmt($('#bxBundle').value) : null,
    badge: $('#bxBadge').value.trim() || null,
    order: fmt($('#bxOrder').value)||0,
    visible: $('#bxVisible').checked,
    images: imgs,
    specs: specs
  };
  if(editingBoxId){
    const i=s.boxes.findIndex(x=>x.id===editingBoxId);
    if(i>-1) s.boxes[i]=payload;
    editingBoxId=null; $('#bxAdd').textContent='Add / Save';
  }else{
    s.boxes.push(payload);
  }
  setSite(s); renderBoxes(); $('#bxClear').click();
});
$('#bxClear').addEventListener('click', ()=>{
  editingBoxId=null; $('#bxAdd').textContent='Add / Save';
  ['bxName','bxPrice','bxBundle','bxBadge','bxOrder','bxSpecs','bxPhotos'].forEach(id=>$('#'+id).value='');
  $('#bxVisible').checked=true;
});

/* ===== Gallery (Local) CRUD ===== */
let editingGalId=null;
function renderGalLocal(){
  const s=ensure(); const rows=$('#galLocalRows'); rows.innerHTML='';
  const list=[...(s.gallery||[])].sort((a,b)=>(a.order||0)-(b.order||0));
  list.forEach(g=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div><strong>${g.caption||''}</strong> <span class="sub">${g.url||''}</span></div>
      <div class="sub">Order: ${g.order??0}</div>
      <div class="sub">${g.visible===false?'Hidden':'Visible'}</div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-ed="${g.id}">Edit</button>
        <button class="btn" data-del="${g.id}">Delete</button>
      </div>`;
    rows.appendChild(row);
  });
  rows.querySelectorAll('button[data-ed]').forEach(b=>{
    b.onclick=()=>{
      const s=ensure(); const g=s.gallery.find(x=>x.id===b.dataset.ed); if(!g) return;
      editingGalId=g.id;
      $('#glLocCaption').value=g.caption||''; $('#glLocUrl').value=g.url||''; $('#glLocOrder').value=g.order||0; $('#glLocVisible').checked=g.visible!==false;
      $('#glLocAdd').textContent='Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  rows.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      if(!confirm('Delete this image?')) return;
      const s=ensure(); s.gallery=s.gallery.filter(x=>x.id!==b.dataset.del); setSite(s); renderGalLocal();
    };
  });
}
$('#glLocAdd').addEventListener('click', ()=>{
  const s=ensure();
  const payload={
    id: editingGalId || crypto.randomUUID(),
    caption: $('#glLocCaption').value.trim() || '',
    url: $('#glLocUrl').value.trim(),
    order: fmt($('#glLocOrder').value)||0,
    visible: $('#glLocVisible').checked
  };
  if(!payload.url){ alert('Image URL required'); return; }
  if(editingGalId){
    const i=s.gallery.findIndex(x=>x.id===editingGalId); if(i>-1) s.gallery[i]=payload;
    editingGalId=null; $('#glLocAdd').textContent='Add / Save';
  }else{
    s.gallery.push(payload);
  }
  setSite(s); renderGalLocal(); $('#glLocClear').click();
});
$('#glLocClear').addEventListener('click', ()=>{
  editingGalId=null; $('#glLocAdd').textContent='Add / Save';
  ['glLocCaption','glLocUrl','glLocOrder'].forEach(id=>$('#'+id).value='');
  $('#glLocVisible').checked=true;
});

/* ===== Import / Export ===== */
$('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([localStorage.getItem(KEY_CANON)||'{}'], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='settings.json'; a.click();
});
$('#btnImport').addEventListener('click', ()=>{
  const f=$('#fileImport').files?.[0]; if(!f){ toast('#ieStatus','Choose a JSON file first'); return; }
  const r=new FileReader();
  r.onload=()=>{ try{ const obj=JSON.parse(r.result); setSite(obj); loadAllLocal(); toast('#ieStatus','Imported ✔'); }catch(e){ toast('#ieStatus','Invalid JSON'); } };
  r.readAsText(f);
});

/* ===== Load all local sections ===== */
function loadAllLocal(){ loadGeneral(); renderPlans(); renderBoxes(); renderGalLocal(); }

/* ===== Orchestration ===== */
async function refreshAll(){
  await Promise.all([refreshKPIs(), loadBanners()]);
  loadAllLocal();
}
</script>
</body>
</html>