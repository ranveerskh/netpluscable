<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1">
<title>net+TV Admin</title>
<meta name="theme-color" content="#0b1020">
<style>
  :root{
    --bg:#0b1020;--ink:#e9edff;--muted:#a9b5e6;--card:#121831;--line:#23305b;
    --g1:#6a11cb;--g2:#2575fc;--tap:44px;--safe-top: env(safe-area-inset-top,0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#0b1020;color:var(--ink);-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  .topbar{position:sticky;top:0;z-index:100;background:rgba(11,16,32,.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.08)}
  .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:10px 16px;padding-top:calc(10px + var(--safe-top))}
  .brand{display:flex;gap:10px;align-items:center;font-weight:900}
  .badge{background:linear-gradient(135deg,var(--g1),var(--g2));padding:6px 10px;border-radius:10px;font-weight:900}
  .auth{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .chip{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#0f1732}
  .btn{border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:12px 14px;font-weight:800;background:#0f1732;color:var(--ink);cursor:pointer;min-height:var(--tap)}
  .btn.primary{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent;color:#fff}
  .btn.warn{background:#2d1d00;border-color:#5f3f00}
  .input{background:#0b122a;border:1px solid #22305a;border-radius:12px;padding:12px 14px;color:#e9edff;min-height:var(--tap);width:100%}
  textarea.input{min-height:120px}

  .tools{display:flex;gap:10px;flex-wrap:wrap;margin:10px 16px}
  .tbtn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1732;font-weight:800}
  .tbtn.active{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent;color:#fff}

  .section{padding:16px}
  .sub{color:#a9b5e6;font-size:13px}
  .cards{display:grid;gap:12px}
  @media(min-width:900px){.cards{grid-template-columns:repeat(4,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .kpi-val{font-size:28px;font-weight:900;line-height:1.1;margin-top:6px}

  .panel{display:none}
  .panel.active{display:block}

  .grid2{display:grid;gap:10px}
  @media(min-width:900px){.grid2{grid-template-columns:1fr 1fr}}
  .grid3{display:grid;gap:10px}
  @media(min-width:900px){.grid3{grid-template-columns:repeat(3,1fr)}}

  .rows{display:grid;gap:8px;margin-top:10px}
  .row{display:grid;gap:8px;background:#0f1732;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  @media(min-width:860px){.row{grid-template-columns:2fr 1fr 1fr auto}}
  .badge2{display:inline-block;background:#0f1732;border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px}
  .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="bar">
    <div class="brand"><span class="badge">net+TV</span> <span>Admin</span></div>

    <div class="auth" id="authArea">
      <input id="email" class="input" placeholder="Admin email" autocomplete="username" inputmode="email" style="width:220px">
      <input id="password" class="input" placeholder="Password" type="password" autocomplete="current-password" style="width:180px">
      <button class="btn primary" id="btnSignIn">Sign In</button>
    </div>
    <div class="auth" id="whoami" style="display:none">
      <span id="whoamiText" class="chip"></span>
      <button class="btn" id="btnSignOut">Sign Out</button>
    </div>
  </div>

  <div class="tools" id="navTabs">
    <button class="tbtn active" data-panel="home">Home</button>
    <button class="tbtn" data-panel="banners">Banners</button>
    <span class="chip">Site Settings (Firestore doc: <code>site_settings/public</code>)</span>
    <button class="tbtn" data-panel="general">General</button>
    <button class="tbtn" data-panel="plans">Plans</button>
    <button class="tbtn" data-panel="boxes">Boxes</button>
    <button class="tbtn" data-panel="gallery">Gallery</button>
    <button class="tbtn" data-panel="importExport">Import/Export</button>
  </div>
</div>

<div class="wrap">

  <!-- HOME -->
  <section id="panel-home" class="panel active section">
    <div class="sub">Signed in editors can push settings used by the public site.</div>
    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <div class="sub">Sync</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="btnLoadFS">Load from Firestore</button>
          <button class="btn primary" id="btnSaveFS">Save to Firestore</button>
        </div>
        <div id="syncStatus" class="sub" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <div class="sub">Quick Links</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <a class="btn" href="index.html" target="_blank" rel="noopener">Open Site</a>
          <a class="btn" href="https://console.firebase.google.com/" target="_blank" rel="noopener">Firebase Console</a>
        </div>
      </div>
    </div>
  </section>

  <!-- BANNERS -->
  <section id="panel-banners" class="panel section">
    <h3 style="margin:0 0 8px 0">Swipe Banners (collection)</h3>
    <div class="sub">Path: <code>site_settings/banners/items</code>. Only enabled, valid-date banners show on site.</div>
    <div class="grid3" style="margin-top:12px">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bnEnabled" checked> <span class="sub">Enabled</span></label>
      <input class="input" id="bnTitle" placeholder="Title">
      <input class="input" id="bnText" placeholder="Text">
      <input class="input" id="bnCtaLabel" placeholder="CTA label">
      <input class="input" id="bnCtaHref" placeholder="CTA href (https:// or #)">
      <input class="input" id="bnImageUrl" placeholder="Image URL (optional)">
      <input class="input" id="bnValidFrom" type="date" placeholder="Valid from">
      <input class="input" id="bnValidTo" type="date" placeholder="Valid to">
      <input class="input" id="bnOrder" type="number" placeholder="Order (0..N)">
      <button class="btn primary" id="bnSave">Save New Banner</button>
      <button class="btn" id="bnClear">Clear</button>
    </div>
    <div id="bnStatus" class="sub" style="margin-top:6px"></div>
    <div id="bannerList" class="rows"></div>
  </section>

  <!-- GENERAL -->
  <section id="panel-general" class="panel section">
    <h3 style="margin:0 0 8px 0">General</h3>
    <div class="sub">Currency & WhatsApp used site-wide.</div>
    <div class="grid3" style="margin-top:12px">
      <div class="card">
        <div class="sub">Currency</div>
        <div class="grid2" style="margin-top:8px">
          <input class="input" id="curSymbol" placeholder="Symbol ($)">
          <select class="input" id="curPos">
            <option value="prefix">Prefix ($100)</option>
            <option value="suffix">Suffix (100$)</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="sub">WhatsApp</div>
        <input class="input" id="waNumber" placeholder="WhatsApp number (digits only)" style="margin-top:8px">
      </div>
      <div class="card">
        <div class="sub">Actions</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="btnGenLoad">Load (working copy)</button>
          <button class="btn primary" id="btnGenSave">Save (working copy)</button>
        </div>
        <div id="genStatus" class="sub" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- PLANS -->
  <section id="panel-plans" class="panel section">
    <h3 style="margin:0 0 8px 0">Plans</h3>
    <div class="grid3" style="margin-top:12px">
      <input class="input" id="plName" placeholder="Name (e.g., 6 Months)">
      <input class="input" id="plMonths" type="number" placeholder="Months (e.g., 6)">
      <input class="input" id="plPrice" type="number" placeholder="Price (number)">
      <input class="input" id="plBadge" placeholder="Badge (e.g., Most Picked)">
      <input class="input" id="plNote" placeholder="Note (e.g., +1 month free)">
      <input class="input" id="plOrder" type="number" placeholder="Order (0..N)">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="plVisible" checked> <span class="sub">Visible</span></label>
      <button class="btn primary" id="plAdd">Add / Save</button>
      <button class="btn" id="plClear">Clear form</button>
    </div>
    <div id="planRows" class="rows"></div>
  </section>

  <!-- BOXES -->
  <section id="panel-boxes" class="panel section">
    <h3 style="margin:0 0 8px 0">Boxes</h3>
    <div class="sub">Supports photos, specs, and a <strong>bundle</strong> (Box + 1 Year) with free months.</div>
    <div class="grid3" style="margin-top:12px">
      <input class="input" id="bxName" placeholder="Name (e.g., Formular Z11 PRO)">
      <input class="input" id="bxPrice" type="number" placeholder="Base Price">
      <input class="input" id="bxBadge" placeholder="Badge (e.g., Recommended)">
      <input class="input" id="bxOrder" type="number" placeholder="Order (0..N)">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="bxVisible" checked> <span class="sub">Visible</span></label>
      <textarea class="input" id="bxSpecs" placeholder="Specs: one per line"></textarea>
      <textarea class="input" id="bxPhotos" placeholder="Photo URLs: one per line (optional caption with |, e.g. https://...jpg|Front)"></textarea>

      <div class="card" style="grid-column:1/-1">
        <div class="sub"><strong>Bundle (Box + 1 Year)</strong></div>
        <div class="grid3" style="margin-top:8px">
          <input class="input" id="bdlPrice" type="number" placeholder="Bundle Price">
          <input class="input" id="bdlFree" type="number" placeholder="Free months (0,1,2)">
          <input class="input" id="bdlNote" placeholder="Bundle note (optional)">
        </div>
      </div>

      <button class="btn primary" id="bxAdd">Add / Save</button>
      <button class="btn" id="bxClear">Clear form</button>
    </div>
    <div id="boxRows" class="rows"></div>
  </section>

  <!-- GALLERY -->
  <section id="panel-gallery" class="panel section">
    <h3 style="margin:0 0 8px 0">Gallery</h3>
    <div class="grid3" style="margin-top:12px">
      <input class="input" id="glCaption" placeholder="Caption">
      <input class="input" id="glUrl" placeholder="Image URL">
      <input class="input" id="glOrder" type="number" placeholder="Order">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="glVisible" checked> <span class="sub">Visible</span></label>
      <button class="btn primary" id="glAdd">Add / Save</button>
      <button class="btn" id="glClear">Clear form</button>
    </div>
    <div id="galRows" class="rows"></div>
  </section>

  <!-- IMPORT / EXPORT -->
  <section id="panel-importExport" class="panel section">
    <h3 style="margin:0 0 8px 0">Import / Export</h3>
    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <div class="sub">Export working copy (JSON)</div>
        <button class="btn" id="btnExport">Download settings.json</button>
      </div>
      <div class="card">
        <div class="sub">Import JSON (replaces working copy only)</div>
        <input type="file" id="fileImport" accept="application/json" class="input">
        <button class="btn primary" id="btnImport">Import</button>
      </div>
    </div>
    <div class="sub" id="ieStatus" style="margin-top:8px"></div>
  </section>

</div>

<script type="module">
/* Firebase */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, getDocs,
  doc, addDoc, setDoc, getDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
  authDomain: "netplustv-90b29.firebaseapp.com",
  projectId: "netplustv-90b29",
  storageBucket: "netplustv-90b29.firebasestorage.app",
  messagingSenderId: "639722274355",
  appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
};
const app = getApps().length? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* DOM helpers */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
function toast(el,msg){ el.textContent=msg; setTimeout(()=>{el.textContent='';},1800); }
function n(v){ return Number(v||0); }
function parseLines(v){ return v.split('\n').map(s=>s.trim()).filter(Boolean); }

/* Nav */
function showPanel(name){
  $$('#navTabs .tbtn').forEach(b=>b.classList.toggle('active', b.dataset.panel===name));
  ['home','banners','general','plans','boxes','gallery','importExport'].forEach(nm=>{
    $('#panel-'+nm).classList.toggle('active', nm===name);
  });
  window.scrollTo({top:0,behavior:'smooth'});
}
$('#navTabs').addEventListener('click', e=>{
  const b=e.target.closest('button[data-panel]'); if(!b) return;
  showPanel(b.dataset.panel);
});
window.showPanel=showPanel;

/* Auth */
$('#btnSignIn').addEventListener('click', async ()=>{
  const email=$('#email').value.trim(), pass=$('#password').value;
  if(!email||!pass) return alert('Enter email and password');
  try{ await signInWithEmailAndPassword(auth,email,pass); }catch(e){ alert('Sign in failed: '+(e?.message||e)); }
});
$('#btnSignOut').addEventListener('click',()=>signOut(auth));

onAuthStateChanged(auth, async (user)=>{
  if(user){
    $('#authArea').style.display='none';
    $('#whoami').style.display='flex';
    $('#whoamiText').textContent = user.email || '';
    await refreshAll();
  }else{
    $('#authArea').style.display='flex';
    $('#whoami').style.display='none';
    $('#bannerList').innerHTML='';
  }
});

/* ================= Working Copy (in-memory) ================= */
let WORK = {
  currency:{symbol:'$', position:'prefix'},
  whatsapp:{number:'16476961656'},
  plans:[],
  boxes:[],
  gallery:[]
};
const DOC_PATH = ['site_settings','public']; // doc(db,'site_settings','public')

/* ========= General ========= */
function loadGeneral(){
  $('#curSymbol').value = WORK.currency?.symbol || '$';
  $('#curPos').value = WORK.currency?.position || 'prefix';
  $('#waNumber').value = WORK.whatsapp?.number || '';
}
$('#btnGenLoad').addEventListener('click', loadGeneral);
$('#btnGenSave').addEventListener('click', ()=>{
  WORK.currency = {symbol: $('#curSymbol').value || '$', position: $('#curPos').value || 'prefix'};
  WORK.whatsapp = {number: ($('#waNumber').value||'').replace(/[^\d]/g,'')};
  toast($('#genStatus'), 'Saved to working copy ✔');
});

/* ========= Plans CRUD ========= */
let editingPlanId=null;
function renderPlans(){
  const rows = $('#planRows'); rows.innerHTML='';
  const list = [...(WORK.plans||[])].sort((a,b)=>(a.order||0)-(b.order||0));
  list.forEach(p=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div><strong>${p.name||''}</strong> <span class="sub">(${p.months||''} months)</span> ${p.badge? `<span class="badge2">${p.badge}</span>`:''} ${p.note? `<span class="sub">• ${p.note}</span>`:''}</div>
      <div>${Number(p.price)}</div>
      <div class="sub">Order: ${p.order??0} • ${p.visible===false?'Hidden':'Visible'}</div>
      <div class="actions">
        <button class="btn" data-ed="${p.id}">Edit</button>
        <button class="btn" data-del="${p.id}">Delete</button>
      </div>`;
    rows.appendChild(row);
  });
  rows.querySelectorAll('button[data-ed]').forEach(b=>{
    b.onclick=()=>{
      const p=WORK.plans.find(x=>x.id===b.dataset.ed); if(!p) return;
      editingPlanId=p.id;
      $('#plName').value=p.name||''; $('#plMonths').value=p.months||''; $('#plPrice').value=p.price||'';
      $('#plBadge').value=p.badge||''; $('#plNote').value=p.note||''; $('#plOrder').value=p.order||0;
      $('#plVisible').checked=p.visible!==false;
      $('#plAdd').textContent='Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  rows.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      if(!confirm('Delete this plan?')) return;
      WORK.plans = WORK.plans.filter(x=>x.id!==b.dataset.del);
      renderPlans();
    };
  });
}
$('#plAdd').addEventListener('click', ()=>{
  const payload = {
    id: editingPlanId || crypto.randomUUID(),
    name: $('#plName').value.trim() || 'Plan',
    months: n($('#plMonths').value) || null,
    price: n($('#plPrice').value) || 0,
    badge: $('#plBadge').value.trim() || null,
    note: $('#plNote').value.trim() || null,
    order: n($('#plOrder').value) || 0,
    visible: $('#plVisible').checked
  };
  if(editingPlanId){
    const i=WORK.plans.findIndex(x=>x.id===editingPlanId);
    if(i>-1) WORK.plans[i]=payload;
    editingPlanId=null; $('#plAdd').textContent='Add / Save';
  }else{
    WORK.plans.push(payload);
  }
  renderPlans(); $('#plClear').click();
});
$('#plClear').addEventListener('click', ()=>{
  editingPlanId=null; $('#plAdd').textContent='Add / Save';
  ['plName','plMonths','plPrice','plBadge','plNote','plOrder'].forEach(id=>$('#'+id).value='');
  $('#plVisible').checked=true;
});

/* ========= Boxes CRUD ========= */
let editingBoxId=null;
function renderBoxes(){
  const rows=$('#boxRows'); rows.innerHTML='';
  const list=[...(WORK.boxes||[])].sort((a,b)=>(a.order||0)-(b.order||0));
  list.forEach(bx=>{
    const photosCount = Array.isArray(bx.images)? bx.images.length : 0;
    const specsCount = Array.isArray(bx.specs)? bx.specs.length : 0;
    const bdl = bx.bundle;
    const bdlTxt = (bdl && (bdl.price||bdl.freeMonths||bdl.note))
      ? `Bundle: ${bdl.price||0} ${bdl.freeMonths? `(+${bdl.freeMonths}m free)` : ''} ${bdl.note? `— ${bdl.note}`:''}`
      : 'No bundle';
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div><strong>${bx.name||''}</strong> ${bx.badge? `<span class="badge2">${bx.badge}</span>`:''} <span class="sub">photos:${photosCount} • specs:${specsCount}</span></div>
      <div>${Number(bx.price)}</div>
      <div class="sub">Order: ${bx.order??0} • ${bx.visible===false?'Hidden':'Visible'} • ${bdlTxt}</div>
      <div class="actions">
        <button class="btn" data-ed="${bx.id}">Edit</button>
        <button class="btn" data-del="${bx.id}">Delete</button>
      </div>`;
    rows.appendChild(row);
  });
  rows.querySelectorAll('button[data-ed]').forEach(b=>{
    b.onclick=()=>{
      const bx=WORK.boxes.find(x=>x.id===b.dataset.ed); if(!bx) return;
      editingBoxId=bx.id;
      $('#bxName').value=bx.name||''; $('#bxPrice').value=bx.price||''; $('#bxBadge').value=bx.badge||'';
      $('#bxOrder').value=bx.order||0; $('#bxVisible').checked=bx.visible!==false;
      $('#bxSpecs').value=(bx.specs||[]).join('\n');
      $('#bxPhotos').value=(bx.images||[]).map(i=>i.url + (i.alt? `|${i.alt}`:'')).join('\n');
      $('#bdlPrice').value=bx.bundle?.price||''; $('#bdlFree').value=bx.bundle?.freeMonths||''; $('#bdlNote').value=bx.bundle?.note||'';
      $('#bxAdd').textContent='Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  rows.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      if(!confirm('Delete this box?')) return;
      WORK.boxes = WORK.boxes.filter(x=>x.id!==b.dataset.del); renderBoxes();
    };
  });
}
$('#bxAdd').addEventListener('click', ()=>{
  const imgs = parseLines($('#bxPhotos').value).map(line=>{
    const [url, alt] = line.split('|'); return {url:url?.trim(), alt:(alt||'').trim()};
  }).filter(i=>i.url);
  const specs = parseLines($('#bxSpecs').value);
  const bundle = ( $('#bdlPrice').value || $('#bdlFree').value || $('#bdlNote').value )
    ? { price: n($('#bdlPrice').value)||0, freeMonths: n($('#bdlFree').value)||0, note: ($('#bdlNote').value||'').trim() || null }
    : null;
  const payload = {
    id: editingBoxId || crypto.randomUUID(),
    name: $('#bxName').value.trim() || 'Box',
    price: n($('#bxPrice').value)||0,
    badge: $('#bxBadge').value.trim() || null,
    order: n($('#bxOrder').value)||0,
    visible: $('#bxVisible').checked,
    images: imgs,
    specs: specs,
    bundle: bundle
  };
  if(editingBoxId){
    const i=WORK.boxes.findIndex(x=>x.id===editingBoxId); if(i>-1) WORK.boxes[i]=payload;
    editingBoxId=null; $('#bxAdd').textContent='Add / Save';
  }else{
    WORK.boxes.push(payload);
  }
  renderBoxes(); $('#bxClear').click();
});
$('#bxClear').addEventListener('click', ()=>{
  editingBoxId=null; $('#bxAdd').textContent='Add / Save';
  ['bxName','bxPrice','bxBadge','bxOrder','bxSpecs','bxPhotos','bdlPrice','bdlFree','bdlNote'].forEach(id=>$('#'+id).value='');
  $('#bxVisible').checked=true;
});

/* ========= Gallery CRUD ========= */
let editingGalId=null;
function renderGallery(){
  const rows=$('#galRows'); rows.innerHTML='';
  const list=[...(WORK.gallery||[])].sort((a,b)=>(a.order||0)-(b.order||0));
  list.forEach(g=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div><strong>${g.caption||''}</strong> <span class="sub">${g.url||''}</span></div>
      <div class="sub">Order: ${g.order??0}</div>
      <div class="sub">${g.visible===false?'Hidden':'Visible'}</div>
      <div class="actions">
        <button class="btn" data-ed="${g.id}">Edit</button>
        <button class="btn" data-del="${g.id}">Delete</button>
      </div>`;
    rows.appendChild(row);
  });
  rows.querySelectorAll('button[data-ed]').forEach(b=>{
    b.onclick=()=>{
      const g=WORK.gallery.find(x=>x.id===b.dataset.ed); if(!g) return;
      editingGalId=g.id;
      $('#glCaption').value=g.caption||''; $('#glUrl').value=g.url||''; $('#glOrder').value=g.order||0; $('#glVisible').checked=g.visible!==false;
      $('#glAdd').textContent='Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  rows.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      if(!confirm('Delete image?')) return;
      WORK.gallery = WORK.gallery.filter(x=>x.id!==b.dataset.del); renderGallery();
    };
  });
}
$('#glAdd').addEventListener('click', ()=>{
  const payload={
    id: editingGalId || crypto.randomUUID(),
    caption: $('#glCaption').value.trim() || '',
    url: $('#glUrl').value.trim(),
    order: n($('#glOrder').value)||0,
    visible: $('#glVisible').checked
  };
  if(!payload.url){ alert('Image URL required'); return; }
  if(editingGalId){
    const i=WORK.gallery.findIndex(x=>x.id===editingGalId); if(i>-1) WORK.gallery[i]=payload;
    editingGalId=null; $('#glAdd').textContent='Add / Save';
  }else{
    WORK.gallery.push(payload);
  }
  renderGallery(); $('#glClear').click();
});
$('#glClear').addEventListener('click', ()=>{
  editingGalId=null; $('#glAdd').textContent='Add / Save';
  ['glCaption','glUrl','glOrder'].forEach(id=>$('#'+id).value='');
  $('#glVisible').checked=true;
});

/* ========= Import / Export ========= */
$('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(WORK,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='settings.json'; a.click();
});
$('#btnImport').addEventListener('click', ()=>{
  const f=$('#fileImport').files?.[0]; if(!f){ toast($('#ieStatus'),'Choose a JSON file first'); return; }
  const r=new FileReader();
  r.onload=()=>{
    try{
      const obj=JSON.parse(r.result);
      if(!obj || typeof obj!=='object') throw new Error('Invalid JSON');
      WORK = normalize(obj);
      loadGeneral(); renderPlans(); renderBoxes(); renderGallery();
      toast($('#ieStatus'),'Imported ✔ (working copy only)');
    }catch(e){ toast($('#ieStatus'),'Invalid JSON'); }
  };
  r.readAsText(f);
});

/* ========= Firestore Banners ========= */
async function loadBanners(){
  const snap = await getDocs(query(collection(db,'site_settings','banners','items'), orderBy('order','asc')));
  const list = $('#bannerList'); list.innerHTML='';
  snap.forEach(docSnap=>{
    const b = { id: docSnap.id, ...docSnap.data() };
    const row = document.createElement('div'); row.className='row'; row.innerHTML = `
      <div><strong>${b.title||'(no title)'} ${b.enabled? '' : '<span class="sub">[disabled]</span>'}</strong>
        <div class="sub">${b.text||''}</div>
        <div class="sub">CTA: ${b.ctaLabel||''} → ${(b.ctaHref||'').slice(0,80)}</div>
        <div class="sub">Order: ${b.order??0} | Valid: ${(b.validFrom||'')||'—'} → ${(b.validTo||'')||'—'}</div>
        <div class="sub">${b.imageUrl? 'Image: '+b.imageUrl : ''}</div>
      </div>
      <div class="actions">
        <button class="btn" data-act="toggle" data-id="${b.id}">${b.enabled? 'Disable' : 'Enable'}</button>
        <button class="btn" data-act="edit" data-id="${b.id}">Edit</button>
        <button class="btn" data-act="del" data-id="${b.id}">Delete</button>
      </div>
    `;
    list.appendChild(row);
  });
  list.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.id, act = btn.dataset.act;
      const ref = doc(db,'site_settings','banners','items',id);
      if(act==='toggle'){
        const snap = await getDoc(ref); const cur = snap.data();
        await setDoc(ref,{enabled:!cur.enabled, updatedAt:serverTimestamp()},{merge:true});
      }else if(act==='edit'){
        const snap = await getDoc(ref); const b = snap.data();
        $('#bnEnabled').checked = !!b.enabled;
        $('#bnTitle').value = b.title||''; $('#bnText').value=b.text||'';
        $('#bnCtaLabel').value=b.ctaLabel||''; $('#bnCtaHref').value=b.ctaHref||'';
        $('#bnImageUrl').value=b.imageUrl||''; $('#bnValidFrom').value=b.validFrom||''; $('#bnValidTo').value=b.validTo||'';
        $('#bnOrder').value=b.order??0;
        $('#bnSave').dataset.editId = id; $('#bnSave').textContent='Save Changes';
        toast($('#bnStatus'),'Loaded for editing');
        window.scrollTo({top:0,behavior:'smooth'});
      }else if(act==='del'){
        if(confirm('Delete this banner?')){ await deleteDoc(ref); }
      }
      await loadBanners();
    });
  });
}
$('#bnSave').addEventListener('click', async ()=>{
  const payload = {
    enabled: $('#bnEnabled').checked,
    title: $('#bnTitle').value.trim(),
    text: $('#bnText').value.trim(),
    ctaLabel: $('#bnCtaLabel').value.trim(),
    ctaHref: $('#bnCtaHref').value.trim(),
    imageUrl: $('#bnImageUrl').value.trim() || null,
    validFrom: $('#bnValidFrom').value || null,
    validTo: $('#bnValidTo').value || null,
    order: n($('#bnOrder').value||0),
    updatedAt: serverTimestamp()
  };
  const editId = $('#bnSave').dataset.editId;
  if(editId){
    await setDoc(doc(db,'site_settings','banners','items',editId), payload, {merge:true});
    $('#bnSave').textContent='Save New Banner';
    delete $('#bnSave').dataset.editId;
    toast($('#bnStatus'),'Saved ✔');
  }else{
    payload.createdAt = serverTimestamp();
    await addDoc(collection(db,'site_settings','banners','items'), payload);
    toast($('#bnStatus'),'Created ✔');
  }
  ['bnTitle','bnText','bnCtaLabel','bnCtaHref','bnImageUrl','bnOrder'].forEach(id=>$('#'+id).value='');
  await loadBanners();
});
$('#bnClear').addEventListener('click', ()=>{
  delete $('#bnSave').dataset?.editId;
  $('#bnSave').textContent='Save New Banner';
  ['bnEnabled','bnTitle','bnText','bnCtaLabel','bnCtaHref','bnImageUrl','bnValidFrom','bnValidTo','bnOrder'].forEach(id=>{
    const el=$('#'+id); if(!el) return;
    if(el.type==='checkbox') el.checked=true; else el.value='';
  });
});

/* ========= Normalize schema (for safety) ========= */
function normalize(obj){
  const out = {
    currency:{symbol: obj?.currency?.symbol || '$', position: (obj?.currency?.position==='suffix'?'suffix':'prefix')},
    whatsapp:{number: (obj?.whatsapp?.number||'16476961656').replace(/[^\d]/g,'')},
    plans: Array.isArray(obj?.plans)? obj.plans.map(p=>({
      id: p.id || crypto.randomUUID(),
      name: p.name || 'Plan',
      months: typeof p.months==='number'? p.months : null,
      price: Number(p.price||0),
      badge: p.badge || null,
      note: p.note || null,
      order: Number(p.order||0),
      visible: p.visible!==false
    })) : [],
    boxes: Array.isArray(obj?.boxes)? obj.boxes.map(b=>({
      id: b.id || crypto.randomUUID(),
      name: b.name || 'Box',
      price: Number(b.price||0),
      badge: b.badge || null,
      order: Number(b.order||0),
      visible: b.visible!==false,
      images: Array.isArray(b.images)? b.images.filter(i=>i?.url).map(i=>({url:String(i.url), alt:i.alt? String(i.alt):''})) : [],
      specs: Array.isArray(b.specs)? b.specs.map(String) : [],
      bundle: b.bundle && (b.bundle.price||b.bundle.freeMonths||b.bundle.note) ? {
        price: Number(b.bundle.price||0),
        freeMonths: Number(b.bundle.freeMonths||0),
        note: b.bundle.note || null
      } : null
    })) : [],
    gallery: Array.isArray(obj?.gallery)? obj.gallery.map(g=>({
      id: g.id || crypto.randomUUID(),
      caption: g.caption || '',
      url: g.url || '',
      order: Number(g.order||0),
      visible: g.visible!==false
    })) : []
  };
  return out;
}

/* ========= Firestore Sync for site_settings/public ========= */
async function loadFromFirestore(){
  const ref = doc(db, DOC_PATH[0], DOC_PATH[1]);
  const snap = await getDoc(ref);
  if(snap.exists()){
    WORK = normalize(snap.data());
  }else{
    // seed minimal defaults if missing
    WORK = normalize({
      currency:{symbol:'$', position:'prefix'},
      whatsapp:{number:'16476961656'},
      plans:[
        {name:'1 Month', months:1, price:15, badge:'Starter', order:0, visible:true, note:'Full features'},
        {name:'3 Months', months:3, price:40, badge:'Popular', order:1, visible:true, note:'Save vs monthly'},
        {name:'6 Months', months:6, price:65, badge:'Most Picked', order:2, visible:true},
        {name:'12 Months (+1 free)', months:12, price:100, badge:'Best Value', order:3, visible:true, note:'+1 month free'}
      ],
      boxes:[],
      gallery:[]
    });
  }
  loadGeneral(); renderPlans(); renderBoxes(); renderGallery();
}
async function saveToFirestore(){
  const ref = doc(db, DOC_PATH[0], DOC_PATH[1]);
  await setDoc(ref, normalize(WORK), {merge:false});
}

/* Buttons */
$('#btnLoadFS').addEventListener('click', async ()=>{
  try{ await loadFromFirestore(); toast($('#syncStatus'),'Loaded from Firestore ✔'); }catch(e){ toast($('#syncStatus'),'Load failed'); }
});
$('#btnSaveFS').addEventListener('click', async ()=>{
  try{ await saveToFirestore(); toast($('#syncStatus'),'Saved to Firestore ✔'); }catch(e){ toast($('#syncStatus'),'Save failed'); }
});

/* Orchestration */
async function refreshAll(){
  await loadBanners();
  await loadFromFirestore();
}
</script>
</body>
</html>