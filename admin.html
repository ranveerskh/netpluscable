<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1">
<title>net+TV Admin</title>
<meta name="theme-color" content="#0b1020">
<style>
  :root{--bg:#0b1020;--ink:#e9edff;--muted:#a9b5e6;--card:#121831;--line:#23305b;--g1:#6a11cb;--g2:#2575fc;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#0b1020;color:var(--ink)}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .topbar{position:sticky;top:0;z-index:100;background:rgba(11,16,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:900;display:flex;gap:10px;align-items:center}
  .badge{background:linear-gradient(135deg,var(--g1),var(--g2));padding:6px 10px;border-radius:10px;font-weight:900}
  .auth input{background:#0b122a;border:1px solid #22305a;border-radius:10px;padding:10px 12px;color:#e9edff;min-width:200px}
  .btn{border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:10px 12px;font-weight:800;background:#0f1732;color:var(--ink);cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent;color:#fff}
  .quicklinks{display:flex;gap:8px;overflow:auto;padding:10px 16px;border-top:1px solid rgba(255,255,255,.08)}
  .qbtn{flex:0 0 auto;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1732;font-weight:900;white-space:nowrap}
  .qbtn.primary{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
  .tab{padding:10px 12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#0f1732;font-weight:800}
  .tab.active{background:linear-gradient(135deg,var(--g1),var(--g2));border-color:transparent}
  .cards{display:grid;gap:12px} @media(min-width:900px){.cards{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .h{font-weight:900;font-size:18px}.sub{color:#a9b5e6;font-size:13px}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .input{background:#0b122a;border:1px solid #22305a;border-radius:10px;padding:10px 12px;color:#e9edff}
  .tablewrap{margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
  thead th{background:#0e1836;color:#cfe0ff;text-align:left;position:sticky;top:0;z-index:1}
  .kpis{display:grid;gap:10px;margin:12px 0}
  @media(min-width:900px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .kpi{background:#0f1732;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .kpi .val{font-size:22px;font-weight:900;margin-top:4px}
</style>
</head>
<body>
<div class="topbar">
  <div class="wrap row" style="justify-content:space-between;padding:10px 16px;padding-top:calc(10px + env(safe-area-inset-top))">
    <div class="brand"><span class="badge">net+TV</span> <span>Admin</span></div>
    <div class="auth row" id="authArea">
      <input id="email" placeholder="Admin email">
      <input id="password" placeholder="Password" type="password">
      <button class="btn primary" id="btnSignIn">Sign In</button>
    </div>
    <div class="auth row" id="whoami" style="display:none">
      <span id="whoamiText"></span>
      <button class="btn" id="btnSignOut">Sign Out</button>
    </div>
  </div>
  <div class="quicklinks wrap" role="navigation" aria-label="Quick admin links">
    <a class="qbtn primary" href="https://beta.gpanel.me/login" target="_blank" rel="noopener">Glow TV</a>
    <a class="qbtn" href="https://fast4k.cc/login" target="_blank" rel="noopener">Smart4K TV</a>
    <a class="qbtn" href="data.hdml" target="_blank" rel="noopener">data.hdml</a>
  </div>
</div>

<div class="wrap">
  <!-- Live Stats (2) -->
  <div class="kpis" id="kpis">
    <div class="kpi"><div class="sub">Visitors (24h)</div><div class="val" id="kpiVisitors">—</div></div>
    <div class="kpi"><div class="sub">Trials (24h)</div><div class="val" id="kpiTrials">—</div></div>
    <div class="kpi"><div class="sub">Leads (7d)</div><div class="val" id="kpiLeads">—</div></div>
    <div class="kpi"><div class="sub">Location Allowed (24h)</div><div class="val" id="kpiLoc">—</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" role="tablist">
    <button class="tab active" id="tab-leads"   onclick="showPanel('leads')">Leads (+2 months)</button>
    <button class="tab"         id="tab-trials"  onclick="showPanel('trials')">Trials (2‑day)</button>
    <button class="tab"         id="tab-visitors"onclick="showPanel('visitors')">Visitors</button>
    <button class="tab"         id="tab-banner"  onclick="showPanel('banner')">Offer Banner</button>
  </div>

  <!-- Leads (3) -->
  <section id="panel-leads" class="cards">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><div class="h">Leads</div><div class="sub">People who registered for +2 months</div></div>
        <div class="tools">
          <input id="leadSearch" class="input" placeholder="Search email/name/phone…">
          <select id="leadSource" class="input"><option value="">All sources</option><option>promo-14months</option></select>
          <button class="btn" id="leadRefresh">Refresh</button>
        </div>
      </div>
      <div class="tablewrap">
        <table id="leadsTable">
          <thead><tr><th>Created</th><th>Email</th><th>Name</th><th>Phone</th><th>Source</th><th>VID</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Trials (3) -->
  <section id="panel-trials" class="cards" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><div class="h">Trials</div><div class="sub">2‑day trial requests</div></div>
        <div class="tools">
          <input id="trialSearch" class="input" placeholder="Search email/device/country…">
          <select id="trialStatus" class="input"><option value="">All statuses</option><option>pending</option><option>active</option><option>expired</option><option>blocked</option></select>
          <button class="btn" id="trialRefresh">Refresh</button>
        </div>
      </div>
      <div class="tablewrap">
        <table id="trialsTable">
          <thead><tr><th>Created</th><th>Status</th><th>Email</th><th>Device (masked)</th><th>Country</th><th>VID</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Visitors (3) -->
  <section id="panel-visitors" class="cards" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><div class="h">Visitors (latest 200)</div><div class="sub">Steps & optional location</div></div>
        <div class="tools">
          <input id="visSearch" class="input" placeholder="Filter by VID/page…">
          <select id="hasLoc" class="input"><option value="">All</option><option value="yes">Has location</option><option value="no">No location</option></select>
          <button class="btn" id="visRefresh">Refresh</button>
        </div>
      </div>
      <div class="tablewrap">
        <table id="visitorsTable">
          <thead><tr><th>Time</th><th>VID</th><th>Steps (today)</th><th>Steps (session)</th><th>Lat</th><th>Lon</th><th>Acc</th><th>Page</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Offer Banner Editor -->
  <section id="panel-banner" class="cards" style="display:none">
    <div class="card">
      <div class="h">Offer Banner</div>
      <div class="sub">Edit the banner shown on the website header</div>
      <div class="row" style="margin-top:10px">
        <input id="bnrEnabled" type="checkbox" /> <label for="bnrEnabled"> Enabled</label>
      </div>
      <div class="row"><input id="bnrTitle" class="input" placeholder="Title (e.g., Canada Day Offer)"></div>
      <div class="row"><input id="bnrText" class="input" placeholder="Main text (e.g., Get 1 month extra with 1-year plan)"></div>
      <div class="row"><input id="bnrCtaLabel" class="input" placeholder="CTA label (e.g., Get 13 months)"><input id="bnrCtaHref" class="input" placeholder="CTA link (e.g., #, https://... )"></div>
      <div class="row"><button class="btn primary" id="bnrSave">Save Banner</button><span class="sub" id="bnrStatus"></span></div>
      <div class="sub">Stored at <code>site_settings/promo</code>. Your index page will read this doc.</div>
    </div>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, limit, where, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
  authDomain: "netplustv-90b29.firebaseapp.com",
  projectId: "netplustv-90b29",
  storageBucket: "netplustv-90b29.firebasestorage.app",
  messagingSenderId: "639722274355",
  appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* UI helpers */
const $ = s => document.querySelector(s);
function showPanel(name){
  ['leads','trials','visitors','banner'].forEach(n=>{
    $('#panel-'+n).style.display = (n===name)?'grid':'none';
    $('#tab-'+n)?.classList.toggle('active', n===name);
  });
}
window.showPanel = showPanel;

/* Auth */
$('#btnSignIn').addEventListener('click', async ()=>{
  const email=$('#email').value.trim(), pass=$('#password').value;
  if(!email||!pass) return alert('Enter email and password');
  try{ await signInWithEmailAndPassword(auth,email,pass); }catch(e){ alert('Sign in failed: '+(e?.message||e)); }
});
$('#btnSignOut').addEventListener('click',()=>signOut(auth));

onAuthStateChanged(auth, async (user)=>{
  if(user){
    $('#authArea').style.display='none'; $('#whoami').style.display='flex'; $('#whoamiText').textContent=user.email||'';
    await Promise.all([loadKpis(), refreshLeads(), refreshTrials(), refreshVisitors(), loadBanner()]);
  }else{
    $('#authArea').style.display='flex'; $('#whoami').style.display='none';
  }
});

/* ========== Live KPIs (2) ========== */
async function loadKpis(){
  const now = Date.now();
  const dayAgo = new Date(now - 24*3600*1000);
  const weekAgo = new Date(now - 7*24*3600*1000);

  // Visitors last 24h (distinct vids)
  const vSnap = await getDocs(query(collection(db,'analytics_visitors'), orderBy('createdAt','desc'), limit(500)));
  const vids = new Set(); let loc = 0;
  vSnap.forEach(d=>{
    const t = d.data().createdAt?.toDate?.() || d.data().ts ? new Date(d.data().createdAt?.seconds? d.data().createdAt.seconds*1000 : d.data().ts) : null;
    if(t && t >= dayAgo){ vids.add(d.data().vid); if(typeof d.data().lat==='number' && typeof d.data().lon==='number') loc++; }
  });
  $('#kpiVisitors').textContent = vids.size || '0';
  $('#kpiLoc').textContent = loc || '0';

  // Trials last 24h
  const tSnap = await getDocs(query(collection(db,'trials'), orderBy('createdAt','desc'), limit(500)));
  let t24 = 0; tSnap.forEach(d=>{ const t=d.data().createdAt?.toDate?.(); if(t && t>=dayAgo) t24++; });
  $('#kpiTrials').textContent = t24 || '0';

  // Leads last 7d
  const lSnap = await getDocs(query(collection(db,'leads'), orderBy('createdAt','desc'), limit(1000)));
  let l7=0; lSnap.forEach(d=>{ const t=d.data().createdAt?.toDate?.(); if(t && t>=weekAgo) l7++; });
  $('#kpiLeads').textContent = l7 || '0';
}

/* ========== Leads (3) ========== */
let leadsCache=[];
async function refreshLeads(){
  const src = $('#leadSource').value;
  let qRef = query(collection(db,'leads'), orderBy('createdAt','desc'), limit(500));
  if(src) qRef = query(collection(db,'leads'), where('source','==',src), orderBy('createdAt','desc'), limit(500));
  const snap = await getDocs(qRef);
  leadsCache = snap.docs.map(d=>({id:d.id,...d.data()}));
  renderLeads();
}
function renderLeads(){
  const term = ($('#leadSearch').value||'').toLowerCase();
  const rows = leadsCache.filter(r=>{
    if(!term) return true;
    return ['email','name','phone','source'].some(k=>String(r[k]||'').toLowerCase().includes(term));
  });
  const tb = $('#leadsTable tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const ts=r.createdAt?.toDate?.() || null;
    tr.innerHTML = `<td>${ts?ts.toLocaleString():''}</td><td>${r.email||''}</td><td>${r.name||''}</td><td>${r.phone||''}</td><td>${r.source||''}</td><td class="sub">${r.vid||''}</td>`;
    tb.appendChild(tr);
  });
}
$('#leadRefresh').addEventListener('click', refreshLeads);
$('#leadSearch').addEventListener('input', renderLeads);
$('#leadSource').addEventListener('change', refreshLeads);

/* ========== Trials (3) ========== */
let trialsCache=[];
async function refreshTrials(){
  const status = $('#trialStatus').value;
  let qRef = query(collection(db,'trials'), orderBy('createdAt','desc'), limit(500));
  if(status) qRef = query(collection(db,'trials'), where('status','==',status), orderBy('createdAt','desc'), limit(500));
  const snap = await getDocs(qRef);
  trialsCache = snap.docs.map(d=>({id:d.id,...d.data()}));
  renderTrials();
}
function renderTrials(){
  const term = ($('#trialSearch').value||'').toLowerCase();
  const rows = trialsCache.filter(r=>{
    const s = [r.email,r.deviceId,r.country,r.status].map(v=>String(v||'').toLowerCase()).join(' ');
    return !term || s.includes(term);
  });
  const tb = $('#trialsTable tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const ts=r.createdAt?.toDate?.() || null;
    const mask = (s='')=> s.length<=6? s.replace(/.(?=..)/g,'*') : s.slice(0,3)+'***'+s.slice(-3);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${ts?ts.toLocaleString():''}</td><td>${r.status||''}</td><td>${r.email||''}</td><td>${mask(r.deviceId||'')}</td><td>${r.country||''}</td><td class="sub">${r.vid||''}</td>`;
    tb.appendChild(tr);
  });
}
$('#trialRefresh').addEventListener('click', refreshTrials);
$('#trialSearch').addEventListener('input', renderTrials);
$('#trialStatus').addEventListener('change', refreshTrials);

/* ========== Visitors (3) ========== */
let visCache=[];
async function refreshVisitors(){
  let qRef = query(collection(db,'analytics_visitors'), orderBy('createdAt','desc'), limit(200));
  const snap = await getDocs(qRef);
  visCache = snap.docs.map(d=>({id:d.id,...d.data()}));
  renderVisitors();
}
function renderVisitors(){
  const term = ($('#visSearch').value||'').toLowerCase();
  const loc  = $('#hasLoc').value;
  const rows = visCache.filter(r=>{
    const has = typeof r.lat==='number' && typeof r.lon==='number';
    if(loc==='yes' && !has) return false;
    if(loc==='no'  &&  has) return false;
    const text = [r.vid,r.page].map(v=>String(v||'').toLowerCase()).join(' ');
    return !term || text.includes(term);
  });
  const tb = $('#visitorsTable tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const ts=r.createdAt?.toDate?.() || (r.ts?new Date(r.ts):null);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${ts?ts.toLocaleString():''}</td><td class="sub">${r.vid||''}</td><td>${r.steps_today??''}</td><td>${r.steps_session??''}</td><td>${r.lat??''}</td><td>${r.lon??''}</td><td>${r.accuracy??''}</td><td class="sub">${(r.page||'').slice(0,40)}${(r.page||'').length>40?'…':''}</td>`;
    tb.appendChild(tr);
  });
}
$('#visRefresh').addEventListener('click', refreshVisitors);
$('#visSearch').addEventListener('input', renderVisitors);
$('#hasLoc').addEventListener('change', renderVisitors);

/* ========== Banner Editor ========== */
async function loadBanner(){
  const ref = doc(db,'site_settings','promo');
  const snap = await getDoc(ref);
  const d = snap.exists()? snap.data() : { enabled:true, title:'', text:'', ctaLabel:'', ctaHref:'#' };
  $('#bnrEnabled').checked = !!d.enabled;
  $('#bnrTitle').value = d.title || '';
  $('#bnrText').value = d.text || '';
  $('#bnrCtaLabel').value = d.ctaLabel || '';
  $('#bnrCtaHref').value = d.ctaHref || '#';
}
async function saveBanner(){
  const ref = doc(db,'site_settings','promo');
  const data = {
    enabled: $('#bnrEnabled').checked,
    title: $('#bnrTitle').value.trim(),
    text: $('#bnrText').value.trim(),
    ctaLabel: $('#bnrCtaLabel').value.trim(),
    ctaHref: $('#bnrCtaHref').value.trim(),
    updatedAt: serverTimestamp()
  };
  await setDoc(ref, data, { merge:true });
  $('#bnrStatus').textContent = 'Saved ✔';
  setTimeout(()=>$('#bnrStatus').textContent='',2000);
}
$('#bnrSave').addEventListener('click', saveBanner);

/* bindings for refresh buttons already set above */
</script>
</body>
</html>