<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin ‚Ä¢ Customers</title>
<style>
  :root { --bg:#0b1020; --card:#121831; --ink:#e7ecff; --muted:#9aa7d9; --accent:#6a8cff; --accent2:#8a5bff; --danger:#ff647c; --ok:#35d0a7; --input:#0f1530; --border:#23305b }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:
    radial-gradient(1200px 800px at 80% -10%,rgba(138,91,255,.15),transparent 60%),
    radial-gradient(900px 700px at 0% 0%,rgba(106,140,255,.18),transparent 55%),var(--bg);color:var(--ink)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;position:sticky;top:0;background:linear-gradient(180deg,rgba(10,14,30,.9),rgba(10,14,30,.4));backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
  .brand{font-weight:700}
  .btn{padding:9px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;font-weight:600;color:white;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .btn.ghost{background:transparent;color:var(--ink)}
  .btn.bad{background:linear-gradient(135deg,#ff5a7a,#ff8aa0)}
  .btn.ok{background:linear-gradient(135deg,#39d0a7,#6ae6c7)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  main{padding:18px;max-width:1200px;margin:0 auto}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0f1530;color:var(--ink);cursor:pointer}
  .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{padding:9px 11px;border:1px solid var(--border);border-radius:10px;background:var(--input);color:var(--ink);outline:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{color:var(--muted);text-align:left}
  .pill{padding:3px 8px;border-radius:999px;font-size:12px;display:inline-block;border:1px solid var(--border)}
  .pill.active{background:rgba(53,208,167,.2);color:#9df2dc;border-color:rgba(53,208,167,.4)}
  .pill.overdue{background:rgba(255,100,124,.18);color:#ffc0ca;border-color:rgba(255,100,124,.4)}
  .muted{color:var(--muted)} .nowrap{white-space:nowrap} .right{margin-left:auto}
  .section{display:none} .section.active{display:block}
  .small{font-size:12px} .w-200{min-width:200px} .hr{height:1px;background:var(--border);margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="brand">üóÇÔ∏è Admin ‚Ä¢ Customers</div>
  <div class="row"><div class="right muted small" id="statusText">Ready</div></div>
</header>

<main>
  <div class="tabs">
    <div class="tab active" data-tab="customers">Customers</div>
    <div class="tab" data-tab="devices">Devices</div>
    <div class="tab" data-tab="plans">Plans</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="reports">Reports</div>
  </div>

  <!-- Customers -->
  <section id="customers" class="section active">
    <div class="card">
      <div class="row">
        <input id="c_name" placeholder="Name" class="w-200" />
        <input id="c_phone" placeholder="Phone" />
        <input id="c_email" placeholder="Email" />
        <select id="c_plan"></select>
        <select id="c_status">
          <option>active</option><option>trial</option><option>overdue</option><option>inactive</option>
        </select>
        <input id="c_start" type="date" />
        <input id="c_expiry" type="date" />
        <input id="c_notes" placeholder="Notes" class="w-200" />
        <button id="addCustomer" class="btn">+ Add</button>
      </div>
    </div>
    <div class="card" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Phone</th><th>Email</th><th>Plan</th><th>Status</th><th>Expiry</th><th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody id="custBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Devices -->
  <section id="devices" class="section">
    <div class="card">
      <div class="row">
        <select id="d_customer"></select>
        <input id="d_mac" placeholder="AA:BB:CC:DD:EE:FF" />
        <input id="d_type" placeholder="device_type (optional)" />
        <select id="d_status"><option>active</option><option>inactive</option></select>
        <button id="addDevice" class="btn">+ Add</button>
      </div>
    </div>
    <div class="card" style="padding:0">
      <table>
        <thead><tr><th>Customer</th><th>MAC</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="devBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Plans -->
  <section id="plans" class="section">
    <div class="card">
      <div class="row">
        <input id="p_id" placeholder="id (e.g., PLN-1MO)" />
        <input id="p_name" placeholder="name" />
        <input id="p_dur" type="number" placeholder="duration_months" />
        <input id="p_retail" type="number" step="0.01" placeholder="retail_price" />
        <input id="p_cost" type="number" step="0.01" placeholder="wholesale_cost" />
        <input id="p_desc" placeholder="description" class="w-200" />
        <button id="addPlan" class="btn">+ Upsert</button>
      </div>
      <div class="small muted">duration_months = 0 ‚Üí product (no expiry).</div>
    </div>
    <div class="card" style="padding:0">
      <table>
        <thead><tr><th>ID</th><th>Name</th><th>Months</th><th>Retail</th><th>Cost</th><th>Description</th><th>Actions</th></tr></thead>
        <tbody id="planBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Payments -->
  <section id="payments" class="section">
    <div class="card">
      <div class="row">
        <select id="pay_customer"></select>
        <select id="pay_itemType">
          <option value="plan">plan</option>
          <option value="product">product</option>
        </select>
        <select id="pay_item"></select>
        <input id="pay_qty" type="number" placeholder="quantity (default 1)" />
        <input id="pay_months" type="number" placeholder="months (for plan)" />
        <input id="pay_amount" type="number" step="0.01" placeholder="amount (paid)" />
        <input id="pay_retail" type="number" step="0.01" placeholder="unit_retail_at_txn (opt)" />
        <input id="pay_cost" type="number" step="0.01" placeholder="unit_cost_at_txn (opt)" />
        <input id="pay_method" placeholder="method" />
        <input id="pay_ref" placeholder="reference/note" class="w-200" />
        <button id="addPayment" class="btn">+ Add Payment</button>
      </div>
    </div>
    <div class="card" style="padding:0">
      <table>
        <thead>
          <tr><th>Date</th><th>Customer</th><th>Type</th><th>Item</th><th>Qty</th><th>Months</th><th>Amount</th><th>Expense</th><th>Profit</th><th>Ref/Note</th></tr>
        </thead>
        <tbody id="payBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Reports -->
  <section id="reports" class="section">
    <div class="card">
      <div class="row">
        <label>From (YYYY‚ÄëMM)</label><input id="fromM" placeholder="2025-01" />
        <label>To</label><input id="toM" placeholder="2025-12" />
        <button id="runRpt" class="btn">Run</button>
      </div>
    </div>
    <div class="card">
      <div class="row">
        <div><b>Lifetime Income:</b> <span id="ltIncome">0</span></div>
        <div><b>Lifetime Expense:</b> <span id="ltExpense">0</span></div>
        <div><b>Lifetime Profit:</b> <span id="ltProfit">0</span></div>
      </div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Month</th><th>Income</th><th>Expense</th><th>Profit</th></tr></thead>
          <tbody id="rptBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- Firebase + App code -->
<script type="module">
  /* ---------- Firebase SDK ---------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, getDocs, getDoc, addDoc, setDoc, deleteDoc,
    query, where, orderBy, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
    authDomain: "netplustv-90b29.firebaseapp.com",
    projectId: "netplustv-90b29",
    storageBucket: "netplustv-90b29.firebasestorage.app",
    messagingSenderId: "639722274355",
    appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ---------- Helpers ---------- */
  const $ = sel => document.querySelector(sel);
  function setStatus(t){ $("#statusText").textContent = t; }
  function today(){ return new Date().toISOString().slice(0,10); }
  function addMonths(yyyyMmDd, months){
    if(!yyyyMmDd) return null;
    const d = new Date(`${yyyyMmDd}T00:00:00Z`);
    d.setUTCMonth(d.getUTCMonth() + Number(months||1));
    const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,"0"), day=String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function esc(s=""){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

  /* ---------- State (loaded from Firestore) ---------- */
  let plans = [];
  let customers = [];
  let devices = [];
  let payments = [];

  /* ---------- Tabs ---------- */
  document.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      el.classList.add("active");
      $("#"+el.dataset.tab).classList.add("active");
      if(el.dataset.tab==="payments") renderPayments();
      if(el.dataset.tab==="devices") renderDevices();
      if(el.dataset.tab==="plans") renderPlans();
      if(el.dataset.tab==="customers") renderCustomers();
    });
  });

  /* ---------- Loads from Firestore ---------- */
  async function loadPlans(){
    const snap = await getDocs(query(collection(db,"plans"), orderBy("name")));
    plans = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  async function loadCustomers(){
    const snap = await getDocs(query(collection(db,"customers"), orderBy("name")));
    customers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  async function loadDevices(){
    const snap = await getDocs(collection(db,"devices"));
    devices = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  async function loadPayments(){
    const snap = await getDocs(query(collection(db,"payments"), orderBy("date","desc")));
    payments = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }

  /* ---------- Renderers ---------- */
  function refreshSelectors(){
    $("#c_plan").innerHTML = plans.map(p=>`<option value="${esc(p.id)}">${esc(p.name)} (${p.duration_months||0} mo)</option>`).join("");
    $("#d_customer").innerHTML = customers.map(c=>`<option value="${esc(c.id)}">${esc(c.name)}</option>`).join("");
    $("#pay_customer").innerHTML = customers.map(c=>`<option value="${esc(c.id)}">${esc(c.name)}</option>`).join("");
    fillPayItems();
  }
  function fillPayItems(){
    const type = $("#pay_itemType").value;
    const list = plans.filter(p => type==="plan" ? Number(p.duration_months||0)>0 : Number(p.duration_months||0)===0);
    $("#pay_item").innerHTML = list.map(p=>`<option value="${esc(p.id)}">${esc(p.name)}</option>`).join("");
  }
  $("#pay_itemType").addEventListener("change", fillPayItems);

  function renderCustomers(){
    refreshSelectors();
    $("#custBody").innerHTML = customers.map(c=>{
      const pl = plans.find(p=>p.id===c.plan_id);
      const pill = c.status==="active" ? 'pill active' : (c.status==="overdue" ? 'pill overdue' : 'pill');
      return `
        <tr>
          <td>${esc(c.name||"")} <div class="small muted">${esc(c.id||"")}</div></td>
          <td class="nowrap">${esc(c.phone||"")}</td>
          <td>${esc(c.email||"")}</td>
          <td>${esc(pl?pl.name:(c.plan_id||"‚Äî"))}</td>
          <td><span class="${pill}">${esc(c.status||"")}</span></td>
          <td>${c.expiryDate||"‚Äî"}</td>
          <td class="nowrap">
            <button class="btn ghost" onclick="editCustomer('${c.id}')">Edit</button>
            <button class="btn bad" onclick="delCustomer('${c.id}')">Delete</button>
            <div class="hr"></div>
            <button class="btn ok" onclick="renew('${c.id}')">Renew</button>
            <button class="btn ghost" onclick="sellProduct('${c.id}')">Sell Product</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  function renderDevices(){
    $("#devBody").innerHTML = devices.map(d=>{
      const c = customers.find(x=>x.id===d.customer_id);
      return `
        <tr>
          <td>${esc(c?c.name:d.customer_id)}</td>
          <td>${esc(d.mac)}</td>
          <td>${esc(d.device_type||"")}</td>
          <td>${esc(d.status||"active")}</td>
          <td><button class="btn bad" onclick="delDevice('${d.id}')">Delete</button></td>
        </tr>
      `;
    }).join("");
  }

  function renderPlans(){
    $("#planBody").innerHTML = plans.map(p=>`
      <tr>
        <td>${esc(p.id)}</td>
        <td>${esc(p.name)}</td>
        <td>${esc(p.duration_months)}</td>
        <td>${Number(p.retail_price||0).toFixed(2)}</td>
        <td>${Number(p.wholesale_cost||0).toFixed(2)}</td>
        <td>${esc(p.description||"")}</td>
        <td><button class="btn bad" onclick="delPlan('${p.id}')">Delete</button></td>
      </tr>
    `).join("");
  }

  function renderPayments(){
    $("#payBody").innerHTML = payments.map(p=>{
      const c = customers.find(x=>x.id===p.customer_id);
      return `
        <tr>
          <td>${esc(p.date||"")}</td>
          <td>${esc(c?c.name:p.customer_id)}</td>
          <td>${esc(p.item_type||"")}</td>
          <td>${esc(p.item_id||"")}</td>
          <td>${p.quantity||1}</td>
          <td>${p.months||0}</td>
          <td>${Number(p.amount||0).toFixed(2)}</td>
          <td>${Number(p.expense||0).toFixed(2)}</td>
          <td>${Number(p.profit||0).toFixed(2)}</td>
          <td>${esc(p.reference||p.note||"")}</td>
        </tr>
      `;
    }).join("");
  }

  /* ---------- CRUD: Customers ---------- */
  $("#addCustomer").onclick = async ()=>{
    const row = {
      name: $("#c_name").value.trim(),
      phone: $("#c_phone").value.trim(),
      email: $("#c_email").value.trim(),
      plan_id: $("#c_plan").value || "",
      status: $("#c_status").value,
      startDate: $("#c_start").value || "",
      expiryDate: $("#c_expiry").value || "",
      notes: $("#c_notes").value.trim(),
      createdAt: today(),
      updatedAt: today()
    };
    if(!row.name){ alert("Name required"); return; }
    await addDoc(collection(db,"customers"), row);
    await loadCustomers(); renderCustomers(); setStatus("Customer added");
    $("#c_name").value=$("#c_phone").value=$("#c_email").value=$("#c_start").value=$("#c_expiry").value=$("#c_notes").value="";
  };

  window.editCustomer = async (id)=>{
    const ref = doc(db,"customers", id);
    const snap = await getDoc(ref); if(!snap.exists()) return alert("Not found");
    const c = snap.data();
    const name = prompt("Name", c.name||""); if(name===null) return;
    const phone = prompt("Phone", c.phone||""); if(phone===null) return;
    const email = prompt("Email", c.email||""); if(email===null) return;
    const plan_id = prompt("Plan ID", c.plan_id||""); if(plan_id===null) return;
    const status = prompt("Status (active/trial/overdue/inactive)", c.status||"active"); if(status===null) return;
    const startDate = prompt("Start (YYYY-MM-DD)", c.startDate||""); if(startDate===null) return;
    const expiryDate = prompt("Expiry (YYYY-MM-DD)", c.expiryDate||""); if(expiryDate===null) return;
    const notes = prompt("Notes", c.notes||""); if(notes===null) return;

    await setDoc(ref, { name, phone, email, plan_id, status, startDate, expiryDate, notes, updatedAt: today() }, { merge:true });
    await loadCustomers(); renderCustomers(); setStatus("Customer updated");
  };

  window.delCustomer = async (id)=>{
    if(!confirm("Delete this customer?")) return;
    // delete customer's devices
    const devSnap = await getDocs(query(collection(db,"devices"), where("customer_id","==",id)));
    const batch = writeBatch(db);
    devSnap.forEach(d=> batch.delete(doc(db,"devices", d.id)));
    batch.delete(doc(db,"customers", id));
    await batch.commit();
    await loadCustomers(); await loadDevices();
    renderCustomers(); renderDevices(); setStatus("Customer deleted");
  };

  /* ---------- Devices ---------- */
  $("#addDevice").onclick = async ()=>{
    const row = {
      customer_id: $("#d_customer").value,
      mac: $("#d_mac").value.trim(),
      device_type: $("#d_type").value.trim(),
      status: $("#d_status").value,
      addedAt: today()
    };
    if(!row.customer_id || !row.mac){ alert("Customer + MAC required"); return; }
    await addDoc(collection(db,"devices"), row);
    $("#d_mac").value=""; $("#d_type").value="";
    await loadDevices(); renderDevices(); setStatus("Device added");
  };

  window.delDevice = async (id)=>{
    if(!confirm("Delete device?")) return;
    await deleteDoc(doc(db,"devices", id));
    await loadDevices(); renderDevices(); setStatus("Device deleted");
  };

  /* ---------- Plans ---------- */
  $("#addPlan").onclick = async ()=>{
    const id = $("#p_id").value.trim();
    const name = $("#p_name").value.trim();
    const duration_months = Number($("#p_dur").value||0);
    const retail_price = Number($("#p_retail").value||0);
    const wholesale_cost = Number($("#p_cost").value||0);
    const description = $("#p_desc").value.trim();
    if(!id || !name){ alert("id and name required"); return; }
    await setDoc(doc(db,"plans", id), { name, duration_months, retail_price, wholesale_cost, description }, { merge:true });
    $("#p_id").value=$("#p_name").value=$("#p_dur").value=$("#p_retail").value=$("#p_cost").value=$("#p_desc").value="";
    await loadPlans(); renderPlans(); renderCustomers(); setStatus("Plan upserted");
  };

  window.delPlan = async (id)=>{
    if(!confirm("Delete plan/product?")) return;
    await deleteDoc(doc(db,"plans", id));
    await loadPlans(); renderPlans(); renderCustomers(); setStatus("Plan deleted");
  };

  /* ---------- Payments (manual add) ---------- */
  $("#addPayment").onclick = async ()=>{
    const customer_id = $("#pay_customer").value;
    const item_type = $("#pay_itemType").value; // plan/product
    const item_id = $("#pay_item").value;
    const quantity = Number($("#pay_qty").value||1);
    const months = Number($("#pay_months").value||0);
    const amountIn = $("#pay_amount").value;
    const unit_retail_at_txn = $("#pay_retail").value ? Number($("#pay_retail").value) : undefined;
    const unit_cost_at_txn = $("#pay_cost").value ? Number($("#pay_cost").value) : undefined;
    const method = $("#pay_method").value.trim() || "other";
    const reference = $("#pay_ref").value.trim();

    if(!customer_id || !item_id){ alert("Customer and item required"); return; }
    const plan = plans.find(p=>p.id===item_id);

    const retail = unit_retail_at_txn ?? (plan? Number(plan.retail_price||0) : 0);
    const cost   = unit_cost_at_txn   ?? (plan? Number(plan.wholesale_cost||0): 0);
    const expense = (item_type==="product") ? cost * quantity : cost * (months||1);
    const paid = amountIn ? Number(amountIn) : (item_type==="product" ? retail*quantity : retail*(months||1));
    const profit = paid - expense;

    const p = {
      customer_id, item_type, item_id,
      quantity: item_type==="product" ? quantity : 1,
      months: item_type==="plan" ? (months||1) : 0,
      date: today(),
      period_start: null,
      period_end: null,
      amount: Number(paid.toFixed(2)),
      unit_retail_at_txn: retail,
      unit_cost_at_txn: cost,
      expense: Number(expense.toFixed(2)),
      profit: Number(profit.toFixed(2)),
      method, reference, note: reference,
      createdAt: today()
    };
    await addDoc(collection(db,"payments"), p);
    await loadPayments(); renderPayments(); setStatus("Payment added");
  };

  /* ---------- Renew / Sell from Customers ---------- */
  window.renew = async (customer_id)=>{
    const cRef = doc(db,"customers", customer_id);
    const cSnap = await getDoc(cRef); if(!cSnap.exists()) return alert("Customer not found");
    const c = cSnap.data();
    const plan = plans.find(p=>p.id===c.plan_id && Number(p.duration_months||0)>0);
    if(!plan){ alert("Customer plan not found or not a plan"); return; }

    const months = Number(prompt(`Months to add (default ${plan.duration_months})`, plan.duration_months)||plan.duration_months);
    if(!months) return;
    const amount = Number(prompt(`Amount received (default ${plan.retail_price})`, plan.retail_price)||plan.retail_price);
    const unit_cost = Number(plan.wholesale_cost||0);

    const newExpiry = addMonths(c.expiryDate || c.startDate || today(), months);
    const expense = unit_cost * months;
    const profit = amount - expense;

    const payObj = {
      customer_id, item_type:"plan", item_id: plan.id,
      quantity: 1, months, date: today(),
      period_start: null, period_end: null,
      amount: Number(amount.toFixed(2)),
      unit_retail_at_txn: Number(plan.retail_price||0),
      unit_cost_at_txn: unit_cost,
      expense: Number(expense.toFixed(2)),
      profit: Number(profit.toFixed(2)),
      method:"cash", reference:"renew", note:"renew", createdAt: today()
    };

    // write payment + update customer
    const batch = writeBatch(db);
    batch.set(doc(collection(db,"payments")), payObj);
    batch.set(cRef, { expiryDate: newExpiry, status:"active", updatedAt: today() }, { merge:true });
    await batch.commit();

    await loadCustomers(); await loadPayments();
    renderCustomers(); renderPayments(); setStatus("Renewed");
  };

  window.sellProduct = async (customer_id)=>{
    const prods = plans.filter(p=>Number(p.duration_months||0)===0);
    if(prods.length===0){ alert("No products configured"); return; }
    const choice = prompt("Product id ("+prods.map(p=>p.id).join(", ")+")", prods[0].id);
    if(!choice) return;
    const prod = prods.find(p=>p.id===choice); if(!prod) return alert("Invalid product");
    const qty = Number(prompt("Quantity",1)||1);
    const defaultAmt = Number(prod.retail_price||0)*qty;
    const amount = Number(prompt(`Amount received (default ${defaultAmt})`, defaultAmt)||defaultAmt);
    const expense = Number(prod.wholesale_cost||0)*qty;
    const profit = amount - expense;

    const payObj = {
      customer_id, item_type:"product", item_id: prod.id,
      quantity: qty, months:0, date: today(),
      amount: Number(amount.toFixed(2)),
      unit_retail_at_txn: Number(prod.retail_price||0),
      unit_cost_at_txn: Number(prod.wholesale_cost||0),
      expense: Number(expense.toFixed(2)),
      profit: Number(profit.toFixed(2)),
      method:"cash", reference:"product sale", note:"", createdAt: today()
    };
    await addDoc(collection(db,"payments"), payObj);
    await loadPayments(); renderPayments(); setStatus("Product sold");
  };

  /* ---------- Reports ---------- */
  $("#runRpt").onclick = ()=>{
    const from = ($("#fromM").value||"1900-01");
    const to = ($("#toM").value||"9999-12");
    const rows = {};
    let ltI=0, ltE=0, ltP=0;
    payments.forEach(p=>{
      const ym = (p.date||"").slice(0,7);
      if(!ym || ym<from || ym>to) return;
      rows[ym] ||= {month:ym, income:0, expense:0, profit:0};
      rows[ym].income += Number(p.amount||0);
      rows[ym].expense += Number(p.expense||0);
      rows[ym].profit  += Number(p.profit||0);
      ltI += Number(p.amount||0);
      ltE += Number(p.expense||0);
      ltP += Number(p.profit||0);
    });
    $("#ltIncome").textContent = ltI.toFixed(2);
    $("#ltExpense").textContent = ltE.toFixed(2);
    $("#ltProfit").textContent  = ltP.toFixed(2);
    const out = Object.values(rows).sort((a,b)=>a.month.localeCompare(b.month));
    $("#rptBody").innerHTML = out.map(r=>`<tr><td>${r.month}</td><td>${r.income.toFixed(2)}</td><td>${r.expense.toFixed(2)}</td><td>${r.profit.toFixed(2)}</td></tr>`).join("");
  };

  /* ---------- Init ---------- */
  async function init(){
    setStatus("Loading‚Ä¶");
    await loadPlans(); await loadCustomers(); await loadDevices(); await loadPayments();
    renderPlans(); renderCustomers(); renderDevices(); renderPayments(); setStatus("Ready");
  }
  init();
</script>
</body>
</html>
