<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Net + Cable â€¢ Admin</title>
<style>
  :root{
    --bg:#0b1020;--card:#121831;--ink:#e7ecff;--muted:#9aa7d9;--accent:#6a8cff;--accent2:#8a5ff;--danger:#ff647c;--ok:#35d0a7;--border:#23305b;--warn:#ffc857;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:
    radial-gradient(1300px 800px at 80% -10%,rgba(138,91,255,.15),transparent 60%),
    radial-gradient(900px 700px at 0% 0%,rgba(106,140,255,.18),transparent 55%),
    linear-gradient(180deg,#0b1020,#0b1020 30%,#0b1020);
    color:var(--ink)
  }
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;
       padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#182041}
  .btn.ghost{background:transparent;border-color:var(--border);color:var(--ink)}
  .btn.warn{background:linear-gradient(135deg,#ff9d00,#ff6800)}
  .btn.danger{background:linear-gradient(135deg,#ff5b73,#ff1f49)}
  .btn.ok{background:linear-gradient(135deg,#3cd6b5,#15a37f)}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#1a2244;border:1px solid #2a3670;color:#cfe2ff;font-size:12px}
  .topbar{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.8);backdrop-filter: blur(8px);border-bottom:1px solid var(--border)}
  .topbar .wrap{display:flex;align-items:center;gap:14px;justify-content:space-between}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#121831}
  .tab.active{background:linear-gradient(135deg,#1b2350,#1a244f)}
  .grid{width:100%;border-collapse:collapse}
  .grid th,.grid td{padding:10px;border-bottom:1px solid #1d274e;font-size:14px}
  .grid th{text-align:left;color:#c7d3ff;background:#121a3a;position:sticky;top:0}
  .muted{color:var(--muted)}
  .hidden{display:none!important}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1530;color:var(--ink)}
  label{display:block;margin-top:10px;margin-bottom:6px;color:#ccd6ff;font-size:13px}
  .kpi{padding:12px;border-radius:12px;border:1px solid var(--border);background:#121a3a}
  .kpi .big{font-size:24px;font-weight:800}
  .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .right{float:right}
  .center{text-align:center}
  .flex{display:flex;gap:10px;align-items:center}
  .grow{flex:1}
  .badge-exp{background:#2a1a1a;color:#ffb3c0;border:1px solid #624}
  .badge-ok{background:#14231b;color:#b9ffe9;border:1px solid #264}
  .badge-warn{background:#2a2416;color:#ffe7a8;border:1px solid #684}
</style>
</head>
<body>

<!-- AUTH VIEW -->
<div id="authView" class="wrap auth">
  <div class="card">
    <h2 class="logo">Net + Cable <span class="subtle">â€¢ Admin Sign In</span></h2>
    <p class="muted" style="margin-top:6px">Use your admin email & password from Firebase Auth.</p>
    <label>Email</label>
    <input id="authEmail" type="email" placeholder="you@company.com" />
    <label>Password</label>
    <input id="authPass" type="password" placeholder="********" />
    <div class="flex" style="margin-top:12px">
      <button class="btn ok" id="btnLogin" type="button">Sign In</button>
    </div>
    <p id="authMsg" class="muted" style="margin-top:10px"></p>
  </div>
</div>

<!-- APP VIEW -->
<div id="appView" class="hidden">
  <div class="topbar">
    <div class="wrap">
      <div class="flex">
        <div class="logo">Net + Cable <span class="muted">â€¢ Admin</span></div>
        <div id="envInfo" class="chip">Disconnected</div>
      </div>
      <div class="flex">
        <div id="nearExpCount" class="pill muted">Near expiry: 0</div>
        <button id="signOutBtn" class="btn secondary" type="button">Sign Out</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="tabs" style="margin-bottom:12px">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="customers">Customers</div>
      <div class="tab" data-tab="plans">Plans</div>
      <div class="tab" data-tab="reports">Reports</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>

    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="card">
      <div class="row">
        <div class="col kpi"><div class="muted">Total Customers</div><div id="kpiCustomers" class="big">0</div></div>
        <div class="col kpi"><div class="muted">Turnover (Allâ€‘time)</div><div id="kpiTurnover" class="big">$0.00</div></div>
        <div class="col kpi"><div class="muted">Expense (Allâ€‘time)</div><div id="kpiExpense" class="big">$0.00</div></div>
        <div class="col kpi"><div class="muted">Profit (Allâ€‘time)</div><div id="kpiProfit" class="big">$0.00</div></div>
      </div>

      <h3 style="margin-top:18px">Near Expiry</h3>
      <div class="flex" style="margin-bottom:8px">
        <div class="muted">Show customers expiring within</div>
        <select id="nearDays" class="pill">
          <option value="7">7 days</option>
          <option value="14">14 days</option>
          <option value="30" selected>30 days</option>
          <option value="60">60 days</option>
        </select>
      </div>
      <div class="card" style="padding:0">
        <table class="grid" id="nearGrid">
          <thead><tr>
            <th>Name</th><th>Phone</th><th>Plan</th><th>Expiry</th><th>Days Left</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section id="tab-customers" class="card hidden">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="flex grow">
          <input id="searchCustomers" placeholder="Search by name, phone, email, MAC, user ID..." />
        </div>
        <div class="flex">
          <button id="btnAddCustomer" class="btn ok" type="button">+ Add Customer</button>
        </div>
      </div>
      <div class="card" style="padding:0">
        <table class="grid" id="custGrid">
          <thead><tr>
            <th>Name</th><th>Phone</th><th>Email</th><th>User ID</th><th>MAC</th>
            <th>Plan</th><th>Start</th><th>Expiry</th><th>Paid</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PLANS -->
    <section id="tab-plans" class="card hidden">
      <div class="flex" style="justify-content:space-between;margin-bottom:8px">
        <h3>Plans</h3>
        <div class="flex">
          <button id="btnSeedPlans" class="btn ghost" type="button">Seed sample plans</button>
          <button id="btnAddPlan" class="btn ok" type="button">+ Add Plan</button>
        </div>
      </div>
      <div class="card" style="padding:0">
        <table class="grid" id="plansGrid">
          <thead><tr>
            <th>ID</th><th>Name</th><th>Duration (months)</th>
            <th>Retail $</th><th>Wholesale $</th><th>Description</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="tab-reports" class="card hidden">
      <div class="row">
        <div class="col">
          <label>Report Type</label>
          <select id="repType">
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="col" id="repMonthCol">
          <label>Month</label>
          <input id="repMonth" type="month">
        </div>
        <div class="col" id="repYearCol">
          <label>Year</label>
          <input id="repYear" type="number" min="2000" max="2100" value="">
        </div>
        <div class="col hidden" id="repFromCol">
          <label>From (start date)</label>
          <input id="repFrom" type="date">
        </div>
        <div class="col hidden" id="repToCol">
          <label>To (end date)</label>
          <input id="repTo" type="date">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button id="btnRunReport" class="btn" type="button">Run Report</button>
        <button id="btnCsv" class="btn ghost" type="button">Export CSV</button>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="col kpi"><div class="muted">Turnover</div><div id="repTurnover" class="big">$0.00</div></div>
        <div class="col kpi"><div class="muted">Expense</div><div id="repExpense" class="big">$0.00</div></div>
        <div class="col kpi"><div class="muted">Profit</div><div id="repProfit" class="big">$0.00</div></div>
      </div>

      <h3 style="margin-top:18px">Included Plans in Period</h3>
      <div class="card" style="padding:0">
        <table class="grid" id="repGrid">
          <thead><tr>
            <th>Date</th><th>Customer</th><th>Plan</th><th>Turnover $</th><th>Expense $</th><th>Profit $</th><th>Paid</th><th>Invoice</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="card hidden">
      <h3>Settings</h3>
      <label>Near-expiry threshold (days)</label>
      <input id="settingNearDays" type="number">
      <p class="muted" style="margin-top:6px"></p>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

      <div class="flex">
        <button id="btnCleanupOrphans" class="btn danger" type="button">ðŸ—‘ Delete Orphan Renewals</button>
        <span id="cleanupMsg" class="muted"></span>
      </div>
    </section>
  </div>
</div>

<!-- jsPDF for PDF invoices -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script type="module">
/* =========================
   Firebase Setup (ESM CDN)
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy, serverTimestamp, collectionGroup, writeBatch} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ---- Firebase Config (replace if different) ---- */
const firebaseConfig = {
  apiKey: "AIzaSyBOEuLTwXHlgwCeUJk-8zHLjtsljr-5CFM",
  authDomain: "netplustv-90b29.firebaseapp.com",
  projectId: "netplustv-90b29",
  storageBucket: "netplustv-90b29.firebasestorage.app",
  messagingSenderId: "639722274355",
  appId: "1:639722274355:web:ebe34fdf093f8191da2d46"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =========================
   Helpers (dates, money)
   ========================= */
const $  = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const fmt = n => (isNaN(+n)? '$0.00' : '$' + (+n).toFixed(2));
const todayISO = () => new Date().toISOString().slice(0,10);

function addMonthsISO(startISO, months){
  if (!startISO) return "";
  const d = new Date(startISO + "T00:00:00");
  if (isNaN(d.getTime())) return "";
  const day = d.getDate();
  d.setMonth(d.getMonth()+Number(months||0));
  if (d.getDate() !== day) d.setDate(0);
  return d.toISOString().slice(0,10);
}
function daysLeft(expISO){
  const end = new Date((expISO||'')+"T23:59:59");
  const now = new Date();
  return Math.ceil((end - now) / (1000*60*60*24));
}
function calcFigures({cost, wholesale, stbIncluded, stbCost, stbWholesale}){
  cost = +cost||0; wholesale = +wholesale||0;
  stbCost = +stbCost||0; stbWholesale=+stbWholesale||0;
  const turnover = cost + (stbIncluded==='yes'?stbCost:0);
  const expense  = wholesale + (stbIncluded==='yes'?stbWholesale:0);
  const profit   = turnover - expense;
  return {turnover, expense, profit};
}

/* =========================
   Invoice (PDF)
   ========================= */
const LOGO_DATA_URL = ""; // Optional: data:image/png;base64,AAA...

function makeInvoiceNumber(prefix="INV"){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${prefix}-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}
function safe(v){ return v==null?"":String(v); }

function generateInvoice({customer, record, type="Current Plan"}){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  const margin = 40;
  let y = margin;

  // Header with logo + title
  if (LOGO_DATA_URL) {
    try{ doc.addImage(LOGO_DATA_URL, "PNG", margin, y, 120, 40); }catch(e){}
  }
  doc.setFont("helvetica","bold"); doc.setFontSize(18);
  doc.text("Net + TV â€” Invoice", LOGO_DATA_URL? (margin+130) : margin, y+24);
  y += 60;

  // Invoice meta
  const invNo = makeInvoiceNumber();
  doc.setFontSize(12); doc.setFont("helvetica","normal");
  doc.text(`Invoice #: ${invNo}`, margin, y);
  doc.text(`Date: ${todayISO()}`, margin+250, y);
  y += 22;

  // Customer section
  doc.setFont("helvetica","bold");
  doc.text("Bill To:", margin, y);
  y += 16;
  doc.setFont("helvetica","normal");
  doc.text(`Name: ${safe(customer.name)}`, margin, y); y+=16;
  doc.text(`Phone: ${safe(customer.phone)}`, margin, y); y+=16;
  doc.text(`Email: ${safe(customer.email)}`, margin, y); y+=16;
  doc.text(`User ID: ${safe(customer.userId)}   MAC: ${safe(customer.mac)}`, margin, y); y+=28;

  // Plan section
  doc.setFont("helvetica","bold");
  doc.text(`${type} Details`, margin, y);
  y += 16; doc.setFont("helvetica","normal");
  const rows = [
    ["Plan", `${safe(record.planName)} (${record.durationMonths||0} months)`],
    ["Start Date", safe(record.startDate)],
    ["Expiry Date", safe(record.expiryDate)],
    ["Retail (Plan)", fmt(record.cost)],
    ["Wholesale (Plan)", fmt(record.wholesale)],
    ["STB Included", record.stbIncluded === "yes" ? "Yes" : "No"],
    ...(record.stbIncluded === "yes" ? [
      ["STB Retail", fmt(record.stbCost||0)],
      ["STB Wholesale", fmt(record.stbWholesale||0)],
    ] : []),
    ["Payment Received", record.paymentReceived === "yes" ? "Yes" : "No"],
  ];
  rows.forEach(([k,v])=>{
    doc.text(`${k}:`, margin, y); doc.text(String(v), margin+160, y); y += 16;
  });
  y += 10;

  // Totals
  const figs = calcFigures({
    cost:record.cost, wholesale:record.wholesale,
    stbIncluded:record.stbIncluded, stbCost:record.stbCost, stbWholesale:record.stbWholesale
  });
  doc.setFont("helvetica","bold");
  doc.text("Summary", margin, y); y += 16;
  doc.setFont("helvetica","normal");
  doc.text(`Turnover: ${fmt(figs.turnover)}`, margin, y); y += 16;
  doc.text(`Expense:  ${fmt(figs.expense)}`, margin, y); y += 16;
  doc.text(`Profit:   ${fmt(figs.profit)}`, margin, y); y += 24;

  // Footer
  doc.setFontSize(10);
  doc.text("Thank you for your business!", margin, y);
  y += 14;
  doc.text("Net + TV â€¢ Invoice includes plan start & expiry details", margin, y);

  const filename = `Invoice-${safe(customer.name||record.customerName||"Customer")}-${record.startDate||todayISO()}.pdf`;
  doc.save(filename);
}

/* =========================
   UI state / tabs
   ========================= */
const authView = $("#authView");
const appView  = $("#appView");
const tabs = $$(".tab");
const sections = {
  dashboard: $("#tab-dashboard"),
  customers: $("#tab-customers"),
  plans: $("#tab-plans"),
  reports: $("#tab-reports"),
  settings: $("#tab-settings"),
};
tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(sections).forEach(s=>s.classList.add('hidden'));
    sections[t.dataset.tab].classList.remove('hidden');
  });
});

/* =========================
   AUTH
   ========================= */
const authEmail = $("#authEmail");
const authPass  = $("#authPass");
const authMsg   = $("#authMsg");

$("#btnLogin").onclick = async ()=>{
  authMsg.textContent = "Signing in...";
  try{
    await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPass.value.trim());
    authMsg.textContent = "Signed in.";
  }catch(e){
    console.error(e);
    authMsg.textContent = (e.code||'auth/error') + " â€” " + e.message;
  }
};
$("#signOutBtn").onclick = ()=> signOut(auth);

onAuthStateChanged(auth, (user)=>{
  if(user){
    authView.classList.add('hidden');
    appView.classList.remove('hidden');
    $("#envInfo").textContent = "Connected";
    loadApp(user).catch(err=>console.error(err));
  }else{
    appView.classList.add('hidden');
    authView.classList.remove('hidden');
    $("#envInfo").textContent = "Disconnected";
  }
});

/* =========================
   Data caches
   ========================= */
let plans = {};          // id -> plan
let customers = [];      // [{id, ...}]
let renewals = [];       // all renewals (collectionGroup)
let settingNear = 30;

/* =========================
   Load initial app data
   ========================= */
async function loadApp(user){
  // controls
  $("#settingNearDays").value = settingNear;
  $("#settingNearDays").addEventListener('change', ()=>{
    settingNear = Math.max(1, +$("#settingNearDays").value||30);
    $("#nearDays").value = String(settingNear);
    renderAll();
  });
  $("#nearDays").value = String(settingNear);
  $("#nearDays").addEventListener('change', ()=>{
    settingNear = +$("#nearDays").value;
    $("#settingNearDays").value = settingNear;
    renderAll();
  });

  // buttons
  $("#btnAddCustomer").onclick = () => openCustomerModal(null);
  $("#btnSeedPlans").onclick = seedPlans;
  $("#btnAddPlan").onclick = ()=>openPlanModal();
  $("#btnRunReport").addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); runReport(); });
  $("#btnCsv").addEventListener("click",  (e) => { e.preventDefault(); e.stopPropagation(); exportCSV(); });
  $("#btnCleanupOrphans").onclick = cleanupOrphanRenewals;
  $("#searchCustomers").addEventListener('input', renderCustomers);

  await Promise.all([loadPlans(), loadCustomers(), loadRenewals()]);
  const now = new Date();
  $("#repMonth").value = now.toISOString().slice(0,7);
  $("#repYear").value  = String(now.getFullYear());
  $("#repType").addEventListener('change', onRepTypeChange);
  onRepTypeChange();
  runReport();
  renderAll();
}

async function cleanupOrphanRenewals(){
  const msg = $("#cleanupMsg");
  const btn = $("#btnCleanupOrphans");
  try{
    btn.disabled = true; msg.textContent = "Scanningâ€¦";
    await loadCustomers();
    const existing = new Set(customers.map(c => String(c.id)));
    const snap = await getDocs(collectionGroup(db, "renewals"));
    const orphans = [];
    snap.forEach(d => {
      const data = d.data() || {};
      const cid  = String(data.customerId || "");
      if (!existing.has(cid)) orphans.push(d.ref);
    });
    if (orphans.length === 0){
      msg.textContent = "No orphan renewals found.";
      return;
    }
    msg.textContent = `Deleting ${orphans.length} orphan renewalsâ€¦`;
    const CHUNK = 400;
    for (let i = 0; i < orphans.length; i += CHUNK){
      const batch = writeBatch(db);
      for (let j = i; j < Math.min(i+CHUNK, orphans.length); j++){
        batch.delete(orphans[j]);
      }
      await batch.commit();
    }
    await loadRenewals();
    renderKPIs();
    runReport();
    msg.textContent = `Deleted ${orphans.length} orphan renewals.`;
  }catch(err){
    console.error("[cleanupOrphanRenewals]", err);
    alert(err?.message || "Failed to clean up orphan renewals");
    msg.textContent = "Error during cleanup.";
  }finally{
    btn.disabled = false;
  }
}

/* =========================
   Firestore load/save
   ========================= */
async function loadPlans(){
  plans = {};
  const snap = await getDocs(query(collection(db, "plans"), orderBy("id")));
  snap.forEach(d=>{ plans[d.id] = d.data(); });
  renderPlans();
}
async function savePlan(p){
  const ref = doc(db, "plans", String(p.id));
  await setDoc(ref, p, {merge:true});
  plans[p.id] = p;
  renderPlans();
  refreshPlanSelects();
}
async function deleteCustomerAndRenewals(customerId) {
  const idStr = String(customerId);
  const renSnap = await getDocs(collection(db, "customers", idStr, "renewals"));
  const batch = writeBatch(db);
  renSnap.forEach(d => { batch.delete(doc(db, "customers", idStr, "renewals", d.id)); });
  batch.delete(doc(db, "customers", idStr));
  await batch.commit();
  await loadCustomers();
  await loadRenewals();
  renderAll();
}
async function deletePlan(id){
  await deleteDoc(doc(db, "plans", String(id)));
  delete plans[id];
  renderPlans();
  refreshPlanSelects();
}
async function loadCustomers(){
  customers = [];
  const snap = await getDocs(query(collection(db,"customers"), orderBy("name")));
  snap.forEach(d=> customers.push({id:d.id, ...d.data()}) );
  renderCustomers();
}
async function saveCustomer(payload, existingId=null){
  if (existingId) {
    const idStr = String(existingId);
    const ref = doc(db,"customers", idStr);
    payload.updatedAt = serverTimestamp();
    await updateDoc(ref, payload);
    await loadCustomers();
    return idStr;
  } else {
    const ref = await addDoc(collection(db,"customers"), {
      ...payload,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    await loadCustomers();
    return String(ref.id);
  }
}
async function addRenewal(customerId, ren){
  const ref = await addDoc(collection(db, "customers", String(customerId), "renewals"), { ...ren, createdAt: serverTimestamp() });
  await loadRenewals();
  return String(ref.id);
}
async function loadRenewals(){
  renewals = [];
  const snap = await getDocs(collectionGroup(db, "renewals"));
  snap.forEach(d=> renewals.push({id:d.id, ...d.data(), _path: d.ref.path}) );
}
async function setCustomerCurrentPlan(customerId, planFields){
  const ref = doc(db, "customers", String(customerId));
  await updateDoc(ref, { currentPlan: planFields, updatedAt: serverTimestamp() });
}

/* =========================
   Rendering
   ========================= */
function renderAll(){
  renderCustomers();
  renderKPIs();
  renderNearExpiry();
}

function renderPlans(){
  const tbody = $("#plansGrid tbody");
  tbody.innerHTML = "";
  const ids = Object.keys(plans).sort();
  ids.forEach(id=>{
    const p = plans[id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name||''}</td>
      <td>${p.duration_months||0}</td>
      <td>${(+p.retail_price||0).toFixed(2)}</td>
      <td>${(+p.wholesale_cost||0).toFixed(2)}</td>
      <td>${p.description||''}</td>
      <td class="flex">
        <button class="btn ghost" data-edit="${p.id}">Edit</button>
        <button class="btn danger" data-del="${p.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const pid = btn.getAttribute('data-edit');
      const p = plans[pid];
      openPlanModal(p);
    };
  });
  tbody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = async()=>{
      const pid = btn.getAttribute('data-del');
      if(confirm("Delete plan "+pid+" ?")) await deletePlan(pid);
    };
  });
  refreshPlanSelects();
}

function renderCustomers(){
  const q = ($("#searchCustomers").value||"").toLowerCase().trim();
  const tbody = $("#custGrid tbody");
  tbody.innerHTML = "";
  customers.forEach(c=>{
    const inText = `${c.name||''} ${c.phone||''} ${c.email||''} ${c.userId||''} ${c.mac||''}`.toLowerCase();
    if(q && !inText.includes(q)) return;
    const plan = c.currentPlan || {};
    const paid = (plan.paymentReceived==='yes') ? '<span class="badge-ok pill">Yes</span>' : '<span class="badge-warn pill">No</span>';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.name||''}</td>
      <td>${c.phone||''}</td>
      <td>${c.email||''}</td>
      <td>${c.userId||''}</td>
      <td>${c.mac||''}</td>
      <td>${plan.planName||''}</td>
      <td>${plan.startDate||''}</td>
      <td>${plan.expiryDate||''} ${daysLeftBadge(plan.expiryDate)}</td>
      <td>${paid}</td>
      <td class="flex" style="gap:6px;flex-wrap:wrap">
        <button class="btn ghost" data-view="${c.id}">View</button>
        <button class="btn secondary" data-edit="${c.id}">Edit</button>
        <button class="btn ok" data-renew="${c.id}">Renew</button>
        <button class="btn danger" data-del="${c.id}">Delete</button>
        <button class="btn" data-invoice="${c.id}">Invoice</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  $("#kpiCustomers").textContent = String(customers.length);

  tbody.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=> openCustomerModal(btn.getAttribute('data-edit'));
  });
  tbody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = async()=>{
      const id = btn.getAttribute('data-del');
      if(confirm("Delete this customer and all their renewals?")){
        await deleteCustomerAndRenewals(id);
      }
    };
  });
  tbody.querySelectorAll("[data-renew]").forEach(btn=>{
    btn.onclick = ()=> openRenewModal(btn.getAttribute('data-renew'));
  });
  tbody.querySelectorAll("[data-view]").forEach(btn=>{
    btn.onclick = ()=> viewCustomer(btn.getAttribute('data-view'));
  });
  tbody.querySelectorAll("[data-invoice]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-invoice');
      const c = customers.find(x=>x.id===id);
      if(!c || !c.currentPlan){ alert("No current plan found for this customer."); return; }
      generateInvoice({ customer: c, record: c.currentPlan, type: "Current Plan" });
    };
  });
}

function daysLeftBadge(exp){
  if(!exp) return '';
  const d = daysLeft(exp);
  if(d<0) return ` <span class="pill badge-exp">expired ${Math.abs(d)}d</span>`;
  if(d<=settingNear) return ` <span class="pill badge-warn">${d}d</span>`;
  return ` <span class="pill badge-ok">${d}d</span>`;
}

function renderNearExpiry(){
  const days = +$("#nearDays").value;
  const tbody = $("#nearGrid tbody"); tbody.innerHTML = "";
  const list = customers
    .map(c=> ({ c, plan: c.currentPlan||{} }))
    .filter(x => x.plan.expiryDate)
    .map(x => ({...x, left: daysLeft(x.plan.expiryDate)}))
    .filter(x => x.left >= 0 && x.left <= days)
    .sort((a,b)=> a.left - b.left);
  $("#nearExpCount").textContent = `Near expiry: ${list.length}`;
  list.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.c.name||''}</td>
      <td>${x.c.phone||''}</td>
      <td>${x.plan.planName||''}</td>
      <td>${x.plan.expiryDate||''}</td>
      <td>${x.left}d</td>
      <td><button class="btn ok" data-renew="${x.c.id}">Renew</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("[data-renew]").forEach(btn=>{
    btn.onclick = ()=> openRenewModal(btn.getAttribute('data-renew'));
  });
}

function renderKPIs(){
  let turnover=0, expense=0, profit=0;
  renewals.forEach(r=>{
    const f = calcFigures({
      cost:r.cost, wholesale:r.wholesale,
      stbIncluded:r.stbIncluded, stbCost:r.stbCost, stbWholesale:r.stbWholesale
    });
    turnover+=f.turnover; expense+=f.expense; profit+=f.profit;
  });
  $("#kpiTurnover").textContent = fmt(turnover);
  $("#kpiExpense").textContent  = fmt(expense);
  $("#kpiProfit").textContent   = fmt(profit);
}

/* =========================
   Customers: Add/Edit
   ========================= */
const custModal = $("#modalCustomer");
const custTitle = $("#custModalTitle");
$("#xCust").onclick = ()=>{ editCustomerId = null; custModal.classList.remove('open'); };
$("#c_stb").addEventListener('change', ()=>{
  $("#stbBox").classList.toggle('hidden', $("#c_stb").value!=='yes');
  previewTotals();
});
["#c_cost","#c_wholesale","#c_stbCost","#c_stbWholesale","#c_stb","#c_plan"].forEach(sel=>{
  $(sel).addEventListener('input', previewTotals);
});
$("#c_start").addEventListener('change', ()=>{
  const pid = $("#c_plan").value;
  const dur = plans[pid]?.duration_months ?? 0;
  $("#c_expiry").value = addMonthsISO($("#c_start").value, dur);
});

// robust Save button handler
const saveBtn = document.getElementById('btnSaveCustomer');
saveBtn.addEventListener('click', async (e) => {
  e.preventDefault(); e.stopPropagation();
  if (saveBtn.dataset.busy === '1') return;
  saveBtn.dataset.busy = '1';
  const old = saveBtn.textContent;
  saveBtn.textContent = 'Savingâ€¦';
  saveBtn.disabled = true;
  try { await saveCustomerFromModal(); }
  catch (err) { console.error('[save] error:', err); alert(err?.code ? `${err.code} â€” ${err.message}` : (err?.message||'Failed to save')); }
  finally { saveBtn.disabled = false; saveBtn.textContent = old; saveBtn.dataset.busy = '0'; }
});

let editCustomerId = null;

function refreshPlanSelects(){
  const selList = [$("#c_plan"), $("#r_plan")];
  selList.forEach(sel=>{
    if(!sel) return;
    const curr = sel.value;
    sel.innerHTML = "";
    const ids = Object.keys(plans).sort();
    ids.forEach(id=>{
      const p = plans[id];
      const opt = document.createElement('option');
      opt.value=id; opt.textContent=`${p.name} (${p.duration_months} mo)`;
      sel.appendChild(opt);
    });
    if(curr && plans[curr]) sel.value = curr;
  });
}

function previewTotals(){
  const stbIncluded = $("#c_stb").value;
  const f = calcFigures({
    cost: $("#c_cost").value,
    wholesale: $("#c_wholesale").value,
    stbIncluded,
    stbCost: $("#c_stbCost").value,
    stbWholesale: $("#c_stbWholesale").value
  });
  $("#c_preview").textContent = `Turnover: ${fmt(f.turnover)}, Expense: ${fmt(f.expense)}, Profit: ${fmt(f.profit)}`;
}

function openCustomerModal(id){
  editCustomerId = id || null;
  custTitle.textContent = id ? "Edit Customer" : "Add Customer";
  $("#c_name").value = "";
  $("#c_phone").value = "";
  $("#c_email").value = "";
  $("#c_userId").value = "";
  $("#c_mac").value = "";
  $("#c_cost").value = "";
  $("#c_wholesale").value = "";
  $("#c_stb").value = "no";
  $("#c_stbCost").value = "";
  $("#c_stbWholesale").value = "";
  $("#c_start").value = todayISO();
  $("#c_expiry").value = "";
  $("#c_paid").value = "yes";
  $("#stbBox").classList.add('hidden');
  refreshPlanSelects();
  if(id){
    const c = customers.find(x=>x.id===id);
    if(c){
      $("#c_name").value = c.name||"";
      $("#c_phone").value = c.phone||"";
      $("#c_email").value = c.email||"";
      $("#c_userId").value = c.userId||"";
      $("#c_mac").value = c.mac||"";
      if(c.currentPlan){
        $("#c_plan").value = c.currentPlan.planId||"";
        $("#c_cost").value = c.currentPlan.cost||"";
        $("#c_wholesale").value = c.currentPlan.wholesale||"";
        $("#c_stb").value = c.currentPlan.stbIncluded||"no";
        $("#c_stbCost").value = c.currentPlan.stbCost||"";
        $("#c_stbWholesale").value = c.currentPlan.stbWholesale||"";
        $("#c_start").value = c.currentPlan.startDate||todayISO();
        $("#c_expiry").value = c.currentPlan.expiryDate||"";
        $("#c_paid").value = c.currentPlan.paymentReceived||"yes";
        $("#stbBox").classList.toggle('hidden', c.currentPlan.stbIncluded!=='yes');
      }
    }
  }
  previewTotals();
  custModal.classList.add('open');
}

async function saveCustomerFromModal(){
  const planId = $("#c_plan").value;
  const payload = {
    name: $("#c_name").value.trim(),
    phone: $("#c_phone").value.trim(),
    email: $("#c_email").value.trim(),
    userId: $("#c_userId").value.trim(),
    mac: $("#c_mac").value.trim(),
    originalStartDate: editCustomerId
      ? (customers.find(x=>x.id===editCustomerId)?.originalStartDate || $("#c_start").value)
      : $("#c_start").value,
    currentPlan: {
      planId,
      planName: plans[planId]?.name || "",
      durationMonths: plans[planId]?.duration_months || 0,
      cost: parseFloat($("#c_cost").value)||0,
      wholesale: parseFloat($("#c_wholesale").value)||0,
      stbIncluded: $("#c_stb").value,
      stbCost: parseFloat($("#c_stbCost").value)||0,
      stbWholesale: parseFloat($("#c_stbWholesale").value)||0,
      startDate: $("#c_start").value,
      expiryDate: $("#c_expiry").value || addMonthsISO($("#c_start").value, plans[planId]?.duration_months||0),
      paymentReceived: $("#c_paid").value
    }
  };

  const cid = await saveCustomer(payload, editCustomerId);
  // If new customer, also create initial renewal record
  if(!editCustomerId){
    await addRenewal(cid, {
      customerId: cid, customerName: payload.name,
      planId: payload.currentPlan.planId, planName: payload.currentPlan.planName, durationMonths: payload.currentPlan.durationMonths,
      cost: payload.currentPlan.cost, wholesale: payload.currentPlan.wholesale,
      stbIncluded: payload.currentPlan.stbIncluded, stbCost: payload.currentPlan.stbCost, stbWholesale: payload.currentPlan.stbWholesale,
      startDate: payload.currentPlan.startDate, expiryDate: payload.currentPlan.expiryDate,
      paymentReceived: payload.currentPlan.paymentReceived
    });
  }
  custModal.classList.remove('open');
  await loadCustomers();
  await loadRenewals();
  renderAll();
}

/* =========================
   View helper
   ========================= */
function viewCustomer(id){
  const c = customers.find(x=>x.id===id);
  if(!c){ alert("Customer not found"); return; }
  const cp = c.currentPlan||{};
  const figs = calcFigures({
    cost:cp.cost, wholesale:cp.wholesale,
    stbIncluded:cp.stbIncluded, stbCost:cp.stbCost, stbWholesale:cp.stbWholesale
  });
  alert(
`Customer: ${c.name}
Phone: ${c.phone||'-'}  Email: ${c.email||'-'}
User ID: ${c.userId||'-'}  MAC: ${c.mac||'-'}

Original Start: ${c.originalStartDate||'-'}
Current Plan: ${cp.planName||'-'} (${cp.durationMonths||0} mo)
This Plan Start: ${cp.startDate||'-'}  Expiry: ${cp.expiryDate||'-'}

This Plan:
  Turnover: ${fmt(figs.turnover)}
  Expense:  ${fmt(figs.expense)}
  Profit:   ${fmt(figs.profit)}

Tip: Use "Reports" tab for totals across all renewals.`)
}

/* =========================
   Renewals (modal + confirm + invoice)
   ========================= */
const renewModal = $("#modalRenew");
$("#xRenew").onclick = ()=> renewModal.classList.remove('open');
$("#r_stb").addEventListener('change', ()=>{
  $("#r_stbBox").classList.toggle('hidden', $("#r_stb").value!=='yes');
});
let renewCustomerId = null;

function openRenewModal(id){
  renewCustomerId = id;
  const c = customers.find(x=>x.id===id);
  $("#renewTitle").textContent = `Renew: ${c?.name||id}`;
  refreshPlanSelects();
  const cp = c?.currentPlan||{};
  $("#r_plan").value = cp.planId||Object.keys(plans)[0]||"";
  const p = plans[$("#r_plan").value]||{};
  $("#r_cost").value = cp.cost||p.retail_price||"";
  $("#r_wholesale").value = cp.wholesale||p.wholesale_cost||"";
  $("#r_stb").value = "no"; $("#r_stbBox").classList.add('hidden');
  $("#r_stbCost").value = ""; $("#r_stbWholesale").value="";
  const defStart = cp.expiryDate ? addMonthsISO(cp.expiryDate, 0) : todayISO();
  $("#r_start").value = defStart;
  $("#r_expiry").value = addMonthsISO(defStart, p.duration_months||0);
  $("#r_paid").value = "yes";
  $("#r_plan").onchange = ()=>{
    const p2 = plans[$("#r_plan").value]||{};
    $("#r_expiry").value = addMonthsISO($("#r_start").value, p2.duration_months||0);
  };
  $("#r_start").onchange = ()=>{
    const p2 = plans[$("#r_plan").value]||{};
    $("#r_expiry").value = addMonthsISO($("#r_start").value, p2.duration_months||0);
  };
  renewModal.classList.add('open');
}

$("#btnDoRenew").onclick = async ()=>{
  const c = customers.find(x=>x.id===renewCustomerId);
  if(!c){ alert("Missing customer"); return; }
  const planId = $("#r_plan").value;
  const p = plans[planId]||{};
  const planName = p.name||'Custom';
  const durationMonths = +p.duration_months||0;
  const start = $("#r_start").value;
  const expiry= $("#r_expiry").value || addMonthsISO(start, durationMonths);
  const ren = {
    customerId: String(renewCustomerId),
    customerName: c.name||'',
    planId, planName, durationMonths,
    cost:+$("#r_cost").value||0,
    wholesale:+$("#r_wholesale").value||0,
    stbIncluded:$("#r_stb").value,
    stbCost:+$("#r_stbCost").value||0,
    stbWholesale:+$("#r_stbWholesale").value||0,
    startDate:start, expiryDate:expiry,
    paymentReceived: $("#r_paid").value
  };
  await addRenewal(String(renewCustomerId), ren);
  await setCustomerCurrentPlan(String(renewCustomerId), ren);
  renewModal.classList.remove('open');
  await loadCustomers();
  await loadRenewals();
  renderAll();
  runReport();
  // If you want auto-download invoice on renew, uncomment:
  // generateInvoice({ customer: c, record: ren, type: "Renewal" });
};

/* =========================
   Reports (filter + render + CSV)
   ========================= */
function onRepTypeChange(){
  const t = $("#repType").value;
  $("#repMonthCol").classList.toggle('hidden', t!=="monthly");
  $("#repYearCol").classList.toggle('hidden', t==="monthly" ? true : (t!=="yearly"));
  $("#repFromCol").classList.toggle('hidden', t!=="custom");
  $("#repToCol").classList.toggle('hidden', t!=="custom");
  if(t==="monthly"){ $("#repYearCol").classList.add('hidden'); }
}

function filterRenewalsByPeriod(){
  const t = $("#repType").value;
  let from, to;
  if (t === "monthly") {
    let ym = $("#repMonth").value || new Date().toISOString().slice(0,7);
    $("#repMonth").value = ym;
    from = ym + "-01";
    const [y, m] = ym.split("-").map(Number);
    const last = new Date(y, m, 0).getDate();
    to = ym + "-" + String(last).padStart(2, "0");
  } else if (t === "yearly") {
    const y = +$("#repYear").value;
    if (!y) return {arr: [], from: undefined, to: undefined};
    from = y + "-01-01";
    to   = y + "-12-31";
  } else {
    from = $("#repFrom").value;
    to   = $("#repTo").value;
    if (!from || !to) return {arr: [], from: undefined, to: undefined};
  }
  const arr = renewals.filter(r => r.startDate >= from && r.startDate <= to);
  return {arr, from, to};
}

function runReport(){
  const out = filterRenewalsByPeriod();
  if(!out || !out.arr){ alert("Select a valid period."); return; }
  const rows = out.arr.sort((a,b)=> a.startDate.localeCompare(b.startDate));
  const tbody = $("#repGrid tbody"); tbody.innerHTML="";
  let T=0,E=0,P=0;

  rows.forEach((r)=>{
    const f = calcFigures({
      cost:r.cost, wholesale:r.wholesale,
      stbIncluded:r.stbIncluded, stbCost:r.stbCost, stbWholesale:r.stbWholesale
    });
    T+=f.turnover; E+=f.expense; P+=f.profit;

    const tr = document.createElement('tr');
    const customer = customers.find(c => String(c.id) === String(r.customerId)) || { name: r.customerName||r.customerId };

    tr.innerHTML = `
      <td>${r.startDate}</td>
      <td>${customer.name}</td>
      <td>${r.planName||r.planId} (${r.durationMonths||0}mo)</td>
      <td>${f.turnover.toFixed(2)}</td>
      <td>${f.expense.toFixed(2)}</td>
      <td>${f.profit.toFixed(2)}</td>
      <td>${r.paymentReceived==='yes'?'Yes':'No'}</td>
      <td></td>
    `;

    // Add invoice button for this renewal row
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.type = 'button';
    btn.textContent = 'Invoice';
    btn.onclick = () => generateInvoice({ customer, record: r, type: "Renewal" });
    tr.lastElementChild.appendChild(btn);

    tbody.appendChild(tr);
  });

  $("#repTurnover").textContent = fmt(T);
  $("#repExpense").textContent  = fmt(E);
  $("#repProfit").textContent   = fmt(P);
}

function exportCSV(){
  const rows = [["Date","Customer","Plan","Turnover","Expense","Profit","Paid"]];
  document.querySelectorAll("#repGrid tbody tr").forEach(tr=>{
    const cols = [...tr.children].slice(0,7).map(td => td.textContent);
    rows.push(cols);
  });
  const csvStr = "\uFEFF" + rows
    .map(r => r.map(x => `"${String(x).replaceAll('"','""')}"`).join(","))
    .join("\n");
  const blob = new Blob([csvStr], { type: "text/csv;charset=utf-8;" });
  const canDownloadAttr = "download" in HTMLAnchorElement.prototype;
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (canDownloadAttr && !isIOS) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "report.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } else {
    const dataUrl = "data:text/csv;charset=utf-8," + encodeURIComponent(csvStr);
    window.open(dataUrl, "_blank");
  }
}

/* =========================
   Plans modal & seeding
   ========================= */
const planModal = $("#modalPlan");
$("#xPlan")?.addEventListener('click', ()=> planModal.classList.remove('open'));
function openPlanModal(p=null){
  $("#planTitle").textContent = p? "Edit Plan":"Add Plan";
  $("#p_id").value = p?.id||"";
  $("#p_name").value = p?.name||"";
  $("#p_months").value = p?.duration_months||1;
  $("#p_retail").value = p?.retail_price||"";
  $("#p_wholesale").value = p?.wholesale_cost||"";
  $("#p_desc").value = p?.description||"";
  planModal.classList.add('open');
}
$("#btnSavePlan").onclick = async ()=>{
  const pid = $("#p_id").value.trim();
  if(!pid){ alert("Plan ID required"); return; }
  await savePlan({
    id: pid,
    name: $("#p_name").value.trim(),
    duration_months: +$("#p_months").value||0,
    retail_price: +$("#p_retail").value||0,
    wholesale_cost: +$("#p_wholesale").value||0,
    description: $("#p_desc").value.trim()
  });
  planModal.classList.remove('open');
};
async function seedPlans(){
  const samples = [
    {id:"PLN-1MO", name:"1 month", duration_months:1, retail_price:15, wholesale_cost:4.5, description:"Entry plan"},
    {id:"PLN-3MO", name:"3 months", duration_months:3, retail_price:35, wholesale_cost:13.5, description:"Most popular"},
    {id:"PLN-6MO", name:"6 months", duration_months:6, retail_price:60, wholesale_cost:25, description:"Value saver"}
  ];
  for(const p of samples){ await savePlan(p); }
  alert("Sample plans added.");
}
</script>

<!-- MODALS (placed last to keep HTML tidy) -->
<div id="modalCustomer" class="modal">
  <div class="body">
    <div class="head">
      <h3 id="custModalTitle">Add Customer</h3>
      <button class="btn ghost" id="xCust" type="button">âœ•</button>
    </div>
    <div class="row">
      <div class="col">
        <label>Name</label><input id="c_name">
        <label>Phone</label><input id="c_phone">
        <label>Email</label><input id="c_email" type="email">
        <label>User ID (internal)</label><input id="c_userId" placeholder="e.g., CUST-001">
        <label>MAC Address</label><input id="c_mac" placeholder="AA:BB:CC:DD:EE:FF">
      </div>
      <div class="col">
        <label>Plan</label>
        <select id="c_plan"></select>
        <div class="muted" style="margin-top:6px">You can override price/wholesale below.</div>
        <label>Plan Cost (retail)</label><input id="c_cost" type="number" step="0.01">
        <label>Wholesale Rate</label><input id="c_wholesale" type="number" step="0.01">
        <label>Includes STB?</label>
        <select id="c_stb"><option value="no" selected>No</option><option value="yes">Yes</option></select>
        <div id="stbBox" class="hidden">
          <label>STB Cost (retail)</label><input id="c_stbCost" type="number" step="0.01">
          <label>STB Wholesale</label><input id="c_stbWholesale" type="number" step="0.01">
        </div>
      </div>
      <div class="col">
        <label>Plan Start Date</label><input id="c_start" type="date">
        <label>Plan Expiry Date</label><input id="c_expiry" type="date">
        <label>Payment Received?</label>
        <select id="c_paid"><option value="yes" selected>Yes</option><option value="no">No</option></select>
        <div class="card" style="margin-top:10px">
          <div class="muted">Totals Preview</div>
          <div id="c_preview" class="muted">â€”</div>
        </div>
      </div>
    </div>
    <div class="foot">
      <button type="button" class="btn secondary" id="btnSaveCustomer">Save</button>
    </div>
  </div>
</div>

<div id="modalRenew" class="modal">
  <div class="body">
    <div class="head">
      <h3 id="renewTitle">Renew Plan</h3>
      <button class="btn ghost" id="xRenew" type="button">âœ•</button>
    </div>
    <div class="row">
      <div class="col">
        <label>Plan</label><select id="r_plan"></select>
        <label>Plan Cost</label><input id="r_cost" type="number" step="0.01">
        <label>Wholesale</label><input id="r_wholesale" type="number" step="0.01">
      </div>
      <div class="col">
        <label>Includes STB?</label>
        <select id="r_stb"><option value="no" selected>No</option><option value="yes">Yes</option></select>
        <div id="r_stbBox" class="hidden">
          <label>STB Cost</label><input id="r_stbCost" type="number" step="0.01">
          <label>STB Wholesale</label><input id="r_stbWholesale" type="number" step="0.01">
        </div>
        <label>Start Date</label><input id="r_start" type="date">
        <label>Expiry Date</label><input id="r_expiry" type="date">
        <label>Payment Received?</label>
        <select id="r_paid"><option value="yes" selected>Yes</option><option value="no">No</option></select>
      </div>
    </div>
    <div class="foot">
      <button id="btnDoRenew" class="btn ok" type="button">Confirm Renewal</button>
    </div>
  </div>
</div>

<div id="modalPlan" class="modal">
  <div class="body">
    <div class="head">
      <h3 id="planTitle">Add Plan</h3>
      <button class="btn ghost" id="xPlan" type="button">âœ•</button>
    </div>
    <div class="row">
      <div class="col">
        <label>Plan ID</label><input id="p_id" placeholder="PLN-1MO">
        <label>Name</label><input id="p_name" placeholder="1 month">
        <label>Duration (months)</label><input id="p_months" type="number" min="0" step="1" value="1">
      </div>
      <div class="col">
        <label>Retail Price</label><input id="p_retail" type="number" step="0.01">
        <label>Wholesale Cost</label><input id="p_wholesale" type="number" step="0.01">
        <label>Description</label><input id="p_desc" placeholder="Most popular">
      </div>
    </div>
    <div class="foot">
      <button id="btnSavePlan" class="btn secondary" type="button">Save Plan</button>
    </div>
  </div>
</div>

</body>
</html>