<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1" />
<title>net+TV â€” Admin</title>
<meta name="theme-color" content="#0b1020" />
<style>
  :root{
    --bg:#0b1020;--ink:#e9edff;--muted:#a9b5e6;--card:#121831;--line:#23305b;
    --g1:#6a11cb;--g2:#2575fc;--ok:#32d296;--warn:#f8b84a;--danger:#ef4444;--whats:#25D366;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  :root[data-theme="light"]{
    --bg:#ffffff;--ink:#0b1020;--muted:#36415f;--card:#ffffff;--line:#d9e0ff;
    --g1:#2575fc;--g2:#6a11cb;--ok:#15a37a;--warn:#e59f2a;--danger:#e11d48;--whats:#25D366;
    --shadow:0 10px 30px rgba(0,12,60,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  button{font:inherit;cursor:pointer}
  input,textarea,select{font:inherit}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:60;background:linear-gradient(180deg,rgba(11,16,32,.95),rgba(11,16,32,.7));backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:10px 16px}
  :root[data-theme="light"] .topbar{background:#ffffffcc;border-bottom:1px solid #d9e0ff}
  .trow{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .dot{width:12px;height:12px;border-radius:50%;background:conic-gradient(from 180deg,var(--g1),var(--g2))}
  .btitle{font-weight:900;letter-spacing:.3px}
  .rside{display:flex;align-items:center;gap:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);padding:8px 12px}
  .btn.pri{background:linear-gradient(135deg, rgba(106,17,203,.25), rgba(37,117,252,.25))}
  .btn.danger{border-color:#5b1d29;background:rgba(239,68,68,.12);color:#ffd7db}
  :root[data-theme="light"] .btn{background:#f2f6ff;border-color:#d9e0ff;color:#0b1020}
  :root[data-theme="light"] .btn.danger{background:#ffecec;color:#7a1622;border-color:#ffd0d7}

  /* Layout */
  .wrap{max-width:1180px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
  .tab{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);cursor:pointer}
  .tab.active{background:linear-gradient(135deg, rgba(106,17,203,.22), rgba(37,117,252,.22));font-weight:800}
  :root[data-theme="light"] .tab{background:#f6f8ff}
  .section{display:none}
  .section.active{display:block}

  /* Cards */
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .card{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
  :root[data-theme="light"] .card{background:#fff}
  .card h3{margin:0 0 8px}
  .kpi{font-size:28px;font-weight:900}
  .muted{color:var(--muted)}

  /* Tables */
  .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:rgba(0,0,0,.15);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);text-align:left;padding:10px}
  :root[data-theme="light"] thead th{background:#f6f9ff}
  tbody td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
  input.txt, textarea.txt, select.txt{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1430;color:#fff}
  :root[data-theme="light"] input.txt, :root[data-theme="light"] textarea.txt, :root[data-theme="light"] select.txt{background:#f6f8ff;color:#0b1020}
  .rowBtns{display:flex;gap:6px;flex-wrap:wrap}
  .small{font-size:12px}

  /* Footer */
  .foot{padding:20px 0;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <div class="topbar">
    <div class="trow">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="btitle">net+TV Admin</div>
          <div class="small muted">Edit homepage content, plans, boxes, banners, posters</div>
        </div>
      </div>
      <div class="rside">
        <button id="themeBtn" class="btn" title="Toggle theme">ðŸ’¡</button>
        <a class="btn" href="index.html" target="_blank">View Site â†—</a>
        <div id="shortcuts" class="btn">Shortcuts â–¾</div>
        <div id="userBox" class="small muted">Not signed in</div>
        <button id="authBtn" class="btn pri">Sign in with Google</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="dash">Dashboard</div>
      <div class="tab" data-tab="plans">Plans</div>
      <div class="tab" data-tab="boxes">Boxes</div>
      <div class="tab" data-tab="banners">Banners</div>
      <div class="tab" data-tab="posters">Posters</div>
      <div class="tab" data-tab="settings">Settings</div>
      <div class="tab" data-tab="links">Links</div>
    </div>

    <!-- Sections -->
    <section id="sec-dash" class="section active">
      <div class="cards" style="margin-bottom:12px">
        <div class="card"><h3>Unique Today</h3><div id="kpi-today" class="kpi">â€“</div><div class="small muted" id="kpi-today-key"></div></div>
        <div class="card"><h3>Unique Week</h3><div id="kpi-week" class="kpi">â€“</div><div class="small muted" id="kpi-week-key"></div></div>
        <div class="card"><h3>Unique Month</h3><div id="kpi-month" class="kpi">â€“</div><div class="small muted" id="kpi-month-key"></div></div>
        <div class="card"><h3>Unique Year</h3><div id="kpi-year" class="kpi">â€“</div><div class="small muted" id="kpi-year-key"></div></div>
        <div class="card"><h3>Lifetime</h3><div id="kpi-life" class="kpi">â€“</div></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="recalcBtn" class="btn pri">Recalculate</button>
        <button id="publishBtn" class="btn">Publish to site</button>
      </div>
      <p class="small muted">Publishing writes a public document at <code>stats/visitors</code> which the homepage reads.</p>
    </section>

    <section id="sec-plans" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 10px">
        <h3 style="margin:0">Plans</h3>
        <button id="addPlanBtn" class="btn pri">+ Add Plan</button>
      </div>
      <div class="tableWrap">
        <table id="plansTable">
          <thead>
            <tr>
              <th>Name</th><th>Price</th><th>Months</th><th>Benefit</th><th>Tag</th><th>Desc</th><th>Sort</th><th>Active</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="plansBody"></tbody>
        </table>
      </div>
    </section>

    <section id="sec-boxes" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 10px">
        <h3 style="margin:0">Boxes</h3>
        <button id="addBoxBtn" class="btn pri">+ Add Box</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Tier</th><th>Box Price</th><th>Images (comma URLs)</th><th>Desc</th><th>Combo (price|months|extra)</th><th>Sort</th><th>Active</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="boxesBody"></tbody>
        </table>
      </div>
    </section>

    <section id="sec-banners" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 10px">
        <h3 style="margin:0">Banners</h3>
        <button id="addBannerBtn" class="btn pri">+ Add Banner Set</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Images (comma URLs)</th><th>Sort</th><th>Active</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="bannersBody"></tbody>
        </table>
      </div>
      <p class="small muted">Tip: Use 1280x720 direct image URLs.</p>
    </section>

    <section id="sec-posters" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 10px">
        <h3 style="margin:0">Posters</h3>
        <button id="addPosterBtn" class="btn pri">+ Add Poster</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Image URL</th><th>Sort</th><th>Active</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="postersBody"></tbody>
        </table>
      </div>
    </section>

    <section id="sec-settings" class="section">
      <h3 style="margin:8px 0 12px">Homepage Settings</h3>
      <div class="cards">
        <div class="card">
          <label class="small muted">Hero Title</label>
          <input id="set-heroTitle" class="txt" placeholder="..." />
          <label class="small muted" style="margin-top:8px;display:block">Hero Subtitle</label>
          <input id="set-heroSubtitle" class="txt" placeholder="..." />
          <label class="small muted" style="margin-top:8px;display:block">Hero Subline</label>
          <input id="set-heroSubline" class="txt" placeholder="..." />
        </div>
        <div class="card">
          <label class="small muted">CTA Labels (4 lines)</label>
          <textarea id="set-ctaLabels" class="txt" rows="6" placeholder="Our Plans&#10;New Boxes&#10;Renew Plan&#10;Contact Support"></textarea>
        </div>
        <div class="card">
          <label class="small muted">Features Ticker (one per line)</label>
          <textarea id="set-features" class="txt" rows="6" placeholder="ðŸ‡¨ðŸ‡¦ Proudly Canadian&#10;Zero Latency Streams&#10;24/7 Support&#10;Multi-Device"></textarea>
        </div>
        <div class="card">
          <label class="small muted">WhatsApp Number (digits only)</label>
          <input id="set-whats" class="txt" placeholder="16476961656" />
          <label class="small muted" style="margin-top:8px;display:block">Default Theme</label>
          <select id="set-theme" class="txt"><option value="">Auto</option><option value="dark">Dark</option><option value="light">Light</option></select>
        </div>
      </div>
      <div style="margin-top:12px"><button id="saveSettings" class="btn pri">Save Settings</button></div>
    </section>

    <section id="sec-links" class="section">
      <div class="cards">
        <a class="card" href="https://beta.gpanel.me/login" target="_blank"><h3>Glo TV</h3><div class="muted small">beta.gpanel.me</div></a>
        <a class="card" href="https://bill.spicetv.cc/login" target="_blank"><h3>Spice4K</h3><div class="muted small">bill.spicetv.cc</div></a>
        <a class="card" href="https://fast4k.cc/login" target="_blank"><h3>Smart 4K</h3><div class="muted small">fast4k.cc</div></a>
        <a class="card" href="data.html" target="_blank"><h3>Users Data</h3><div class="muted small">data.html</div></a>
        <a class="card" href="https://postimages.org" target="_blank"><h3>Upload Images</h3><div class="muted small">postimages.org</div></a>
      </div>
    </section>

    <div class="foot">Â© <span id="year"></span> net+TV</div>
  </div>

  <!-- Minimal dropdown for shortcuts -->
  <div id="shortcutsMenu" style="display:none;position:fixed;right:16px;top:56px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;z-index:70">
    <a class="btn" href="https://beta.gpanel.me/login" target="_blank">Glo TV</a>
    <a class="btn" href="https://bill.spicetv.cc/login" target="_blank">Spice4K</a>
    <a class="btn" href="https://fast4k.cc/login" target="_blank">Smart 4K</a>
    <a class="btn" href="data.html" target="_blank">Users Data</a>
    <a class="btn" href="https://postimages.org" target="_blank">Upload Images</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, getDocs, getCountFromServer,
      addDoc, doc, setDoc, updateDoc, deleteDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // IMPORTANT: add this to your Firestore rules:
    // match /stats/{docId} { allow read: if true; allow write: if request.auth != null; }

    const firebaseConfig = {
      apiKey: "AIzaSyCboIOCfsY1Zvx-cyKPMbAMGYdg27rnP0Y",
      authDomain: "netplus-site-4ff04.firebaseapp.com",
      projectId: "netplus-site-4ff04",
      storageBucket: "netplus-site-4ff04.firebasestorage.app",
      messagingSenderId: "49095160110",
      appId: "1:49095160110:web:5431d5c9f8ca45c4d70abf",
      measurementId: "G-PYWFFDZ0RR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Theme toggle
    const themeBtn = document.getElementById('themeBtn');
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeBtn.addEventListener('click', ()=>{
      const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', now);
      localStorage.setItem('theme', now);
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('sec-'+t.dataset.tab).classList.add('active');
      });
    });

    // Shortcuts dropdown
    const shortcutBtn = document.getElementById('shortcuts');
    const shortcutsMenu = document.getElementById('shortcutsMenu');
    shortcutBtn.addEventListener('click', ()=>{
      shortcutsMenu.style.display = shortcutsMenu.style.display === 'none' ? 'block' : 'none';
    });
    document.addEventListener('click',(e)=>{
      if (!shortcutsMenu.contains(e.target) && e.target !== shortcutBtn) shortcutsMenu.style.display='none';
    }, true);

    // Auth
    const userBox = document.getElementById('userBox');
    const authBtn = document.getElementById('authBtn');
    const provider = new GoogleAuthProvider();
    onAuthStateChanged(auth, (user)=>{
      if (user){
        userBox.textContent = `${user.displayName || user.email}`;
        authBtn.textContent = "Sign out";
        authBtn.onclick = () => signOut(auth);
        enableAdmin();
      }else{
        userBox.textContent = "Not signed in";
        authBtn.textContent = "Sign in with Google";
        authBtn.onclick = ()=> signInWithPopup(auth, provider);
        disableAdmin();
      }
    });

    function guardAuth(){
      const u = auth.currentUser;
      if (!u){ alert('Please sign in.'); throw new Error('not-auth'); }
      return u;
    }

    // Dash utilities
    function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}${m}${dd}`; }
    function ym(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); return `${y}${m}`; }
    function yOnly(d){ return String(d.getFullYear()); }
    function isoWeek(d){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = (date.getUTCDay() || 7);
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
      return `${date.getUTCFullYear()}${String(weekNo).padStart(2,'0')}`;
    }

    async function recalcKPIs(){
      guardAuth();
      const now = new Date();
      const kD = ymd(now), kW = isoWeek(now), kM = ym(now), kY = yOnly(now);

      // Count using Firestore aggregation
      const cToday = (await getCountFromServer(query(collection(db,'analytics_visitors'), where('bucket','==','d'), where('key','==',kD)))).data().count || 0;
      const cWeek  = (await getCountFromServer(query(collection(db,'analytics_visitors'), where('bucket','==','w'), where('key','==',kW)))).data().count || 0;
      const cMonth = (await getCountFromServer(query(collection(db,'analytics_visitors'), where('bucket','==','m'), where('key','==',kM)))).data().count || 0;
      const cYear  = (await getCountFromServer(query(collection(db,'analytics_visitors'), where('bucket','==','y'), where('key','==',kY)))).data().count || 0;
      const cLife  = (await getCountFromServer(query(collection(db,'analytics_visitors'), where('bucket','==','u')))).data().count || 0;

      document.getElementById('kpi-today').textContent = cToday;
      document.getElementById('kpi-week').textContent  = cWeek;
      document.getElementById('kpi-month').textContent = cMonth;
      document.getElementById('kpi-year').textContent  = cYear;
      document.getElementById('kpi-life').textContent  = cLife;

      document.getElementById('kpi-today-key').textContent = kD;
      document.getElementById('kpi-week-key').textContent  = 'ISO ' + kW;
      document.getElementById('kpi-month-key').textContent = kM;
      document.getElementById('kpi-year-key').textContent  = kY;

      return {today:cToday, week:cWeek, month:cMonth, year:cYear, life:cLife};
    }

    document.getElementById('recalcBtn').addEventListener('click', recalcKPIs);
    document.getElementById('publishBtn').addEventListener('click', async ()=>{
      const u = guardAuth();
      const r = await recalcKPIs();
      await setDoc(doc(db,'stats','visitors'), {
        today: r.today, week: r.week, month: r.month, year: r.year, lifetime: r.life, updatedAt: serverTimestamp()
      });
      alert('Published to stats/visitors');
    });

    // Plans
    const plansBody = document.getElementById('plansBody');
    document.getElementById('addPlanBtn').addEventListener('click', async ()=>{
      guardAuth();
      const ref = await addDoc(collection(db,'plans'), { name:'New Plan', price:'CA$0', months:1, benefit:'', tag:'', desc:'', sort:0, active:true });
      await loadPlans();
      alert('Plan added: ' + ref.id);
    });
    async function loadPlans(){
      const snap = await getDocs(query(collection(db,'plans'), orderBy('sort','asc')));
      plansBody.innerHTML = '';
      snap.forEach(docu=>{
        const d = docu.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="txt" value="${esc(d.name)}" data-k="name"></td>
          <td><input class="txt" value="${esc(d.price||'')}" data-k="price"></td>
          <td><input class="txt" type="number" value="${esc(d.months||'')}" data-k="months"></td>
          <td><input class="txt" value="${esc(d.benefit||'')}" data-k="benefit"></td>
          <td><input class="txt" value="${esc(d.tag||'')}" data-k="tag"></td>
          <td><textarea class="txt small" rows="2" data-k="desc">${esc(d.desc||'')}</textarea></td>
          <td><input class="txt" type="number" value="${esc(d.sort||0)}" data-k="sort"></td>
          <td><select class="txt" data-k="active"><option value="true"${d.active!==false?' selected':''}>true</option><option value="false"${d.active===false?' selected':''}>false</option></select></td>
          <td class="rowBtns">
            <button class="btn small pri" data-act="save">Save</button>
            <button class="btn small danger" data-act="del">Delete</button>
          </td>`;
        tr.querySelectorAll('[data-act]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            guardAuth();
            if (b.dataset.act==='save'){
              const payload = collectRow(tr);
              await updateDoc(doc(db,'plans',docu.id), payload);
              b.textContent='Saved'; setTimeout(()=> b.textContent='Save', 1200);
            }else if (b.dataset.act==='del'){
              if (confirm('Delete this plan?')){ await deleteDoc(doc(db,'plans',docu.id)); tr.remove(); }
            }
          });
        });
        plansBody.appendChild(tr);
      });
    }

    // Boxes
    const boxesBody = document.getElementById('boxesBody');
    document.getElementById('addBoxBtn').addEventListener('click', async ()=>{
      guardAuth();
      const ref = await addDoc(collection(db,'boxes'), { name:'New Box', tier:'Basic Box', boxPrice:'CA$0', images:[], desc:'', combo:{price:'',planMonths:12,extra:'+1 month free'}, sort:0, active:true });
      await loadBoxes();
      alert('Box added: ' + ref.id);
    });
    async function loadBoxes(){
      const snap = await getDocs(query(collection(db,'boxes'), orderBy('sort','asc')));
      boxesBody.innerHTML = '';
      snap.forEach(docu=>{
        const d = docu.data();
        const images = Array.isArray(d.images)? d.images.join(', ') : '';
        const combo = d.combo ? [d.combo.price||'', d.combo.planMonths||'', d.combo.extra||''].join('|') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="txt" value="${esc(d.name||'')}" data-k="name"></td>
          <td><input class="txt" value="${esc(d.tier||'')}" data-k="tier" placeholder="Basic Box / Good Box"></td>
          <td><input class="txt" value="${esc(d.boxPrice||'')}" data-k="boxPrice"></td>
          <td><textarea class="txt small" rows="2" data-k="images" placeholder="url1, url2, url3">${esc(images)}</textarea></td>
          <td><textarea class="txt small" rows="2" data-k="desc">${esc(d.desc||'')}</textarea></td>
          <td><input class="txt" value="${esc(combo)}" data-k="combo" placeholder="price|months|extra"></td>
          <td><input class="txt" type="number" value="${esc(d.sort||0)}" data-k="sort"></td>
          <td><select class="txt" data-k="active"><option value="true"${d.active!==false?' selected':''}>true</option><option value="false"${d.active===false?' selected':''}>false</option></select></td>
          <td class="rowBtns">
            <button class="btn small pri" data-act="save">Save</button>
            <button class="btn small danger" data-act="del">Delete</button>
          </td>`;
        tr.querySelectorAll('[data-act]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            guardAuth();
            if (b.dataset.act==='save'){
              const payload = collectRow(tr, true);
              await updateDoc(doc(db,'boxes',docu.id), payload);
              b.textContent='Saved'; setTimeout(()=> b.textContent='Save', 1200);
            }else if (b.dataset.act==='del'){
              if (confirm('Delete this box?')){ await deleteDoc(doc(db,'boxes',docu.id)); tr.remove(); }
            }
          });
        });
        boxesBody.appendChild(tr);
      });
    }

    // Banners
    const bannersBody = document.getElementById('bannersBody');
    document.getElementById('addBannerBtn').addEventListener('click', async ()=>{
      guardAuth();
      const ref = await addDoc(collection(db,'banners'), { images:[], sort:0, active:true });
      await loadBanners();
      alert('Banner set added: ' + ref.id);
    });
    async function loadBanners(){
      const snap = await getDocs(query(collection(db,'banners'), orderBy('sort','asc')));
      bannersBody.innerHTML = '';
      snap.forEach(docu=>{
        const d = docu.data();
        const images = Array.isArray(d.images)? d.images.join(', ') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><textarea class="txt small" rows="2" data-k="images" placeholder="url1, url2, url3">${esc(images)}</textarea></td>
          <td><input class="txt" type="number" value="${esc(d.sort||0)}" data-k="sort"></td>
          <td><select class="txt" data-k="active"><option value="true"${d.active!==false?' selected':''}>true</option><option value="false"${d.active===false?' selected':''}>false</option></select></td>
          <td class="rowBtns">
            <button class="btn small pri" data-act="save">Save</button>
            <button class="btn small danger" data-act="del">Delete</button>
          </td>`;
        tr.querySelectorAll('[data-act]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            guardAuth();
            if (b.dataset.act==='save'){
              const payload = collectRow(tr, true);
              await updateDoc(doc(db,'banners',docu.id), payload);
              b.textContent='Saved'; setTimeout(()=> b.textContent='Save', 1200);
            }else if (b.dataset.act==='del'){
              if (confirm('Delete this banner set?')){ await deleteDoc(doc(db,'banners',docu.id)); tr.remove(); }
            }
          });
        });
        bannersBody.appendChild(tr);
      });
    }

    // Posters
    const postersBody = document.getElementById('postersBody');
    document.getElementById('addPosterBtn').addEventListener('click', async ()=>{
      guardAuth();
      const ref = await addDoc(collection(db,'posters'), { image:'', sort:0, active:true });
      await loadPosters();
      alert('Poster added: ' + ref.id);
    });
    async function loadPosters(){
      const snap = await getDocs(query(collection(db,'posters'), orderBy('sort','asc')));
      postersBody.innerHTML = '';
      snap.forEach(docu=>{
        const d = docu.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="txt" value="${esc(d.image||'')}" data-k="image"></td>
          <td><input class="txt" type="number" value="${esc(d.sort||0)}" data-k="sort"></td>
          <td><select class="txt" data-k="active"><option value="true"${d.active!==false?' selected':''}>true</option><option value="false"${d.active===false?' selected':''}>false</option></select></td>
          <td class="rowBtns">
            <button class="btn small pri" data-act="save">Save</button>
            <button class="btn small danger" data-act="del">Delete</button>
          </td>`;
        tr.querySelectorAll('[data-act]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            guardAuth();
            if (b.dataset.act==='save'){
              const payload = collectRow(tr);
              await updateDoc(doc(db,'posters',docu.id), payload);
              b.textContent='Saved'; setTimeout(()=> b.textContent='Save', 1200);
            }else if (b.dataset.act==='del'){
              if (confirm('Delete this poster?')){ await deleteDoc(doc(db,'posters',docu.id)); tr.remove(); }
            }
          });
        });
        postersBody.appendChild(tr);
      });
    }

    // Settings
    async function loadSettings(){
      const sDoc = await getDoc(doc(db,'settings','main'));
      const s = sDoc.exists() ? sDoc.data() : {};
      byId('set-heroTitle').value = s.heroTitle || '';
      byId('set-heroSubtitle').value = s.heroSubtitle || '';
      byId('set-heroSubline').value = s.heroSubline || '';
      byId('set-whats').value = s.whatsappNumber || '';
      byId('set-theme').value = s.themeDefault || '';
      byId('set-ctaLabels').value = Array.isArray(s.ctaLabels)? s.ctaLabels.join('\n') : 'Our Plans\nNew Boxes\nRenew Plan\nContact Support';
      byId('set-features').value = Array.isArray(s.features)? s.features.join('\n') : 'ðŸ‡¨ðŸ‡¦ Proudly Canadian\nZero Latency Streams\n24/7 Support\nMulti-Device';
    }
    document.getElementById('saveSettings').addEventListener('click', async ()=>{
      guardAuth();
      const payload = {
        heroTitle: byId('set-heroTitle').value.trim(),
        heroSubtitle: byId('set-heroSubtitle').value.trim(),
        heroSubline: byId('set-heroSubline').value.trim(),
        whatsappNumber: byId('set-whats').value.trim(),
        themeDefault: byId('set-theme').value || null,
        ctaLabels: byId('set-ctaLabels').value.split('\n').map(s=>s.trim()).filter(Boolean),
        features: byId('set-features').value.split('\n').map(s=>s.trim()).filter(Boolean),
        updatedAt: serverTimestamp()
      };
      await setDoc(doc(db,'settings','main'), payload, {merge:true});
      alert('Settings saved');
    });

    // Helpers
    function byId(id){ return document.getElementById(id); }
    function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function collectRow(tr, parseLists=false){
      const o = {};
      tr.querySelectorAll('[data-k]').forEach(el=>{
        let v = el.value;
        if (el.type === 'number') v = Number(v);
        if (el.tagName === 'SELECT' && (el.dataset.k==='active')) v = (el.value === 'true');
        o[el.dataset.k] = v;
      });
      if (parseLists){
        if (o.images) o.images = o.images.split(',').map(s=>s.trim()).filter(Boolean);
        if (o.combo){
          const [price='', planMonths='', extra=''] = String(o.combo).split('|');
          o.combo = { price:price.trim(), planMonths: Number(planMonths||12), extra: extra.trim() };
        }
      }
      return o;
    }

    function disableAdmin(){
      // lock down UI views until signed in
      document.querySelectorAll('.section').forEach(s=> s.style.pointerEvents='none');
    }
    function enableAdmin(){
      document.querySelectorAll('.section').forEach(s=> s.style.pointerEvents='auto');
      // initial loads
      recalcKPIs().catch(()=>{});
      loadPlans().catch(()=>{});
      loadBoxes().catch(()=>{});
      loadBanners().catch(()=>{});
      loadPosters().catch(()=>{});
      loadSettings().catch(()=>{});
    }
  </script>
</body>
</html>
